{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}CHO.{{budget.id}} | {{ project.project_name }}
{% endblock %}
{% block extra_head %}

    <style>
            .main-container {
                background-repeat: repeat;
                background-position: center;
                backdrop-filter: blur(30px) grayscale(100%); /* Aplica desenfoque y escala de grises */
                background-color: #c7c7c780; /* Fondo semitransparente */
            }
            
                
            .header-blue {
                background-color: #004AAD;
                color: white;
            }
            .border-black {
                border: 1px solid #000;
            }
            .table-row {
                border-bottom: 1px solid #000;
            }
            .imgSello{
                position: absolute;
                opacity: 0.5;
                fill: none;
                left: 65%;
                width:250px;
                user-select: none;
                pointer-events: none;
                
            }
            .firma{
                display: absolute;
                width:100px;
                top:0px
                padding:0px;
                margin:0px;
            }
                         .logoView{
                 background-color: #1a4784;
                 width: 100%;
                 padding: 4px;
                 margin:8px
             }
             
             /* Estilos específicos para impresión */
             @media print {
                 #changeOrderPrintArea {
                     width: 8.5in !important;
                     max-width: 8.5in !important;
                     margin: 0 auto !important;
                     padding: 0.5in !important;
                 }
                 
                 .container {
                     max-width: 8.5in !important;
                     width: 8.5in !important;
                 }
             }
    </style>
{% endblock %}
{% block content %}
<div id="alert-container"></div>

<!-- Agregar id al contenedor principal para impresión -->
<div class="d-flex flex-column justify-content-center main-container p-0 m-0">
    <input type="hidden" id="csrf-token" data-csrf="{{ csrf_token }}" data-typeInv='MDCP'>
    

    <h1 class='fs-5 bg-white border border-4 border-primary fw-bold text-primary p-2 m-2 rounded-4 w-50 d-flex flex-row justify-content-between align-items-center'>CHO - ID{{project.id}} {{project.project_name}}
        <div>
            <button id="saveButton" class="btn btn-primary rounded-2" onclick="saveInvoice()">
            <i class="bi bi-floppy text-light"></i> Save
            </button>
            <button id="printButton" class="btn btn-success rounded-2" type="button">
                <i class="bi bi-printer text-light"></i> Print
            </button>
        </div>
    </h1>
         <div  class="container col-md-8 col-sm-12 my-4 p-1">
         <div class="p-4 w-100 bg-white" id="changeOrderPrintArea" style="max-width: 8.5in; margin: 0 auto;">
            <!-- Header Section -->
            <div class="d-flex flex-row justify-content-between mb-4">
                <div class="col-md-4">
                    <h2 class="mb-3 fw-bold">CHANGE ORDER</h2>
                    <div class="small">
                        <div>DADE: 20BS00539</div>
                        <div>BROWARD: 21-F-22501-R</div>
                        <div>786-747-4766</div>
                        <div>2498 W 3CT Hialeah FL 33010</div>
                        <div>{{user.email}}</div>
                    </div>
                </div>
                <div class="w-50 d-flex flex-row justify-content-center text-end bg position-relative">
                    <div class="w-50 d-flex flex-column align-items-center opacity-0">
                        <img src="{% static 'img/DaylenFirma.webp' %}" alt="DC FENCE Logo" class="firma position-relative">
                        <span class="text-center position-absolute nameSignature p-0 m-0" style="border-top: 2px solid black; display: inline-block; padding-top: 5px; bottom:0%">
                            Approved by Daylen Puerto
                        </span>
                    </div>
                    <img src="{% static 'img/LogoCompleteWhite.webp' %}" alt="DC FENCE Logo" class="logoView mx-4 w-50">
                </div>
            </div>
            
            <!-- Form Section -->
            <div class="border-black">
                <div class="row m-0">
                    <div class="col-6 border-black p-2">
                        <div class="fw-bold">To:</div>
                        <input id="To" type="text" class="form-control border-0 p-0 text-capitalize text-uppercase" value='{{budget.project.project_name}}'>
                    </div>
                    <div class="col-6 border-black p-2">
                        <div  class="fw-bold">Job Name:</div>
                        {% if project.customer.customer_type == "individual" %}
                            <a href="{% url 'detail_customer' project.customer.id %}" target='_blank'>
                                <span class="status title_{{ project.customer.customer_type }} fs-6">
                                    {{ project.customer.first_name }} {{ project.customer.last_name }} <i class="bi bi-person-arms-up"></i>
                                </span>
                            </a> 
                        {% else %}
                            <a href="{% url 'detail_customer' project.customer.id %}" target='_blank'>
                                <span class="status title_{{ project.customer.customer_type }} fs-6">{{ project.customer.company_name }} 
                                    <i class="bi bi-buildings-fill"></i> 
                                </span> 
                            </a>
                        {% endif %}
                    </div>
                </div>

                <div class="row m-0">
                    <div class="col-6 border-black p-2">
                        <div  class="fw-bold">Sub Contract No.</div>
                        <input id="SubContractNo" type="number" class="form-control border-0 p-0" value='0000'>

                    </div>
                    <div class="col-6 border-black p-2">
                        <div  class="fw-bold" >Job Location:</div>
                        <input id="JobLocation" type="text" class="form-control border-0 p-0" value='{{ project.address }} {{ project.city }} {{ project.state }} - {{ project.zip_code }}'>
                    </div>
                </div>

                <div class="row m-0">
                    <div class="col-6 border-black p-2">
                        <div  class="fw-bold">Purchase Order</div>
                        <input id="PurchaseOrder" type="number" class="form-control border-0 p-0" value='0000'>
                    </div>
                    <div class="col-6 border-black p-2">
                        <div  class="fw-bold">Existing Contract Amount:</div>
                        <input id="PurchaseOrder" type="text" class="form-control border-0 p-0" value='{{budget.id_related_total_value | currency_usd}}'>
                    </div>
                </div>

                <div class="row m-0">
                    <div class="col-6 border-black p-2">
                        <div  class="fw-bold">Phone:</div>
                        <input id="Phone" type="tel" class="form-control border-0 p-0" value='{{project.customer.phone}}'>
                    </div>
                    <div class="col-6 border-black p-2">
                        <div  class="fw-bold">Change Order No.</div>
                        <input id="ChangeOrderNo" type="number" class="form-control border-0 p-0" value='{{qtChangeOrder}}' readonly>
                    </div>
                </div>
            </div>

            <!-- Changes Table -->
            <div class="mt-3">
                <table class='w-100'>
                    <thead>
                      <tr class='bg-primary'>
                        <th class="col-9 border-black header-blue p-2">We hereby agree to make the following change(s)</th>
                        <th class="col-3 border-black header-blue p-2">Amount +/-</th>
                      </tr>
                    </thead>
                    <tbody id="table-body">
                      <!-- Fila predeterminada -->
                    <tr class="border-black">
                         <td class="border-black p-2">
                            <textarea class="form-control border-0 p-0 m-0" placeholder="Enter the change order description" rows="2" style="resize: none;" oninput="autoResize(this)"></textarea>
                           </td>
                           <td class="p-2 text-end d-flex flex-end">
                             $ 
                             <input type="number" class="form-control border-0 p-0 m-0 text-end totalRow" placeholder="Amount" value='{{ budget.total_change_order }}' readonly>
                         </td>
                       </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                        <td class="border-black p-2 text-end"><strong>Total Change Order</strong></td>
                        <td class="border-black py-2 px-0 text-end"><strong><span class="status fs-5 title_budget{% if budget.total_change_order < 0 %}Down{% else %}Up{% endif %}"><i class="bi bi-graph-{% if budget.total_change_order < 0 %}down{% else %}up{% endif %}-arrow fs-5"></i>{{ budget.total_change_order | currency_usd }}</span></strong></td>
                        </tr>
                    </tfoot>
                  </table>
                  
                  <!-- Botón para agregar nueva fila -->
                </div>                  
            <!-- Footer Section -->
            <div class="mt-3">
                <div class="text-center mb-3">
                    <strong>THIS CHANGE BECOMES PART OF AND IN CONFORMANCE WITH THE EXISTING CONTRACT.</strong>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <p>We Hereby agree to make the change(s) specified<br>
                        above at the price indicated per this Change Order.</p>
                    </div>
                    <div class="col-6">
                        <p>The prices and specification of this Change Order are satisfactory<br>
                        and are hereby accepted. All work is to be performed under the<br>
                        established terms and conditions specified in the original<br>
                        contract unless otherwise specified</p>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-6 text-center">
                        <div class="border-top border-dark pt-2">Authorized Contractor Signature</div>
                        <div class="border-top border-dark mt-4 pt-2">Date of Acceptance</div>
                    </div>
                    <div class="col-6 text-center">
                        <div class="border-top border-dark pt-2">Owner Signature</div>
                        <div class="border-top border-dark mt-4 pt-2">Date of Acceptance</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    const tableBody = document.getElementById('table-body');
    const saveButton = document.getElementById('saveButton');
    const maxTotal = {{budget.total_change_order}};


    // Función para verificar si el total de los campos "totalRow" supera el máximo
    function checkTotal() {
        
    }

         // Verificar el total al cargar la página
     checkTotal();
     
     // Auto-resize function for textareas
     function autoResize(textarea) {
         textarea.style.height = 'auto';
         textarea.style.height = textarea.scrollHeight + 'px';
     }
     
     // Apply auto-resize to all textareas on page load
     document.addEventListener('DOMContentLoaded', function() {
         const textareas = document.querySelectorAll('textarea');
         textareas.forEach(textarea => {
             autoResize(textarea);
         });
     });

    // --- Poblar campos si hay datos del backend ---
    document.addEventListener('DOMContentLoaded', function() {
        const changeOrderData = {{ change_order_data|default:'null'|safe }};
        console.log('changeOrderData:', changeOrderData);

        if (changeOrderData) {
            document.getElementById('SubContractNo').value = changeOrderData.sub_contract_no || '';
            document.getElementById('JobLocation').value = changeOrderData.job_location || '';
            document.getElementById('PurchaseOrder').value = changeOrderData.purchase_order || '';
            document.getElementById('Phone').value = changeOrderData.phone || '';
            document.getElementById('ChangeOrderNo').value = changeOrderData.change_order_no || '';
            // Si tienes un campo para notas, también aquí
            // document.getElementById('Notes').value = changeOrderData.notes || '';

            // Poblar la tabla de items
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            (changeOrderData.items || []).forEach(item => {
                const row = document.createElement('tr');
                                 row.innerHTML = `
                     <td class="border-black p-2">
                                                   <textarea class="form-control border-0 p-0 m-0" placeholder="Enter the change order description" rows="2" style="resize: none;" oninput="autoResize(this)">${item.description}</textarea>
                     </td>
                     <td class=" p-2 text-end d-flex flex-end">
                         $ <input type="number" class="form-control border-0 p-0 m-0 text-end totalRow" value="${parseFloat(item.amount)}" placeholder="Amount">
                     </td>
                 `;
                row.querySelector('.totalRow').addEventListener('input', checkTotal);
                row.classList.add('border-black');
                 tableBody.appendChild(row);
             });
             checkTotal();
             
             // Apply auto-resize to textareas after populating data
             setTimeout(() => {
                 const textareas = document.querySelectorAll('textarea');
                 textareas.forEach(textarea => {
                     autoResize(textarea);
                 });
             }, 100);
        }

        // --- Deshabilitar botones si el proyecto está completado o inactivo ---
        const projectStatus = '{{ project_status|default:"" }}'.toLowerCase();
        if (projectStatus === 'completed' || projectStatus === 'inactive') {
            document.querySelectorAll('button').forEach(btn => {
                // No deshabilitar el botón de imprimir ni el de guardar
                if (btn.id !== 'printButton' && btn.id !== 'saveButton') {
                    btn.disabled = true;
                    btn.classList.add('btn-secondary');
                    btn.classList.remove('btn-primary', 'btn-success', 'btn-danger');
                }
            });
        }
    });

    function showAlert(message, type) {
        const alertContainer = document.getElementById("alert-container");
        const alert = document.createElement("div");
        alert.classList.add("alert", `alert-${type}`, "alert-dismissible", "fade", "show");
        alert.role = "alert";
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        alertContainer.appendChild(alert);
        setTimeout(() => {
            alert.classList.remove("show");
            alert.classList.add("fade");
            alert.remove();
        }, 4000); 
        return alert;
    }

    // --- Guardar todos los campos relevantes ---
    function saveInvoice() {
        const csrfToken = document.getElementById('csrf-token').dataset.csrf;
        const rows = document.querySelectorAll('#table-body tr');
        let items = [];
                 rows.forEach(row => {
             const description = row.querySelector('textarea').value;
             const amount = parseFloat(row.querySelector('input[type="number"]').value) || 0;
             items.push({ description, amount });
         });
        const data = {
            sub_contract_no: document.getElementById('SubContractNo').value,
            job_location: document.getElementById('JobLocation').value,
            purchase_order: document.getElementById('PurchaseOrder').value,
            existing_contract_amount: parseFloat(document.getElementById('PurchaseOrder').value) || null, // Ajusta si tienes un campo separado
            phone: document.getElementById('Phone').value,
            change_order_no: document.getElementById('ChangeOrderNo').value,
            // notes: document.getElementById('Notes').value, // Si tienes campo de notas
            items: items
        };
        fetch("{% url 'view_changeOrder' project.id budget.id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                showAlert("Change Order saved successfully!", "success");
            } else {
                showAlert("Error saving Change Order: " + data.message, "danger");
            }
        })
        .catch(error => {
            showAlert("Error saving Change Order.", "danger");
        });
    }

                   document.getElementById('printButton').addEventListener('click', function() {
          const element = document.getElementById('changeOrderPrintArea');
          const opt = {
              margin:       0,
              filename:     'CHO - {{project.project_name}} - {{budget.id}}',
              html2canvas:  { scale: 2, useCORS: true, allowTaint: true },
              jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
          };
          html2pdf().set(opt).from(element).save();
      });

</script>

  
{% endblock %}
