{% extends "base.html" %}
{% load static %}
{% block title %}Access Restricted - {{ project.project_name }}{% endblock %}

{% block content %}
<div class="container d-flex flex-column justify-content-center my-4">
    <div class="row justify-content-center">
        <div class="col-md-10 my-auto">
            <div class="card border-warning">
                <div class="card-body bg-warning bg-opacity-10 my-auto">
                    <div class="row d-flex justify-content-center align-items-center flex-row">
                        <!-- Información del proyecto (lado izquierdo) -->
                        <div class="col-md-6 p-4">
                            <div class="card bg-light p-4">
                                <div class="text-center mb-3 d-flex justify-content-center flex-row gap-4">
                                    <i class="bi bi-shield-lock text-warning" style="font-size: 3rem;"></i>
                                    <h5 class="mt-2">Project Restricted</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Project:</strong> {{ project.project_name }}</li>
                                        <li class="mb-2"><strong>Customer:</strong> {{ project.customer.get_full_name }}</li>
                                        <li class="mb-2"><strong>Owner:</strong> {{ project.sales_advisor.get_full_name }}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Formulario de solicitud (lado derecho) -->
                        <div class="col-md-6">
                            {% if pending_request %}
                                <div class="text-center mb-3">
                                    <i class="bi bi-clock text-info" style="font-size: 3rem;"></i>
                                    <h5 class="mt-2">Request Pending</h5>
                                </div>
                                <div class="alert alert-info">
                                    <p class="mb-2">You have already sent a collaboration request for this project.</p>
                                    <small class="text-muted">
                                        Request sent on: {{ pending_request.date_created|date:"M d, Y H:i" }}
                                    </small>
                                    {% if pending_request.message %}
                                        <div class="mt-2 pt-2 border-top">
                                            <strong>Your message:</strong>
                                            <p class="mb-0">{{ pending_request.message }}</p>
                                        </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="text-center mb-3">
                                    <i class="bi bi-handshake text-success" style="font-size: 3rem;"></i>
                                    <h5 class="mt-2">Request Collaboration Access</h5>
                                </div>
                                <div class="card">
                                    <div class="card-body">
                                        <form id="collaborationRequestForm">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="collaborationMessage" class="form-label">
                                                    Message (Optional)
                                                </label>
                                                <textarea 
                                                    class="form-control" 
                                                    id="collaborationMessage" 
                                                    name="message" 
                                                    rows="4" 
                                                    placeholder="Explain why you want to collaborate on this project..."
                                                ></textarea>
                                                <div class="form-text">
                                                    This message will be sent to the project owner along with your request.
                                                </div>
                                            </div>

                                            <div class="d-grid gap-2">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-send me-2"></i>
                                                    Send Collaboration Request
                                                </button>
                                                <a href="{% url 'projects' %}" class="btn btn-outline-secondary">
                                                    <i class="bi bi-arrow-left me-2"></i>
                                                    Back to Projects
                                                </a>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar solicitud -->
<div class="modal fade" id="confirmRequestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Collaboration Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to send a collaboration request for this project?</p>
                <p class="text-muted small">
                    The project owner will be notified and can approve or reject your request.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRequestBtn">
                    <i class="bi bi-send me-2"></i>
                    Send Request
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('collaborationRequestForm');
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmRequestModal'));
    
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            confirmModal.show();
        });
    }
    
    document.getElementById('confirmRequestBtn').addEventListener('click', function() {
        const formData = new FormData(form);
        const message = formData.get('message');
        
        // Deshabilitar botón durante el envío
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
        
        fetch(`/projects/{{ project.id }}/send_collaboration_request/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showAlert(data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error sending collaboration request. Please try again.', 'danger');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-send me-2"></i>Send Request';
            confirmModal.hide();
        });
    });
});

function showAlert(message, type) {
    const alertContainer = document.createElement('div');
    alertContainer.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertContainer.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertContainer);
    
    setTimeout(() => {
        alertContainer.remove();
    }, 5000);
}
</script>
{% endblock %} 