{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block extra_head %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        #main-pdf{
            background-color: #e0e0e0;

        }
        section{
            background:white;
            box-shadow: 2px 0px 100px 10px #0000001e;
            max-width: 8.5in;
            width: 8.5in;
        }
        #main-container{
            background: white;
            padding: 30px 30px;
            page-break-inside: avoid;
            page-break-after: auto;
            page-break-before: auto;
            max-width: 8.5in;
            width: 8.5in;
        }
        
        .no-break, tr, .chart-container {
            page-break-inside: avoid;
        }
        .header-blue {
            background-color: #9b9c9c4d;
            color: #00265a;
            padding: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .logoView{
            background-color: #1a4784;
            width: 200px;
            padding: 4px;
            height: 140px;
        }
        .infoContainer{
            background-image: url("{% static 'img/logoPatron.png' %}");
            background-repeat: none;
            background-position: center;
            background-size: 480px 480px
        }
        .bgTrans{
            background-color:white;
            font-size: 12px
        }
        .cost-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .cost-table th,
        .cost-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .cost-table th {
            background-color: #1a4784;
            color: white;
            font-weight: bold;
        }
        .cost-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .cost-table tr:hover {
            background-color: #ddd;
        }
        .text-right {
            text-align: right;
        }
        .text-center {
            text-align: center;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
        }
        .summary-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
        }
        
        /* Estilos para edición de descripciones */
        .item-description {
            position: relative;
            cursor: pointer;
        }
        
        .item-description:hover .edit-btn {
            opacity: 1;
        }
        
        .edit-btn {
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }
        
        .edit-btn:hover {
            background: #0056b3;
        }
        
        .edit-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #007bff;
            border-radius: 3px;
            font-size: inherit;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 5px;
            cursor: pointer;
        }
        
        .save-btn:hover {
            background: #1e7e34;
        }
        
        .cancel-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 2px;
            cursor: pointer;
        }
        
        .cancel-btn:hover {
            background: #c82333;
        }
        
        .timeline-item {
            border-left: 3px solid #1a4784;
            padding-left: 15px;
            margin: 10px 0;
            position: relative;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 5px;
            width: 12px;
            height: 12px;
            background: #1a4784;
            border-radius: 50%;
        }
        
        .professional-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Estilos para el chart con fondo amarillo claro */
        .chart-container {
            background: linear-gradient(135deg, #55555518 0%, #9c9c9c25 100%);
            padding: 25px;
            margin-top: 0px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Estilos para las columnas del chart con opacidad */
        .chart-column {
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .chart-column:hover {
            opacity: 1;
        }
        
        /* Estilos para el análisis de costos */
        .cost-summary-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #dee2e6;
            height: 100%;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-item .label {
            font-weight: 500;
            color: #495057;
        }
        
        .summary-item .value {
            font-weight: 600;
            color: #212529;
        }
        
        .cost-analysis-section {
            margin-top: 30px;
            padding: 25px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .analysis-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 3px solid #1a4784;
        }
        
        .analysis-item h6 {
            margin-bottom: 8px;
            font-weight: 600;
            color: #212529;
        }
        
        .analysis-item p {
            margin-bottom: 0;
            line-height: 1.4;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .alert-light {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }
        
        .alert-heading {
            color: #495057;
            font-weight: 600;
        }
    </style>
{% endblock %}
{% block title %}Cost Breakdown{% endblock %}
{% block content %}
<div id='main-pdf' class='p-3 position-relative' data-project-id="{{ project.id }}" data-proposal-id="{{ proposal.id }}">
    <a href="{% url 'detail_project' project.id %}" class="bg-light px-4 py-1 rounded-4 border border-2 border-primary fs-5"><strong><i class="bi bi-back "></i> <span id="project-container" data-project-id="{{ project.id }}">{{project.id}} </span> - {{project.project_name}}</a>
    <!-- Botones flotantes en la esquina superior derecha -->
    <div class="position-fixed top-0 end-0 m-3 d-flex flex-row gap-2" style="z-index: 10;">
        <button id="downloadBtn" class="btn btn-light btn-sm border border-danger shadow-sm rounded-2" onclick="generatePDF()" title="Download PDF">
            <i class="bi bi-file-earmark-pdf-fill text-danger fs-4"></i>
        </button>
        <a href="{% url 'edit_budgetSimple' project_id=project.id budget_id=proposal.budget.id proposal_id=proposal.id %}" class="btn btn-light btn-sm border border-primary shadow-sm rounded-2" title="Edit Proposal">
            <i class="bi bi-pencil-square text-primary fs-4"></i>
        </a>
                <button id="emailBtn" class="btn btn-light btn-sm border border-success shadow-sm rounded-2" onclick="openEmailModal()" title="Send by Email">
            <i class="bi bi-envelope-fill text-success fs-4"></i>
        </button>
        <button id="overheadBtn" class="btn btn-light btn-sm border border-warning shadow-sm rounded-2" onclick="reduceOverhead()" title="Reduce Overhead">
            <i class="bi bi-percent text-warning fs-4"></i>
        </button>
    </div>
    <section id="invoice-form" class="col-md-9 mx-auto">
        <div class="container px-4 py-1 overflow-hidden select-none" id='main-container'>
            
            <!-- Cost Breakdown Header -->
            <div class="header-blue text-center">
                <h4 class="m-0 fw-bold">COST BREAKDOWN - {{proposal.project.project_name}}</h4>
            </div>
            <!-- Header with Logo -->
            <div class="row align-items-center pb-2 border-bottom border-2">
                <div class="d-flex flex-row flex-nowrap justify-content-between gap-2 infoContainer p-3 px-4">
                    <img src="{% static 'img/LogoCompleteWhite.webp' %}" alt="DC FENCE Logo" class="logoView rounded-2">
                    <div class='d-flex flex-row justify-content-between'>
                        <div class="d-flex flex-column justify-content-center align-items-center text-center bgTrans px-2">
                            <h6>Lic: 20BS00539/21-F22501-R <br> SBE-CON/SBE-G&S/LDB CAGE:8ZKA7 Duns:117970612</h6>
                            <a href="https://www.dcfence.org" target="_blank" class="text-decoration-none text-dark">
                            <p class="m-0"><i class="bi bi-globe"></i> www.dcfence.org</p>
                            </a>
                        </div>
                        <div class="d-flex flex-column ms-5 justify-content-center bgTrans p-1">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-telephone-fill bg-primary p-1 text-light me-1"></i>
                                <span>786-747-4766</span>
                            </div>
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-house-door-fill bg-primary p-1 text-light me-1"></i>
                                <span>2498 W Third CT,</span>
                            </div>
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-house-door-fill bg-primary p-1 text-light me-1"></i>
                                <span>Hialeah FL 33010</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-envelope-fill bg-primary p-1 text-light me-1"></i>
                                <a href="mailto:dcfence01@gmail.com" class="text-decoration-none text-dark">dcfence01@gmail.com</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Customer Information -->
            <div class="header-blue bg-opacity-25">Customer Information</div>
            <table class="table table-bordered">
                <tr>
                    <td><strong>Company/Project:</strong></td>
                    <td>{{ proposal.project_name }}</td>
                    <td><strong>Project Number:</strong></td>
                    <td>MDCPS-{{ proposal.date_created|date:'ymd' }}-{{proposal.project.id}}</td>
                </tr>
                <tr>
                    <td><strong>Customer:</strong></td>
                    <td>
                        {% if proposal.project.customer.customer_type == "individual" %}
                            {{ proposal.project.customer.first_name }} {{ proposal.project.customer.last_name }}
                        {% else %}
                            {{ proposal.project.customer.company_name }}
                        {% endif %}
                    </td>
                    <td><strong>Quote Date:</strong></td>
                    <td>{{ proposal.date_created|date:'m/d/Y' }}</td>
                </tr>
            </table>
            
            <!-- Contact Information -->
            <div class="header-blue">Contact Information</div>
            <table class="table table-bordered">
                <tr>
                    <td><strong>Name:</strong></td>
                    <td>
                        {% if proposal.project.customer.customer_type == "individual" %}
                            {{ proposal.project.customer.first_name }} {{ proposal.project.customer.last_name }}
                        {% else %}
                            {{ proposal.project.customer.company_name }}
                        {% endif %}
                    </td>
                    <td><strong>Phone:</strong></td>
                    <td>{{ proposal.project.customer.phone }}</td>
                </tr>
                <tr>
                    <td><strong>Address:</strong></td>
                    <td colspan="3">{{ proposal.project.customer.address }}, {{ proposal.project.customer.city }}, {{ proposal.project.customer.state }} {{ proposal.project.customer.zip_code }}</td>
                </tr>
                <tr>
                    <td><strong>Email:</strong></td>
                    <td colspan="3">{{ proposal.project.customer.email }}</td>
                </tr>
            </table>
            
            <div class="header-blue" style="margin-top: 30px;">Cost Breakdown Summary</div>
            <table class="cost-table professional-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Cost Code</th>
                        <th class="text-right">Cost Value</th>
                        <th class="text-right">%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category_name, category_items in categorized_data.items %}
                        {% if category_items %}
                        <tr>
                            <td class="fw-bold">
                                {% if category_name == 'profit' %}
                                    Overhead
                                {% else %}
                                    {{ category_name|title }}
                                {% endif %}
                            </td>
                            <td>
                                {{ category_description|get_item:category_name.lower|default:category_name|title }}
                            </td>
                            <td>CC-{{ forloop.counter|stringformat:"03d" }}</td>
                            <td class="text-left total-cost-category {{category_name}}" data-category-name="{{category_name}}" data-category-total-cost="{{ category_totals|get_item:category_name }}">{{ category_totals|get_item:category_name|floatformat:2|currency_usd }}</td>
                            <td class="text-right position-relative  {% if category_name != 'profit' %} total-percentage-category {% endif %} text-truncate"  style="max-width: 75px;" {% if category_name != 'profit' %}data-category-name="{{category_name}}" data-category-percentage-{{category_name}}="{{ category_percentage|get_item:category_name|floatformat:2 }}"{% endif %}>
                            {% if category_name == 'profit' %}
                                 <span class="total-percentage-category" id="percentage-profit" data-category-name="{{category_name}}" data-category-percentage-{{category_name}}="{{ category_percentage|get_item:category_name|floatformat:2 }}"  data-percentage="{{  category_percentage|get_item:category_name|floatformat:2 }}">{{  category_percentage|get_item:category_name|floatformat:2 }}%</span>
                                     <div class="position-absolute end-0 top-0 translate-x-middle d-flex flex-column gap-1">
                                         <button class="btn btn-success btn-sm p-0" onclick="increaseOverhead()" title="Aumentar overhead">
                                             <i class="bi bi-arrow-up" style="font-size: 0.6rem;"></i>
                                         </button>
                                         <button class="btn btn-danger btn-sm p-0" onclick="reduceOverhead()" title="Reducir overhead">
                                             <i class="bi bi-arrow-down" style="font-size: 0.6rem;"></i>
                                         </button>
                                     </div>
                                 {% else %}
                                     {{  category_percentage|get_item:category_name|floatformat:2 }}%
                                 {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                    <!-- Total Row -->
                    <tr class="table-dar fw-bold text-dark border-top-2 border-dark">
                        <td colspan="3"><strong>TOTAL</strong></td>
                        <td class="text-left" data-total-cost="{{ totals.total_cost }}" id="total-cost-by-category">{{ totals.total_cost|floatformat:2|currency_usd }}</td>
                        <td class="text-right">100%</td>
                    </tr>
                </tbody>
            </table>

            <!-- Detailed Category Tables -->
            
            <!-- Materials Section -->
            <div class="header-blue">Materials</div>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="table-dar">
                        <tr>
                            <th>#</th>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Cost</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody data-category-table="materials">
                        {% for item in categorized_data.materials %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td class="item-description" data-category="materials" data-original-name="{{ item.original_name }}" data-custom-name="{{ item.name }}">
                                {{ item.name }}
                                <button class="edit-btn" onclick="editItemDescription(this)">✏️</button>
                            </td>
                            <td class="quantity-cell">{{ item.content.quantity }}</td>
                            <td class="text-right">${{ item.content.unit_cost|floatformat:2 }}</td>
                            <td class="text-right cost-cell" data-materials-item-cost="{{ item.total }}">{{ item.total|floatformat:2|currency_usd }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No materials data available</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="4" class="text-end"><strong>Materials Subtotal:</strong></td>
                            <td class="text-right" data-materials-total-cost="{{ totals.materials }}">{{ totals.materials|floatformat:2|currency_usd }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Labor Section -->
            <div class="header-blue">Labor</div>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="table-dar">
                        <tr>
                            <th>#</th>
                            <th>Description</th>
                            <th>Days</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody data-category-table="labor">
                        {% for item in categorized_data.labor %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td class="item-description" data-category="labor" data-original-name="{{ item.original_name }}" data-custom-name="{{ item.name }}">
                                {{ item.name }}
                                <button class="edit-btn" onclick="editItemDescription(this)">✏️</button>
                            </td>
                            <td class="quantity-cell">{{ item.content.days }}</td>
                            <td class="text-right cost-cell" data-labor-item-cost="{{ item.total }}">{{ item.total|floatformat:2|currency_usd }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No labor data available</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="3" class="text-end"><strong>Labor Subtotal:</strong></td>
                            <td class="text-right" data-labor-total-cost="{{ totals.labor }}">{{ totals.labor|floatformat:2|currency_usd }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Contractors Section -->
            <div class="header-blue">Contractors</div>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="table-dar">
                        <tr>
                            <th>#</th>
                            <th>Description</th>
                            <th>Lead Time</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody data-category-table="contractors">
                        {% for item in categorized_data.contractors %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td class="item-description" data-category="contractors" data-original-name="{{ item.original_name }}" data-custom-name="{{ item.name }}">
                                {{ item.name }}
                                <button class="edit-btn" onclick="editItemDescription(this)">✏️</button>
                            </td>
                            <td>{{ item.content.lead_time }}</td>   
                            <td class="text-right cost-cell" data-contractors-item-cost="{{ item.total }}">{{ item.total|floatformat:2|currency_usd }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">No contractors data available</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="3" class="text-end"><strong>Contractors Subtotal:</strong></td>
                            <td class="text-right" data-contractors-total-cost="{{ totals.contractors }}">{{ totals.contractors|floatformat:2|currency_usd }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Utilities Section -->
            <div class="header-blue">Utilities</div>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="table-dar">
                        <tr>
                            <th>#</th>
                            <th>Description</th>
                            <th>Cost per Hole</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody data-category-table="utilities">
                        {% for item in categorized_data.utilities %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td class="item-description" data-category="utilities" data-original-name="{{ item.original_name }}" data-custom-name="{{ item.name }}">
                                {{ item.name }}
                                <button class="edit-btn" onclick="editItemDescription(this)">✏️</button>
                            </td>
                            <td class="text-right">${{ item.content.cost_per_hole|floatformat:2 }}</td>
                            <td class="text-right cost-cell" data-utilities-item-cost="{{ item.total }}">{{ item.total|floatformat:2|currency_usd }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">No utilities data available</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="3" class="text-end"><strong>Utilities Subtotal:</strong></td>
                            <td class="text-right" data-utilities-total-cost="{{ totals.utilities }}">{{ totals.utilities|floatformat:2|currency_usd }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Miscellaneous Section -->
            <div class="header-blue">Miscellaneous</div>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="table-dar">
                        <tr>
                            <th>#</th>
                            <th>Description</th>
                            <th>Lead Time</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody data-category-table="miscellaneous">
                        {% for item in categorized_data.miscellaneous %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td class="item-description" data-category="miscellaneous" data-original-name="{{ item.original_name }}" data-custom-name="{{ item.name }}">w
                                {{ item.name }}
                                <button class="edit-btn" onclick="editItemDescription(this)">✏️</button>
                            </td>
                            <td>{{ item.content.lead_time }}</td>
                            <td class="text-right cost-cell" data-miscellaneous-item-cost="{{ item.total }}">{{ item.total|floatformat:2|currency_usd }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">No miscellaneous data available</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="3" class="text-end"><strong>Miscellaneous Subtotal:</strong></td>
                            <td class="text-right" data-miscellaneous-total-cost="{{ totals.miscellaneous }}">{{ totals.miscellaneous|floatformat:2|currency_usd }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Deducts Section -->
            <div class="header-blue">Deducts</div>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="table-dar">
                        <tr>
                            <th>#</th>
                            <th>Description</th>
                            <th>Lead Time</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody data-category-table="deducts">
                        {% for item in categorized_data.deducts %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td class="item-description" data-category="deducts" data-original-name="{{ item.original_name }}" data-custom-name="{{ item.name }}">
                                {{ item.name }}
                                <button class="edit-btn" onclick="editItemDescription(this)">✏️</button>
                            </td>
                            <td>{{ item.content.lead_time }}</td>
                            <td class="text-right cost-cell" data-deducts-item-cost="{{ item.total }}">{{ item.total|floatformat:2|currency_usd }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">No deducts data available</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="3" class="text-end"><strong>Deducts Subtotal:</strong></td>
                            <td class="text-right" data-deducts-total-cost="{{ totals.deducts }}">{{ totals.deducts|floatformat:2|currency_usd }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Profit Section -->
            <div class="header-blue">Overhead</div>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead class="table-dar">
                        <tr>
                            <th>#</th>
                            <th>Description</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody data-category-table="profit">
                        {% for item in categorized_data.profit %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td class="item-description" data-category="profit" data-original-name="{{ item.original_name }}" data-custom-name="{{ item.name }}">
                                {{ item.name }}
                                <button class="edit-btn" onclick="editItemDescription(this)">✏️</button>
                            </td>
                            <td class="text-right cost-cell" data-profit-item-cost="{{ item.total }}">{{ item.total|floatformat:2|currency_usd }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted">No profit data available</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td colspan="2" class="text-end"><strong>Overhead Subtotal:</strong></td>
                            <td class="text-right" data-profit-total-cost="{{ totals.total_profit }}">{{ totals.total_profit|floatformat:2|currency_usd }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

             <!-- Margin Error Summary -->
             {% if totals.margin_error > 0 %}
             <div class="header-blue" style="margin-top: 30px;">F. Margin Error Summary</div>
             <div class="table-responsive">
                 <table class="table table-bordered table-sm">
                     <thead class="table-warning">
                         <tr>
                             <th>#</th>
                             <th>Description</th>
                             <th>Percentage</th>
                             <th class="text-right">Amount</th>
                         </tr>
                     </thead>
                     <tbody>
                         <tr>
                             <td><strong>1</strong></td>
                             <td>Margin Error</td>
                             <td class="text-center">5%</td>
                             <td class="text-right text-warning fw-bold" data-margin-error-total-cost="{{ totals.margin_error }}">{{ totals.margin_error|floatformat:2|currency_usd }}</td>
                         </tr>
                         <tr class="table-warning fw-bold">
                             <td colspan="3" class="text-end"><strong>Margin Error Total:</strong></td>
                             <td class="text-right" data-margin-error-total-cost="{{ totals.margin_error }}">{{ totals.margin_error|floatformat:2|currency_usd }}</td>
                         </tr>
                     </tbody>
                 </table>
             </div>
             {% endif %}

             <!-- Final Summary -->
            <div class="header-blue" style="margin-top: 30px;">Cost Summary</div>
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <tbody>
                        <tr>
                            <td><strong>A. Materials Subtotal:</strong></td>
                            <td class="text-right" data-materials-total-cost="{{ totals.materials }}">{{ totals.materials|floatformat:2|currency_usd }}</td>
                        </tr>
                        <tr>
                            <td><strong>B. Labor Subtotal:</strong></td>
                            <td class="text-right" data-labor-total-cost="{{ totals.labor }}">{{ totals.labor|floatformat:2|currency_usd }}</td>
                        </tr>
                        <tr>
                            <td><strong>C. Contractor Owned Equipment:</strong></td>
                            <td class="text-right" data-contractors-total-cost="{{ totals.contractors }}">{{ totals.contractors|floatformat:2|currency_usd }}</td>
                        </tr>
                        <tr>
                            <td><strong>D. Utilities:</strong></td>
                            <td class="text-right" data-utilities-total-cost="{{ totals.utilities }}">{{ totals.utilities|floatformat:2|currency_usd }}</td>
                        </tr>
                        <tr>
                             <td><strong>E. Miscellaneous:</strong></td>
                             <td class="text-right" data-miscellaneous-total-cost="{{ totals.miscellaneous }}">{{ totals.miscellaneous|floatformat:2|currency_usd }}</td>
                         </tr>
                         <tr>
                            <td><strong>F. Deducts:</strong></td>
                            <td class="text-right" data-deducts-total-cost="{{ totals.deducts }}">{{ totals.deducts|floatformat:2|currency_usd }}</td>
                        </tr>
                         {% if totals.margin_error > 0 %}
                         <tr class="table-warning fw-bold">
                             <td><strong>G. Margin Error:</strong></td>
                             <td class="text-right" data-margin-error-total-cost="{{ totals.margin_error }}">{{ totals.margin_error|default:0|floatformat:2|currency_usd }}</td>
                         </tr>
                         {% endif %}
                         <tr class="table-secondary fw-bold">
                            <td><strong>TOTAL COST:</strong></td>
                            <td class="text-right"><strong data-total-cost="{{ totals.total_cost_with_profit }}" id="total-cost-without-overhead">{{ totals.total_cost_with_profit|floatformat:2|currency_usd }}</strong></td>
                        </tr>
                        <tr class="table-success fw-bold">
                            <td><strong>OVERHEAD:</strong></td>
                            <td class="text-right"><strong data-total-profit="{{ totals.total_profit }}">{{ totals.total_profit|floatformat:2|currency_usd }}</strong></td>
                        </tr>
                        <tr class="table-primary fw-bold fs-5">
                            <td><strong>GRAND TOTAL:</strong></td>
                            <td class="text-right"><strong data-total-cost="{{ totals.total_cost }} " id="grand-total">{{ totals.total_cost|floatformat:2|currency_usd }}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Chart -->
            <div class="header-blue">Cost Distribution Chart</div>
            <div class="chart-container">
                <canvas id="costChart"></canvas>
            </div>
            
            <!-- Doughnut Chart and Cost Distribution Analysis -->
            <div class="header-blue" style="margin-top: 30px;">Cost Distribution Analysis</div>
            <div class="row">
                <div class="w-100">
                    <div class="chart-container">
                        <canvas id="doughnutChart"></canvas>
                    </div>
                </div>

            </div>
            
            <!-- Cost Breakdown Analysis -->
            <div class="cost-analysis-section">
                <h5 class="text-dark mb-4">Cost Breakdown Analysis</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="analysis-item">
                            <h6 class="text-dark">Materials  {{ totals.materials|floatformat:2|currency_usd }}</h6>
                            <p class="text-muted">{{ category_descriptions.materials.description|default:"Physical materials and technical components including fence materials, gates, hardware, and specialized equipment." }}</p>
                        </div>
                        
                        <div class="analysis-item">
                            <h6 class="text-dark">Labor  {{ totals.labor|floatformat:2|currency_usd }}</h6>
                            <p class="text-muted">{{ category_descriptions.labor.description|default:"Direct labor costs including installation, assembly, and specialized technical work required for project completion." }}</p>
                        </div>
                        
                        <div class="analysis-item">
                            <h6 class="text-dark">Contractors  {{ totals.contractors|floatformat:2|currency_usd }}</h6>
                            <p class="text-muted">{{ category_descriptions.contractors.description|default:"Subcontractor services and specialized contractor work including electrical, concrete, and other specialized installations." }}</p>
                        </div>
                        
                        <div class="analysis-item">
                            <h6 class="text-dark">Utilities  {{ totals.utilities|floatformat:2|currency_usd }}</h6>
                            <p class="text-muted">{{ category_descriptions.utilities.description|default:"Utility-related costs including electrical work, power requirements, and infrastructure connections." }}</p>
                        </div>
                    </div>
                    
                    <div class="col-md-6">  
                        <div class="analysis-item">
                            <h6 class="text-dark">Miscellaneous  {{ totals.miscellaneous|floatformat:2|currency_usd  }}</h6>
                            <p class="text-muted">{{ category_descriptions.miscellaneous.description|default:"Additional costs including special equipment, temporary structures, and other project-specific expenses." }}</p>
                        </div>
                        
                        {% if totals.deducts > 0 %}
                        <div class="analysis-item">
                            <h6 class="text-dark">Deducts  {{ totals.deducts|floatformat:2|currency_usd }}</h6>
                            <p class="text-muted">{{ category_descriptions.deducts.description|default:"Cost reductions and deductions applied to the project total." }}</p>
                        </div>
                        {% endif %}
                        
                        <div class="analysis-item">
                            <h6 class="text-dark">Overhead  {{ totals.profit|floatformat:2|currency_usd }}</h6>
                            <p class="text-muted">{{ category_descriptions.profit.description|default:"Project profit margin and business overhead included in the total project cost." }}</p>
                        </div>
                        
                        {% if totals.margin_error > 0 %}
                        <div class="analysis-item">
                            <h6 class="text-dark">Margin Error  {{ totals.margin_error|floatformat:2|currency_usd }}</h6>
                            <p class="text-muted">{{ category_descriptions.margin_error.description|default:"Additional margin error applied to account for potential cost variations and project uncertainties." }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="alert alert-light mt-4">
                    <h6 class="alert-heading">Cost Distribution Summary</h6>
                    <p class="mb-2">This project shows a balanced cost distribution with direct costs (materials, labor, contractors) representing the core expenses, while indirect costs (overhead, utilities, miscellaneous) cover operational expenses.</p>
                </div>
            </div> 
        </div>
    </section>    
</div>
{% include 'components/modal_send_email.html' %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>

<!-- Chart data from Django -->
{{ chart_data|json_script:"chart-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get chart data from JSON script tag
    const chartDataElement = document.getElementById('chart-data');
    const chartData = JSON.parse(chartDataElement.textContent);
    
    // Calcular porcentajes
    const total = chartData.values.reduce((sum, value) => sum + value, 0);
    const percentages = chartData.values.map(value => ((value / total) * 100).toFixed(1));
    
    // Create the chart
    const ctx = document.getElementById('costChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Cost ($)',
                data: chartData.values,
                backgroundColor: chartData.colors.map(color => color + '80'), // Agregar opacidad
                borderColor: chartData.colors,
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    },
                    grid: {
                        color: 'rgba(251, 192, 45, 0.2)',
                        drawBorder: false
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(251, 192, 45, 0.2)',
                        drawBorder: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        },
        plugins: [{
            id: 'customLabels',
            afterDraw: function(chart) {
                const ctx = chart.ctx;
                const meta = chart.getDatasetMeta(0);
                
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.font = 'bold 12px Arial';
                
                meta.data.forEach(function(bar, index) {
                    const value = chartData.values[index];
                    const percentage = percentages[index];
                    
                    // Mostrar valor arriba de la columna
                    ctx.fillStyle = '#333';
                    ctx.fillText('$' + value.toLocaleString(), bar.x, bar.y - 10);
                    
                    // Mostrar porcentaje dentro de la columna
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 10px Arial';
                    ctx.fillText(percentage + '%', bar.x, bar.y - bar.height/2);
                });
            }
        }]
    });
    
    // Create Doughnut Chart
    const doughnutCtx = document.getElementById('doughnutChart').getContext('2d');
    const doughnutChart = new Chart(doughnutCtx, {
        type: 'doughnut',
        data: {
            labels: chartData.labels,
            datasets: [{
                data: chartData.values,
                backgroundColor: chartData.colors,
                borderColor: '#fff',
                borderWidth: 2,
                cutout: '60%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    enabled: false
                },
                hover: {
                    mode: null
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            },
            interaction: {
                intersect: false,
                mode: null
            }
        }
    });
    
    // Función simple para dibujar porcentajes
    function addDoughnutLabels() {
        const ctx = doughnutCtx;
        const meta = doughnutChart.getDatasetMeta(0);
        
        if (!meta || !meta.data) {
            console.log('No meta data available');
            return;
        }
        
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = 'bold 16px Arial';
        
        meta.data.forEach(function(arc, index) {
            if (!arc || typeof arc.x === 'undefined' || typeof arc.y === 'undefined') {
                return;
            }
            
            const value = chartData.values[index];
            const percentage = percentages[index];
            
            // Calcular el centro de cada sección de la dona
            const centerX = arc.x;
            const centerY = arc.y;
            
            // Calcular el ángulo medio de cada sección
            const startAngle = arc.startAngle;
            const endAngle = arc.endAngle;
            const midAngle = (startAngle + endAngle) / 2;
            
            // Calcular la posición en el radio medio de la dona
            const radius = (arc.outerRadius + arc.innerRadius) / 2;
            const labelX = centerX + Math.cos(midAngle) * radius;
            const labelY = centerY + Math.sin(midAngle) * radius;
            
            
            // Mostrar porcentaje en el centro de cada sección
            ctx.fillStyle = '#000';
            ctx.fillText(percentage + '%', labelX, labelY);
        });
    }
    
    // Intentar dibujar después de diferentes delays
    setTimeout(addDoughnutLabels, 1500);
    setTimeout(addDoughnutLabels, 2500);
    setTimeout(addDoughnutLabels, 3500);
    
    // También intentar cuando el chart esté listo
    doughnutChart.options.plugins.afterDraw = function(chart) {
        addDoughnutLabels();
    };
    
    // Forzar redibujado
    doughnutChart.update();
    
    // Redibujar cuando cambie el tamaño de la ventana
    window.addEventListener('resize', function() {
        doughnutChart.update();
    });
});

function generatePDF() {
    const element = document.getElementById('main-container');
    
    // Agregar estilos CSS para controlar saltos de página sin elementos visibles
    const style = document.createElement('style');
    style.textContent = `
        @media print {
            canvas { page-break-before: always; }
            table { page-break-before: always; page-break-inside: avoid; }
            .header-blue { page-break-before: always; }
            .cost-analysis-section { page-break-before: always; }
            tr { page-break-inside: avoid; break-inside: avoid; }
            .no-break { page-break-inside: avoid; break-inside: avoid; }
        }
    `;
    document.head.appendChild(style);
    
    const opt = {
        margin: 0,
        filename: 'cost_breakdown_{{ proposal.project.id }}_{{ proposal.id }}.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
            scale: 2,
            useCORS: true,
            allowTaint: true,
            logging: false
        },
        jsPDF: { 
            unit: 'in', 
            format: 'letter', 
            orientation: 'portrait',
            compress: true
        }
    };
    
    html2pdf().set(opt).from(element).save().then(() => {
        // Remover el estilo CSS después de generar el PDF
        document.head.removeChild(style);
    });
}


// Funciones para editar descripciones de elementos
function editItemDescription(button) {
    const td = button.parentElement;
    const currentText = td.textContent.trim().replace('✏️', '').trim();
    const category = td.dataset.category;
    const originalName = td.dataset.originalName;
    
    // Crear input y botones
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'edit-input';
    input.value = currentText;
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'save-btn';
    saveBtn.textContent = '💾';
    saveBtn.onclick = () => saveItemDescription(td, input, category, originalName);
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'cancel-btn';
    cancelBtn.textContent = '❌';
    cancelBtn.onclick = () => cancelEdit(td, currentText);
    
    // Limpiar contenido y agregar elementos de edición
    td.innerHTML = '';
    td.appendChild(input);
    td.appendChild(saveBtn);
    td.appendChild(cancelBtn);
    
    // Enfocar el input
    input.focus();
    input.select();
}

function saveItemDescription(td, input, category, originalName) {
    const newDescription = input.value.trim();
    
    if (newDescription === '') {
        alert('La descripción no puede estar vacía');
        return;
    }
    
    // Enviar al servidor
    fetch('{% url "edit_cost_item_descriptions" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            category: category,
            original_description: originalName,
            custom_description: newDescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar la celda
            td.innerHTML = newDescription + '<button class="edit-btn" onclick="editItemDescription(this)">✏️</button>';
            td.dataset.customName = newDescription;
            
            // Mostrar mensaje de éxito
            showNotification('Descripción actualizada correctamente', 'success');
        } else {
            alert('Error al guardar: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar la descripción');
    });
}

function cancelEdit(td, originalText) {
    // Restaurar el contenido original
    td.innerHTML = originalText + '<button class="edit-btn" onclick="editItemDescription(this)">✏️</button>';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type) {
    // Crear notificación temporal
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        background-color: ${type === 'success' ? '#28a745' : '#dc3545'};
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remover después de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
function reduceOverhead() {
    const percentage = document.querySelector('#percentage-profit');
    const currentPercentage = parseFloat(percentage.dataset.percentage);
    let newPercentage = Math.max(0, currentPercentage - 1);
    if (newPercentage <= 0) {  
        newPercentage = 0;
        showNotification(`Overhead cannot be less than 0%`, 'error');
        return;
    }
    const formattedPercentage = newPercentage.toFixed(2);
    // Guardar los   existentes
    const buttonsContainer = percentage.parentElement.querySelector('.position-absolute');
    
    // Actualizar solo el texto del porcentaje
    percentage.textContent = formattedPercentage + '%';
    percentage.dataset.percentage = formattedPercentage;
    
    // Restaurar los botones si existían
    if (buttonsContainer && !percentage.parentElement.querySelector('.position-absolute')) {
        percentage.parentElement.appendChild(buttonsContainer);
    }
    
    recalculateCategories();
    calculateTotalCostWithoutOverhead()
    showNotification(`Overhead reduced to ${formattedPercentage}%`, 'success');
}

function increaseOverhead() {
    const percentage = document.querySelector('#percentage-profit');
    const currentPercentage = parseFloat(percentage.dataset.percentage);
    const newPercentage = Math.min(100, currentPercentage + 1);
    const formattedPercentage = newPercentage.toFixed(2);
    if (formattedPercentage > 100) {
        formattedPercentage = 100;
        showNotification(`Overhead cannot be greater than 100%`, 'error');
        return;
    }
    
    // Guardar los botones existentes
    const buttonsContainer = percentage.parentElement.querySelector('.position-absolute');
    
    // Actualizar solo el texto del porcentaje
    percentage.textContent = formattedPercentage + '%';
    percentage.dataset.percentage = formattedPercentage;
    
    // Restaurar los botones si existían
    if (buttonsContainer && !percentage.parentElement.querySelector('.position-absolute')) {
        percentage.parentElement.appendChild(buttonsContainer);
    }
    
    recalculateCategories();
    showNotification(`Overhead increased to ${formattedPercentage}%`, 'success');
}

function updateTotalCostByCategory() {
    
    // Obtener todas las categorías
    const categories = ['materials', 'labor', 'contractors', 'utilities', 'miscellaneous', 'deducts', 'margin_error', 'profit'];
    let totalSum = 0;
    
    // Sumar todos los valores de las categorías
    categories.forEach(category => {
        const categoryElement = document.querySelector(`.total-cost-category.${category}`);
        if (categoryElement) {
            const value = parseFloat(categoryElement.textContent.replace('$', '').replace(',', '')) || 0;
            totalSum += value;
        }
    });
    
    // Obtener el total original del proposal
    const totalCostByCategoryElement = document.getElementById('total-cost-by-category');
    const originalTotal = parseFloat(totalCostByCategoryElement.dataset.originalProposalTotal) || 
                         parseFloat(totalCostByCategoryElement.textContent.replace('$', '').replace(',', '')) || 0;
    
    
    // Verificar si el total calculado se pasa del original
    if (totalSum > originalTotal) {
        
        // Mantener el valor original
        totalCostByCategoryElement.textContent = '$' + originalTotal.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    } else {
        
        // Actualizar con el total calculado
        totalCostByCategoryElement.textContent = '$' + totalSum.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
}

function recalculateCategories() {
    
    // Obtener el total original del proposal (base para todos los cálculos)
    const totalCostByCategoryElement = document.getElementById('total-cost-by-category');
    let originalProposalTotal = 0;
    
    // Si no existe el dataset, crearlo con el valor actual
    if (totalCostByCategoryElement && !totalCostByCategoryElement.dataset.originalProposalTotal) {
        originalProposalTotal = parseFloat(totalCostByCategoryElement.textContent.replace('$', '').replace(',', '')) || 0;
        totalCostByCategoryElement.dataset.originalProposalTotal = originalProposalTotal.toFixed(2);
    } else if (totalCostByCategoryElement) {
        originalProposalTotal = parseFloat(totalCostByCategoryElement.dataset.originalProposalTotal) || 0;
    }
    
    // Usar el total original como base para todos los cálculos
    const grandTotal = originalProposalTotal;
    
    // Obtener el nuevo porcentaje de overhead
    const overheadPercentage = parseFloat(document.querySelector('#percentage-profit').dataset.percentage);
    
    // Calcular el nuevo costo del overhead
    const newOverheadCost = (grandTotal * overheadPercentage) / 100;
    
    // Obtener el overhead anterior para calcular la diferencia
    const overheadCell = document.querySelector('.total-cost-category.profit');
    const oldOverheadCost = parseFloat(overheadCell.textContent.replace('$', '').replace(',', '')) || 0;
    const overheadDifference = newOverheadCost - oldOverheadCost;
    
    // Actualizar el overhead
    overheadCell.textContent = '$' + newOverheadCost.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    // Redistribuir la diferencia del overhead entre sus items individuales
    if (overheadDifference !== 0) {
        redistributeCategoryItems('profit', overheadDifference);
    }
    
    // Calcular cuánto queda para las otras categorías
    const remainingForOthers = grandTotal - newOverheadCost;
    
    // Obtener todas las categorías excepto overhead
    const otherCategories = document.querySelectorAll('.total-cost-category:not(.profit)');
    let totalOtherPercentages = 0;

    
    // Calcular el total de porcentajes de otras categorías
    otherCategories.forEach(category => {
        const categoryName = category.dataset.categoryName;
        const percentageCell = document.querySelector(`[data-category-percentage-${categoryName}]`);
        if (percentageCell) {
            const percentageSpan = percentageCell.querySelector('span');
            let percentage = 0;
            if (percentageSpan && !percentageSpan.id.includes('profit')) {
                percentage = parseFloat(percentageSpan.textContent.replace('%', '')) || 0;
            } else {
                percentage = parseFloat(percentageCell.textContent.replace('%', '')) || 0;
            }
            totalOtherPercentages += percentage;
        }
    });
    
    
    // Recalcular cada categoría basándose en su porcentaje del total restante
    otherCategories.forEach(category => {
        const categoryName = category.dataset.categoryName;
        const percentageCell = document.querySelector(`[data-category-percentage-${categoryName}]`);
        
        if (percentageCell) {
            let currentPercentage = 0;
            const percentageSpan = percentageCell.querySelector('span');
            
            if (percentageSpan && !percentageSpan.id.includes('profit')) {
                currentPercentage = parseFloat(percentageSpan.textContent.replace('%', '')) || 0;
            } else {
                currentPercentage = parseFloat(percentageCell.textContent.replace('%', '')) || 0;
            }
            
            // Calcular el nuevo costo basándose en el porcentaje del total restante
            const newCost = (remainingForOthers * currentPercentage) / totalOtherPercentages;
            const newPercentage = ((newCost / grandTotal) * 100);
            
            
            // Obtener el costo anterior de la categoría
            const oldCost = parseFloat(category.textContent.replace('$', '').replace(',', '')) || 0;
            const costDifference = newCost - oldCost;
            
            // Actualizar el costo de la categoría
            category.textContent = '$' + newCost.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            // Actualizar el porcentaje
            if (percentageSpan && !percentageSpan.id.includes('profit')) {
                percentageSpan.textContent = newPercentage + '%';
                percentageSpan.dataset.percentage = newPercentage;
            } else {
                // Para el overhead (profit), preservar los botones
                if (categoryName === 'profit') {
                    // Guardar los botones existentes
                    const buttonsContainer = percentageCell.querySelector('.position-absolute');
                    
                    // Actualizar solo el texto del porcentaje
                    percentageCell.textContent = newPercentage + '%';
                    percentageCell.dataset.categoryPercentage = newPercentage;
                    
                    // Restaurar los botones si existían
                    if (buttonsContainer && !percentageCell.querySelector('.position-absolute')) {
                        percentageCell.appendChild(buttonsContainer);
                    }
                } else {
                    percentageCell.textContent = newPercentage + '%';
                    percentageCell.dataset.categoryPercentage = newPercentage;
                }
            }
            normalizePercentages();
            
            // Redistribuir la diferencia entre los items individuales de esta categoría
            // margin_error no tiene items individuales, solo se actualiza el subtotal
            if (categoryName === 'margin_error') {
                updateMarginErrorSubtotal(newCost);
            } else {
                redistributeCategoryItems(categoryName, costDifference);
            }
        }
    });
    
    // Actualizar el total dinámicamente
    updateTotalCostByCategory();
}

function redistributeCategoryItems(categoryName, costDifference) {

    // Encontrar la tabla de la categoría
    const categoryTable = document.querySelector(`[data-category-table="${categoryName}"]`);
    if (!categoryTable) {
        return;
    }
    
    // Obtener todos los items de costo de esta categoría
    const costCells = categoryTable.querySelectorAll('.cost-cell');
    if (costCells.length === 0) {
        return;
    }
    
    // Calcular el total actual de los items
    let totalItemsCost = 0;
    const items = [];
    
    costCells.forEach(cell => {
        const cost = parseFloat(cell.textContent.replace('$', '').replace(',', '')) || 0;
        totalItemsCost += cost;
        items.push({
            element: cell,
            currentCost: cost
        });
    });
    
    
    // Si no hay diferencia o no hay items, salir
    if (costDifference === 0 || totalItemsCost === 0) {
        console.log('No hay diferencia que redistribuir');
        return;
    }
    
    // Redistribuir la diferencia proporcionalmente entre los items
    items.forEach(item => {
        const itemShare = item.currentCost / totalItemsCost;
        const adjustment = costDifference * itemShare;
        const newCost = item.currentCost + adjustment;
        
        // Actualizar el costo del item
        item.element.textContent = '$' + newCost.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        // Si el item tiene un data attribute para el costo, actualizarlo también
        if (item.element.dataset.cost) {
            item.element.dataset.cost = newCost;
        }
    });


    // Actualizar el subtotal de la categoría
    updateCategorySubtotal(categoryName);
}

function updateCategorySubtotal(categoryName) {
    // Encontrar la tabla de la categoría
    const categoryTable = document.querySelector(`[data-category-table="${categoryName}"]`);
    if (!categoryTable) {
        console.log(`No se encontró tabla para categoría ${categoryName}`);
        return;
    }
    
    // Obtener todos los items de costo de esta categoría
    const costCells = categoryTable.querySelectorAll('.cost-cell');
    if (costCells.length === 0) {
        return;
    }
    
    // Calcular el nuevo subtotal
    let newSubtotal = 0;
    costCells.forEach(cell => {
        const cost = parseFloat(cell.textContent.replace('$', '').replace(',', '')) || 0;
        newSubtotal += cost;
    });
    
    
    // Actualizar el subtotal en la tabla de la categoría
    const subtotalCell = document.querySelector(`[data-${categoryName}-total-cost]`);
    if (subtotalCell) {
        subtotalCell.textContent = '$' + newSubtotal.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        subtotalCell.dataset[`${categoryName}TotalCost`] = newSubtotal;
    }
    
    // Actualizar el subtotal en la tabla de resumen
    const summarySubtotalCell = document.querySelector(`.total-cost-category.${categoryName}`);
    if (summarySubtotalCell) {
        summarySubtotalCell.textContent = '$' + newSubtotal.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        summarySubtotalCell.dataset.categoryTotalCost = newSubtotal;
    }
    
    // Recalcular el porcentaje en la tabla de resumen
    const grandTotal = parseFloat(document.querySelector('[data-total-cost]').textContent.replace('$', '').replace(',', '')) || 0;
    const newPercentage = ((newSubtotal / grandTotal) * 100);
    
    const percentageCell = document.querySelector(`[data-category-percentage-${categoryName}]`);
    if (percentageCell) {
        const percentageSpan = percentageCell.querySelector('span');
        if (percentageSpan && !percentageSpan.id.includes('profit')) {
            percentageSpan.textContent = newPercentage + '%';
            percentageSpan.dataset.percentage = newPercentage;
        } else {
            percentageCell.textContent = newPercentage + '%';
            percentageCell.dataset.categoryPercentage = newPercentage;
        }
    }
    updateTotalCostByCategory();
    updateCostSummaryValues();
}

function updateMarginErrorSubtotal(newCost) {
    // Actualizar todos los elementos que muestran margin_error
    const marginErrorElements = document.querySelectorAll('[data-margin-error-total-cost]');
    marginErrorElements.forEach(element => {
        element.textContent = '$' + newCost.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        element.dataset.marginErrorTotalCost = newCost;
    });
    
    // Actualizar el elemento en la tabla de resumen
    const summaryElement = document.querySelector('.total-cost-category.margin_error');
    if (summaryElement) {
        summaryElement.textContent = '$' + newCost.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        summaryElement.dataset.categoryTotalCost = newCost;
    }
    
    // Actualizar el total dinámicamente
    updateTotalCostByCategory();
}

function updateCostSummaryValues() {
    const categoryValues = {};
    const categories = ['materials', 'labor', 'contractors', 'utilities', 'miscellaneous', 'deducts', 'margin_error'];
    
    categories.forEach(category => {
        // Obtener el valor desde la tabla de resumen (que ya está actualizada)
        const summaryElement = document.querySelector(`.total-cost-category.${category}`);
        if (summaryElement) {
            const value = parseFloat(summaryElement.textContent.replace('$', '').replace(',', '')) || 0;
            categoryValues[category] = value;
        }
    });
    
    
    
    // Obtener el overhead actual
    const overheadElement = document.querySelector('.total-cost-category.profit');
    const overheadValue = parseFloat(overheadElement.textContent.replace('$', '').replace(',', '')) || 0;
    
    // Obtener el total original del proposal (mantener constante)
    const proposalTotalElement = document.getElementById('total-cost-by-category');
    const originalProposalTotal = parseFloat(proposalTotalElement.dataset.originalProposalTotal) || 0;
    
    // El grand total siempre debe ser el total original del proposal
    const grandTotal = originalProposalTotal;
    

    // Actualizar los subtotales en Cost Summary
    categories.forEach(category => {
        const costSummaryElements = document.querySelectorAll(`[data-${category}-total-cost]`);
        const value = categoryValues[category] || 0;
        costSummaryElements.forEach(element => {
            element.textContent = '$' + value.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        });
    });

        // Calcular el total cost (sin overhead) - sumando todos los subtotales menos profit

    
    // Actualizar GRAND TOTAL en Cost Summary (siempre el total original)
    const grandTotalElement = document.getElementById('grand-total');
    if (grandTotalElement) {
        grandTotalElement.textContent = '$' + grandTotal.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Actualizar OVERHEAD en Cost Summary
    const overheadSummaryElements = document.querySelectorAll('[data-total-profit]');
    overheadSummaryElements.forEach(element => {
        element.textContent = '$' + overheadValue.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    });
    
    // Actualizar el total de la tabla de resumen por categorías (mantener original)
    const totalCostByCategoryElement = document.getElementById('total-cost-by-category');
    if (totalCostByCategoryElement) {
        totalCostByCategoryElement.textContent = '$' + grandTotal.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Actualizar valores en Cost Breakdown Analysis
    categories.forEach(category => {
        const analysisElements = document.querySelectorAll('.analysis-item h6');
        analysisElements.forEach(element => {
            const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
            if (element.textContent.includes(categoryName)) {
                const value = categoryValues[category] || 0;
                element.textContent = `${categoryName}  $${value.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
            }
        });
    });
    
    // Actualizar Margin Error en Cost Breakdown Analysis si existe
    const marginErrorElements = document.querySelectorAll('.analysis-item h6');
    marginErrorElements.forEach(element => {
        if (element.textContent.includes('Margin Error')) {
            const value = categoryValues['margin_error'] || 0;
            element.textContent = `Margin Error  $${value.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }
    });
}

function calculateTotalCostWithoutOverhead() {
    let totalCostWithoutOverhead = 0;
    const allCategoryElements = document.querySelectorAll('.total-cost-category');
    
    allCategoryElements.forEach(element => {
        const categoryName = element.dataset.categoryName;
        if (categoryName && categoryName !== 'profit') {
            const value = parseFloat(element.textContent.replace('$', '').replace(',', '')) || 0;
            totalCostWithoutOverhead += value;
        }
    });
    
    const totalCostWithoutOverheadElement = document.getElementById('total-cost-without-overhead');
    if (totalCostWithoutOverheadElement) {
        totalCostWithoutOverheadElement.textContent = '$' + totalCostWithoutOverhead.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
}

function normalizePercentages() {
    const percentages = document.querySelectorAll('.total-percentage-category');
    let total = 0;
    percentages.forEach(p => {
        total += parseFloat(p.textContent.replace('%', '')) || 0;
    });

    if (total !== 100) {
        const difference = 100 - total;
        percentages.forEach(p => {
            const currentPercentage = parseFloat(p.textContent.replace('%', '')) || 0;
            const newPercentage = (currentPercentage + (difference / percentages.length)).toFixed(1);
            p.textContent = newPercentage + '%';
            p.dataset.percentage = newPercentage;
        });
    }
}


</script>

{% endblock %} 