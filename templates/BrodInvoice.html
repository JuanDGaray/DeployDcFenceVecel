{% extends "base.html" %}
{% load static %}
{% block extra_head %}
    <style>
        body {
            background-image: url("{% static 'img/logoPatron.png' %}");
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            backdrop-filter: grayscale(100%);
        }
        .infoContainer{
          background-image: url("{% static 'img/logoPatron.png' %}");
          background-repeat: none;
          background-position: center;
          background-size: 480px 480px
      }
        .container-sm {
            background-color: white;
            padding: 40px;
            box-shadow: 0 0 10px black;
        }
        .logoView{
          background-color: #1a4784;
          width: 100px;
          padding: 4px;
          height: 70px;
          margin:8px
      }
      .imgSello{
        position: absolute;
        opacity: 0.5;
        fill: none;
        left: 65%;
        width:250px;
        user-select: none;
        pointer-events: none;
        
    }
    .firma{
        display: absolute;
        width:60px;
        top:-15px
    }
    input.form-control {
        border:none;
        padding:0px 10px;
        border-radius:0px;
        border-size:2px
    }
    #addItem{
        position: relative;
        top: -56px;
        opacity: 0.2;
    }
    #addItem:hover{
        position: relative;
        top: -56px;
        opacity: 1;
    }
    
    /* Calculator styles */
    .calculator-icon:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .calculator-panel {
        transition: opacity 0.3s ease;
        backdrop-filter: blur(5px);
        border: 2px solid #6c757d;
    }
    
    .calculator-panel:hover {
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    </style>
{% endblock %}
{% block title %} BRO | {{ project.project_name }}{% endblock %}
{% block content %}
{% load custom_filters %} 
    <input type="hidden" id="csrf-token" data-csrf="{{ csrf_token }}" data-typeInv='MDCP'>
    

    <h1 class='fs-5 bg-white border border-4 border-primary fw-bold text-primary p-2 m-2 rounded-4 w-50 d-flex flex-row justify-content-between align-items-center'>BROWARD TEMPLATE - ID{{project.id}} {{project.project_name}}
        <div>
            <button id="saveButton" class="btn btn-primary rounded-2" onclick="saveInvoice()">
            <i class="bi bi-floppy text-light me-2"></i>Save
            </button>
            <a class="btn btn-sm rounded-2 p-1 d-none" role="button" data-bs-toggle="tooltip" id='infoSave'
                data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                data-bs-title="The budget amount exceeds the available total for billing. $ {{proposal.remaining_amount}}" 
                aria-label="Info" data-bs-original-title="Rejected Proposal">
                <i class="bi bi-info-circle text-danger" style="font-size: 15px;"></i>
            </a>
        </div>
    </h1>
    <div class="container-sm mx-5 my-4 rounded-4 mx-auto col-md-10 position-relative" id='containerInvoice'>
        <div class="d-flex flex-row mb-4">
            <div class="col">
                <span class="bg-primary text-white px-3 py-2">INVOICE :  <input id="invoiceId" type='text' class="bg-primary border-0 text-white" style="width: auto; min-width: 1ch; text-align: center;" size="8" value="{{project.id}}-{{proposal.id}}{{next_invoice_id}}"></span>
            </div>
            <div class="d-flex flex-row justify-content-center text-end bg position-relative">
                <div class="d-flex flex-column align-items-center px-4 mx-4">
                    <img src="{% static 'img/DaylenFirma.webp' %}" alt="DC FENCE Logo" class="firma position-relative">
                    <span class="text-center position-absolute nameSignature" style="border-top: 2px solid black; display: inline-block; padding-top: 5px; bottom:0%">
                        Approved by Daylen Puerto
                    </span>
                </div>
                <img src="{% static 'img/LogoCompleteWhite.webp' %}" alt="DC FENCE Logo" class="logoView mx-4">
            </div>
        </div>
    
        <div class="col">
            <strong>DADE: </strong>
            <input id="dadeId" type="text" class="border-0" style="width: auto; min-width: 5ch; text-align: center;" value="20BS00539">
        </div>
        <div class="col">
            <strong>BRO: </strong>
            <input id="broId" type="text" class="border-0" style="width: auto; min-width: 5ch; text-align: center;" value="20BS00539">
        </div>

    
        <div class="mb-2">
            <div class="row">
                <div class="col-4 fw-bold border border-2 text-end">INVOICE NO.</div>
                <div class="col-8">
                    <input id="invoiceNumber" type="text" class="form-control border-bottom" value="{{project.id}}-{{proposal.id}}{{next_invoice_id}}">
                </div>
            </div>
        </div>
    
        <img src="{% static 'img/DcSello.webp' %}" alt="DC FENCE Logo" class="imgSello">
    
        <div class="mb-2">
            <div class="row">
                <div class="col-4 fw-bold border border-2 text-end">JOB ADDRESS</div>
                <div class="col-8">
                    <input id="jobAddress" type="text" class="form-control border-bottom" value="{{project.customer.address}}">
                </div>
            </div>
        </div>
    
        <div class="mb-2">
            <div class="row">
                <div class="col-4 fw-bold border border-2 text-end">DESCRIPTION</div>
                <div class="col-8">
                    <input id="jobDescription" type="text" class="form-control border-bottom" value="{{project.description}}">
                </div>
            </div>
        </div>
    
        <div class="mb-2">
            <div class="row">
                <div class="col-4 fw-bold border border-2 text-end">BILL TO:</div>
                <div class="col-8">
                    <input id="billTo" type="text" class="form-control border-bottom" value="MDCPS">
                </div>
            </div>
        </div>
    
        <div class="mb-3">
            <div class="row">
                <div class="col-4 fw-bold border border-2 text-end">PERIOD:</div>
                <div class="col-8">
                    <div class="d-flex">
                        <input type="date" id="startDate" class="form-control border-bottom me-2" placeholder="Start Date">
                        <input type="date" id="endDate" class="form-control border-bottom" placeholder="End Date">
                    </div>
                </div>
            </div>
        </div>
    
        <div class="mb-2">
            <div class="row">
                <div class="col-4 fw-bold border border-2 text-end">PROJECT NAME</div>
                <div class="col-8">
                    <input id="projectName" type="text" class="form-control border-bottom text-uppercase" value="{{project.project_name}}">
                </div>
            </div>
        </div>
    
        <div class="mb-2">
            <div class="row">
                <div class="col-4 fw-bold border border-2 text-end">CONTRACT #</div>
                <div class="col-8">
                    <input id="contractNumber" type="text" class="form-control border-bottom" value="">
                </div>
            </div>
        </div>
    

        <div>
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Quantity</th>
                        <th>Description</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody id="itemsBody">
                    <tr class='itemRow'>
                        <td style='width:40px'><input id="item1Quantity" type="number" class="form-control" value="1"></td>
                        <td><input id="item1Description" type="text" class="form-control" value="Supply and install Chain Link Fence and Gates"></td>
                        <td class="text-end w-25"><input id="item1Amount" type="text" class="form-control text-end" value="{{proposal.remaining_amount|floatformat:2}}" oninput="updateTotal()"></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" class="text-end text-primary fw-bold"><strong>TOTAL :</strong></td>
                        <td class="text-end bg-primary">
                            <input id="totalAmount" type="text" class="form-control text-end bg-primary text-light fw-bold" value="{{proposal.remaining_amount|floatformat:2}}" readonly >
                        </td>
                    </tr>
                </tfoot>
            </table>
            <button id="addItem" class="btn btn-primary py-1 fs-6">+ Add Item</button>
            
            <!-- Percentage Calculator -->
            <div class="position-absolute bottom-0 end-0 m-3" id="calculatorContainer">
                <!-- Calculator Icon (Always Visible) -->
                <div class="calculator-icon bg-white border border-secondary rounded-circle p-2 shadow-sm" 
                     style="width: 50px; height: 50px; cursor: pointer; transition: all 0.3s ease;"
                     onclick="toggleCalculator()">
                    <i class="bi bi-calculator text-success fs-4 d-flex justify-content-center align-items-center h-100"></i>
                </div>
                
                <!-- Calculator Panel (Hidden by default) -->
                <div class="calculator-panel bg-white border border-secondary rounded shadow-sm p-3" 
                     id="calculatorPanel" 
                     style="position: absolute; bottom: 60px; right: 0; width: 300px; display: none; z-index: 1000;">
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <input type="number" id="percentageInput" class="form-control bg-secondary bg-opacity-25" 
                                   placeholder="%" min="0" max="100" step="0.01" style="width: 80px;">
                            <button class="btn btn-secondary text-white btn-sm" type="button" onclick="calculatePercentage()">
                                Calculate
                            </button>
                        </div>
                        <div class="d-flex gap-1 flex-wrap">
                            <button class="btn btn-success btn-sm" onclick="applyPercentage(10)">10%</button>
                            <button class="btn btn-success btn-sm" onclick="applyPercentage(25)">25%</button>
                            <button class="btn btn-success btn-sm" onclick="applyPercentage(50)">50%</button>
                            <button class="btn btn-success btn-sm" onclick="applyPercentage(75)">75%</button>
                        </div>
                        <small class="text-muted">Click to calculate percentages</small>
                    </div>
                </div>
            </div>
        </div>
        
    
        <div class="d-flex flex-row flex-nowrap justify-content-evenly rounded-4 infoContainer p-3 px-4">
            <div class="text-center m-2 p-2 bg-white rounded-4">
                <p class="mb-2" id="shipTo">SHIP TO: DC FENCE SOLUTIONS/ 2498 W THIRD CT HIALEAH, FL 33010</p>
                <p class="text-danger mb-2" id="paymentInstructions">Please make checks payable to: DC FENCE SOLUTIONS</p>
                <p class="text-primary" id="thankYouMessage">Thank you for your trust</p>
            </div>
        </div>
    </div>
    <div id="alert-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('addItem').addEventListener('click', addItem);

        let itemCount = 1;
        let total = parseFloat('{{proposal.remaining_amount}}') || 0;

        // Initialize currency formatting on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Format initial amount as USD
            const initialAmount = document.getElementById('item1Amount');
            if (initialAmount) {
                const value = parseFloat(initialAmount.value) || 0;
                initialAmount.value = value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            }
            
            // Format total as USD
            const totalElement = document.getElementById('totalAmount');
            if (totalElement) {
                const value = parseFloat(totalElement.value) || 0;
                totalElement.value = value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            }
            
            // Set default dates
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            if (startDate && endDate) {
                // Set today's date
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                startDate.value = todayString;
                
                // Set date 30 days from today
                const thirtyDaysLater = new Date();
                thirtyDaysLater.setDate(today.getDate() + 30);
                const thirtyDaysLaterString = thirtyDaysLater.toISOString().split('T')[0];
                endDate.value = thirtyDaysLaterString;
            }
        });

        function addItem() {
            itemCount++;
            const tbody = document.getElementById('itemsBody');
            
            // Create a new row
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input id="item${itemCount}Quantity" type="number" class="form-control" value="1" oninput="updateTotal()"></td>
                <td><input id="item${itemCount}Description" type="text" class="form-control" value="New Item"></td>
                <td class="text-end"><input id="item${itemCount}Amount" type="text" class="form-control text-end" value="0.00" oninput="updateTotal()"></td>
                <td class="p-0 text-center d-flex align-items-center" style="width:0px; positionL:relative" >
                    <button type="button" class="border-0 text-danger remove_btn p-1 rounded-4 " aria-label="remove-item" onclick="removeItem(this)">
                        <i class="bi bi-trash3 fs-5"></i>
                    </button>
                </td>
            `;
            row.classList.add('itemRow');
            tbody.appendChild(row);
    total
            updateTotal();
        }
        function removeItem(button) {
            const row = button.closest('tr');
            row.remove();
            updateTotal();
        }
        function updateTotal() {
            total = 0;
            const amounts = document.querySelectorAll('[id^="item"][id$="Amount"]');
            amounts.forEach(input => {
                // Remove currency formatting and parse as number
                const value = input.value.replace(/[$,]/g, '');
                total += parseFloat(value) || 0;
            });
            const infoSaved = document.getElementById("infoSave");
            const maxTotal = parseFloat('{{ proposal.remaining_amount }}'); 
            const totalElement = document.getElementById('totalAmount');
            totalElement.value = total.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            const saveButton = document.getElementById('saveButton');
            
            if (total > maxTotal) {
                if (infoSaved.classList.contains("d-none")) {
                    infoSaved.classList.remove("d-none");
                }
                saveButton.disabled = true;
                showAlert('The budget amount exceeds the available total for billing. $' + maxTotal.toLocaleString('en-US', { style: 'currency', currency: 'USD' }), 'warning');
            } else {
                saveButton.disabled = false;
                if (!infoSaved.classList.contains("d-none")) {
                    infoSaved.classList.add("d-none");
                }
            }
        }
        

        function saveInvoice() {
            const inputs = document.querySelectorAll(".container-sm input");
            const jsonData = {};
            const csrfToken = document.getElementById('csrf-token').dataset.csrf;
            inputs.forEach(input => {
                if (input.id && !input.closest('.itemRow') ) {
                    jsonData[input.id] = input.value;
                }
            });
            const rowItems = document.querySelectorAll(".itemRow");
            const items = [];
            
            rowItems.forEach(row => {
                const rowData = {};
                const cells = row.querySelectorAll("td");
                
                cells.forEach((cell, index) => {
                    const input = cell.querySelector("input"); 

                    if (input) { 
                        if (index === 0) {
                            rowData.qt = input.value;
                        } else if (index === 1) {
                            rowData.description = input.value; 
                        } else if (index === 2) {
                            rowData.value = input.value;
                        }
                    }
                });
                items.push(rowData);
                });
            jsonData['items'] = items;
            jsonData['total'] = total;
            jsonData['type'] = 'BROWARD';
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('d-none');
            fetch(`/projects/{{project.id}}/mdcpInvoice/{{proposal.id}}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify(jsonData),
            })
            .then(data => {
                console.log('Respuesta del servidor:', jsonData);
                const loadingOverlay = document.getElementById('loadingOverlay');
                window.location.href = `/projects/{{project.id}}/`;
                loadingOverlay.classList.add('d-none');
            })
            .catch(error => {
                console.error('Error al enviar los datos:', error);
            });
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById("alert-container");
            const alert = document.createElement("div");
            alert.classList.add("alert", `alert-${type}`, "alert-dismissible", "fade", "show");
            alert.role = "alert";
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => {
                alert.classList.remove("show");
                alert.classList.add("fade");
                alert.remove();
            }, 4000); 
            return alert;
        }

        // Percentage calculation functions
        function calculatePercentage() {
            const percentageInput = document.getElementById('percentageInput');
            const percentage = parseFloat(percentageInput.value);
            
            if (isNaN(percentage) || percentage < 0 || percentage > 100) {
                showAlert('Please enter a valid percentage between 0 and 100', 'warning');
                return;
            }
            
            const maxTotal = parseFloat('{{ proposal.remaining_amount }}');
            const calculatedAmount = (maxTotal * percentage) / 100;
            
            // Update the first item amount
            const firstItemAmount = document.getElementById('item1Amount');
            if (firstItemAmount) {
                firstItemAmount.value = calculatedAmount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            }
            
            // Update total
            updateTotal();
            
            showAlert(`Applied ${percentage}% of remaining budget`, 'success');
        }

        function applyPercentage(percentage) {
            const maxTotal = parseFloat('{{ proposal.total_proposal }}');
            const calculatedAmount = (maxTotal * percentage) / 100;
            
            // Update the first item amount
            const firstItemAmount = document.getElementById('item1Amount');
            if (firstItemAmount) {
                firstItemAmount.value = calculatedAmount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            }
            
            // Update total
            updateTotal();
            
            showAlert(`Applied ${percentage}% of remaining budget`, 'success');
        }

        // Calculator toggle function
        function toggleCalculator() {
            const panel = document.getElementById('calculatorPanel');
            const icon = document.querySelector('.calculator-icon');
            
            if (panel.style.display === 'none' || panel.style.display === '') {
                // Show calculator
                panel.style.display = 'block';
                panel.style.opacity = '0';
                setTimeout(() => {
                    panel.style.opacity = '1';
                }, 10);
                icon.style.backgroundColor = '#e9ecef';
            } else {
                // Hide calculator
                panel.style.opacity = '0';
                setTimeout(() => {
                    panel.style.display = 'none';
                }, 300);
                icon.style.backgroundColor = 'white';
            }
        }

        // Close calculator when clicking outside
        document.addEventListener('click', function(event) {
            const calculatorContainer = document.getElementById('calculatorContainer');
            const panel = document.getElementById('calculatorPanel');
            
            if (panel && panel.style.display !== 'none') {
                if (!calculatorContainer.contains(event.target)) {
                    panel.style.opacity = '0';
                    setTimeout(() => {
                        panel.style.display = 'none';
                    }, 300);
                    document.querySelector('.calculator-icon').style.backgroundColor = 'white';
                }
            }
        });
        
    </script>

{% endblock %}
