{% extends "base.html" %}
{% load static %}
{% block title %}{{ project.project_name }}{% endblock %}

<style>
.form-check-inline .form-check-input {
  margin-right: 0.25rem;
}

.form-check-inline .form-check-label {
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  transition: background-color 0.2s;
}

.form-check-inline .form-check-label:hover {
  background-color: rgba(0, 123, 255, 0.1);
}

.form-check-inline .form-check-input:checked + .form-check-label {
  background-color: rgba(0, 123, 255, 0.2);
  color: #007bff;
}

/* Status badge styles for Change Orders */
.status-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.status-draft { background-color: #f3f4f6; color: #374151; }
.status-pending { background-color: #fef3c7; color: #92400e; }
.status-approved { background-color: #d1fae5; color: #065f46; }
.status-rejected { background-color: #fee2e2; color: #991b1b; }
</style>

{% block content %}
{% load custom_filters %}

<div class="container d-flex flex-column justify-content-center my-4">
  <div id="alert-container"></div>
  <div class="row">
    <!-- Project Card -->
    {% include "components/project_card_detail.html" %}

    <div class="col-md-12 border border-warning border-opacity-25 border-4 rounded-4 p-3 position-relative mt-4">
      <h4 class="text-center bg-white rounded-4 px-3 py-1 mx-3 position-absolute top-0 start-0 translate-y-middle fw-bold border border-warning border-opacity-25 border-4" 
      style="transform: translateY(-50%) ">Sales Panel</h4>
        <!-- Project Budget -->
      <div class="col-md-12 mt-4">
        <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
          <div class="card-header d-flex justify-content-between p-3 border-bottom bg-gray">
            <h1 class="card-header fs-4 rounded-4">Budgets</h1>
            <a href="{% url 'new_budget' project.id %}" class="btn bg-primary text-light">
              <i class="bi bi-plus-circle text-light fs-6"></i> Add Budget
            </a>
          </div>
          <div class="card-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Budge ID</th>
                  <th>Date</th>
                  <th>Create by.</th>
                  <th>Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
              {% for budget in budgets %}
                  {% if budget.id in budgets_dict %}
                    <tr style="vertical-align: middle;"">
                      <td>
                        <i class="bi bi-caret-right text-light rounded-2 mx-2 p-1 drownIcon collapsed" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapse-{{ budget.latest_version.id }}" 
                        aria-expanded="false" 
                        aria-controls="collapse-{{ budget.latest_version.id }}"
                        id="drownIcon icon-{{ budget.latest_version.id }}"></i>
                        <a href="{% url 'view_budget' project.id budget.latest_version.id %}">{{ project.customer.id }}.{{ project.id }}.{{ budget.latest_version.id }}
                          {% include 'components/duplicate_button.html' with budget_id=budget.latest_version.id %}
                        </a>
                      
                      </td>
                      <td>{{ budget.latest_version.date_created|date:'M/d/Y' }}</td>
                      <td>{{ budget.latest_version.sales_advisor }}</td>
                      <td>{{ budget.latest_version.total_value|currency_usd }}</td>  
                      <td><span class="status-empty status-{{budget.latest_version.status}}">
                            {{ budget.latest_version.status }}
                          </span>
                          {% if budget.latest_version.status == 'rejected' %}
                              <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                  data-bs-title="The proposal has been rejected. You must edit or create a new budget to submit another proposal." 
                                  aria-label="Info" data-bs-original-title="Rejected Proposal">
                                  <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                              </a>
                          {% elif budget.latest_version.status == 'complete' %}
                              <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                  data-bs-title="The budget is complete and cannot be edited. This means that no more proposals can be created, as the current proposal has already been approved or is awaiting approval." 
                                  aria-label="Info" data-bs-original-title="Completed Budget">
                                  <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                              </a>
                          {% elif budget.latest_version.status == 'approved' %}
                              <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                  data-bs-title="The proposal is approved. No further edits or proposals can be made for this budget." 
                                  aria-label="Info" data-bs-original-title="Proposal Locked">
                                  <i class="bi bi-lock-fill" style="font-size: 15px;"></i>
                              </a>
                          {% elif budget.latest_version.status == 'saved' %}
                              <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                  data-bs-title="The budget is new, meaning no proposal has been created or sent to the client yet." 
                                  aria-label="Info" data-bs-original-title="New Budget">
                                  <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                              </a>
                          {% endif %}
                      <td style="width:80px">
                        <div class="d-inline-flex gap-2 align-items-center p-0">
                          {% if project.status == 'new' or project.status == 'contacted' or project.status == 'quoted_sent' %}
                          <a class="btn bg-light border border-2 btn-sm rounded-2 p-1 {% if budget.status == 'complete' or budget.status == 'approved' %}disabled{% endif %}" 
                          href="{% url 'edit_budget' project.id budget.latest_version.id %}" 
                          role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Edit">
                          <i class="bi bi-pencil-square" style="font-size: 15px;"></i>
                          </a>
                          {% else %}
                          <a class="btn bg-secondary text-white border border-2 btn-sm rounded-2 p-1" 
                          role="button" style="cursor: not-allowed;" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="You cannot edit the budget because the project is not in the new, contacted, or quoted_sent status.">
                          <i class="bi bi-pencil-square text-white" style="font-size: 15px;"></i>
                          </a>
                          {% endif %}
                          <a class="btn bg-light border border-2 btn-sm rounded-2 p-1" 
                          href="{% url 'view_budget' project.id budget.latest_version.id %}" 
                          role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Print">
                          <i class="bi bi-printer-fill" style="font-size: 15px;"></i>
                          </a>
                          {% if last_proposal_approved %}
                          <a class="btn bg-secondary text-light border border-2 btn-sm rounded-2 p-1" 
                          role="button" style="cursor: not-allowed;" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="You cannot make a proposal because the last proposal has already been approved.">
                          <i class="bi bi-receipt" style="font-size: 15px;"></i>
                          </a>
                          {% else %}
                          <a class="btn bg-success text-light border border-2 btn-sm rounded-2 p-1 {% if budget.latest_version.status == 'complete' or budget.latest_version.status == 'approved' or budget.latest_version.status == 'rejected' %}disabled{% endif %}" 
                          href="{% url 'view_budgetSimple' project.id budget.latest_version.id %}"
                          role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Make proposal">
                          <i class="bi bi-receipt" style="font-size: 15px;"></i>
                          </a>
                          {% endif %}
                      
                          <!-- Botón para Eliminar -->
                          {% if last_proposal_approved.budget.id != budget.latest_version.id %}
                            <a class="btn btn-danger btn-sm rounded-2 p-1 
                              {% if budget.latest_version.status == 'complete' or budget.latest_version.status == 'approved' %}disabled{% endif %}" 
                              href="{% url 'delete_budget' project.id budget.latest_version.id %}"                         
                              role="button" title="Delete Budget" 
                              data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" 
                              data-bs-custom-class="custom-tooltip" 
                              data-delete-action data-bs-title="Delete">
                                <i class="bi bi-trash" style="font-size: 15px;"></i>
                            </a>
                          {% else %}
                            <a class="btn bg-secondary text-light border border-2 btn-sm rounded-2 p-1" 
                            role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="You cannot delete the last proposal because it has already been approved.">
                            <i class="bi bi-trash" style="font-size: 15px;"></i>
                            </a>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                    <tr id="collapse-{{ budget.latest_version.id }}" class="collapse">
                      <td colspan="6" class="m-0 p-0">
                        <table class="table table-bordered">
                          <thead>
                            <tr>
                              <th class='p-0 text-secondary'></th>
                              <th class='p-0 text-secondary'>Budge ID</th>
                              <th class='p-0 text-secondary'>Date</th>
                              <th class='p-0 text-secondary'>Create by.</th>
                              <th class='p-0 text-secondary'>Amount</th>
                              <th class='p-0 text-secondary'>Version</th>
                              <th class='p-0 text-secondary'></th>
                            </tr>
                          </thead>
                          {% for related_id, budgets in budgets_dict.items %}
                            {% if budget.id == related_id %}
                              {% for budgetVersion in budgets.budget %}
                                <tr>
                                  <td  class='p-1'></td>
                                  <td  class='p-1'><a href="{% url 'view_budget' project.id budgetVersion.id %}">{{ project.customer.id }}.{{ project.id }}.{{ budgetVersion.id}}</a>
                                    {% include 'components/duplicate_button.html' with budget_id=budgetVersion.id %}
                                  </td>
                                  <td  class='p-1'>{{ budgetVersion.date_created }}</td>
                                  <td  class='p-1'>{{ budgetVersion.sales_advisor }}</td>
                                  <td  class='p-1'>{{ budgetVersion.total_value|currency_usd }}</td> 
                                  <td  class='p-1'>
                                    <span class="status-empty">
                                      {% if forloop.counter == 1 %}
                                          Last Version
                                      {% else %}
                                          Version {{ forloop.counter }}
                                      {% endif %}
                                    </span>
                                  </td>
                                  <td style="width:40px"  class='px-auto py-1'>
                                    <div class="d-inline-flex gap-2 ">
                                      <!-- Botón para Eliminar -->
                                      <a class="btn btn-danger btn-sm rounded-2 p-1" 
                                          href="{% url 'delete_budget' project.id budgetVersion.id %}" 
                                          role="button" title="Delete Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="Delete">
                                          <i class="bi bi-trash" style="font-size: 15px;"></i>
                                      </a>
                                    </div>
                                  </td>
                                </tr>
                              {% endfor %}
                              <tr>
                                <td  class='p-1'></td>
                                <td  class='p-1'><a href="{% url 'view_budget' project.id budget.id %}">{{ project.customer.id }}.{{ project.id }}.{{ budget.id }}
                                  {% include 'components/duplicate_button.html' with budget_id=budget.id %}
                                </a></td>
                                <td  class='p-1'>{{ budget.date_created }}</td>
                                <td  class='p-1'>{{ budget.sales_advisor }}</td>
                                <td  class='p-1'>{{ budget.total_value|currency_usd }}</td> 
                                <td  class='p-1'>
                                  <span class="status-empty">
                                    Principal
                                  </span>
                                  <a class="btn btn-sm rounded-2 p-1" 
                                  role="button" title="Delete Budget"
                                  data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Deleting this budget will delete all related budgets, as this is the primary budget.">
                                  <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                              </a>
                                </td>
                                <td style="width:40px"  class='px-auto py-1'>
                                  <div class="d-inline-flex gap-2 ">
                                    <!-- Botón para Eliminar -->
                                    <a class="btn btn-danger btn-sm rounded-2 p-1" 
                                        href="{% url 'delete_budget' project.id budget.id %}" 
                                        role="button" title="Delete Budget"
                                        data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="Delete">
                                        <i class="bi bi-trash" style="font-size: 15px;"></i>
                                    </a>
                                  </div>
                                </td>
                              </tr>
                            {% endif %}
                          {% endfor %}
                        </table>
                      </td>
                    </tr>
                  {% else %}
                  <tr style="vertical-align: middle;"">
                    <td class='align-items-center'><a href="{% url 'view_budget' project.id budget.id %}">{{ project.customer.id }}.{{ project.id }}.{{ budget.id }}
                      {% include 'components/duplicate_button.html' with budget_id=budget.id %}
                    </a></td>
                    <td>{{ budget.date_created }}</td>
                    <td>{{ budget.sales_advisor }}</td>
                    <td>{{ budget.total_value|currency_usd }}</td> 
                    <td>
                      <span class="status-empty status-{{budget.status}}">
                        {{ budget.status }}
                      </span>
                      {% if budget.status == 'rejected' %}
                              <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                  data-bs-title="The proposal has been rejected. You must edit or create a new budget to submit another proposal." 
                                  aria-label="Info" data-bs-original-title="Rejected Proposal">
                                  <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                              </a>
                          {% elif budget.status == 'complete' %}
                              <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                  data-bs-title="The budget is complete and cannot be edited. This means that no more proposals can be created, as the current proposal has already been approved or is awaiting approval." 
                                  aria-label="Info" data-bs-original-title="Completed Budget">
                                  <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                              </a>
                          {% elif budget.status == 'approved' %}
                              <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                  data-bs-title="The proposal is approved. No further edits or proposals can be made for this budget." 
                                  aria-label="Info" data-bs-original-title="Proposal Locked">
                                  <i class="bi bi-lock-fill" style="font-size: 15px;"></i>
                              </a>
                          {% elif budget.status == 'saved' %}
                              <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                  data-bs-title="The budget is new, meaning no proposal has been created or sent to the client yet." 
                                  aria-label="Info" data-bs-original-title="New Budget">
                                  <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                              </a>
                        {% endif %}
                    </td>
                    <td style="width:80px">
                      <div class="d-inline-flex gap-2 align-items-center p-0">
                        {% if project.status == 'new' or project.status == 'contacted' or project.status == 'quoted_sent' %}
                        <a class="btn bg-light border border-2 btn-sm rounded-2 p-1 {% if budget.status == 'complete' or budget.status == 'approved' %}disabled{% endif %}" 
                        href="{% url 'edit_budget' project.id budget.id %}" 
                        role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Edit">
                        <i class="bi bi-pencil-square" style="font-size: 15px;"></i>
                        </a>
                        {% else %}
                        <a class="btn bg-secondary text-light border border-2 btn-sm rounded-2 p-1" 
                        role="button" style="cursor: not-allowed;" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="You cannot edit the budget because the project is not in the new, contacted, or quoted_sent status.">
                        <i class="bi bi-pencil-square text-white" style="font-size: 15px;"></i>
                        </a>
                        {% endif %}
                        <a class="btn bg-light border border-2 btn-sm rounded-2 p-1" 
                        href="{% url 'view_budget' project.id budget.id %}"
                        role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Print">
                        <i class="bi bi-printer-fill" style="font-size: 15px;"></i>
                        </a>
                        {% if last_proposal_approved %}
                          <a class="btn bg-secondary text-light border border-2 btn-sm rounded-2 p-1" 
                          role="button" style="cursor: not-allowed;"  title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="You cannot make a proposal because the last proposal has already been approved.">
                          <i class="bi bi-receipt" style="font-size: 15px;"></i>
                          </a>
                        {% else %}
                          <a class="btn bg-success text-light border border-2 btn-sm rounded-2 p-1 {% if budget.status == 'complete' or budget.status == 'approved' or budget.status == 'rejected' %}disabled{% endif %}" 
                          href="{% url 'view_budgetSimple' project.id budget.id %}"
                          role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Make proposal">
                          <i class="bi bi-receipt" style="font-size: 15px;"></i>
                          </a>
                        {% endif %}
                        <!-- Botón para Eliminar -->
                        {% if last_proposal_approved.budget.id != budget.id %}
                        <a class="btn btn-danger btn-sm rounded-2 p-1 
                          {% if budget.status == 'complete' or budget.status == 'approved' %}disabled{% endif %}" 
                          href="{% url 'delete_budget' project.id budget.id %}"                         
                          role="button" title="Delete Budget" 
                          data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" 
                          data-bs-custom-class="custom-tooltip" 
                          data-delete-action data-bs-title="Delete">
                            <i class="bi bi-trash" style="font-size: 15px;"></i>
                        </a>
                        {% else %}
                        <a class="btn bg-secondary text-light border border-2 btn-sm rounded-2 p-1" 
                        role="button" style="cursor: not-allowed;" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="You cannot delete this budget because it is the reference of the last proposal approved.">
                        <i class="bi bi-trash" style="font-size: 15px;"></i>
                        </a>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endif %}
              {% empty %}
                <tr>
                  <td colspan="5">No proposals found for this project.</td>
                </tr>
              {% endfor %}
              
              
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Project proposal -->
      <div class="col-md-12 mt-4">
        <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
          <div class="card-header d-flex justify-content-between p-3 border-bottom bg-gray">
            <h1 class="card-header fs-4 rounded-4">Proposals</h1>
          </div>
          <div class="card-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Proposal ID</th>
                  <th>Budget ID</th>
                  <th>Date</th>
                  <th>Due Date</th>
                  <th>Tracking ID</th>
                  <th>Create by</th>
                  <th>Status</th>
                  <th>Amount</th>
                  <th>Billed</th>
                </tr>
              </thead>
              <tbody>
                {% for proposal in proposals %}
                <tr style="vertical-align: middle;">
                  <td>{{ proposal.id }}</td>
                  <td>{{ proposal.budget.id }}</td>
                  <td>{{ proposal.date_created | date:'M/d/y' }}</td>
                  <td>{{ proposal.due_date | date:'M/d/y' }}</td>
                  <td>{{ proposal.tracking_id }}</td>
                  <td>{{ proposal.sales_advisor.username }}</td>
                  <td class="d-flex"> 
                    <form method="post" class='m-0'>
                      {% csrf_token %}
                      <input type="hidden" name="proposal_id" value="{{ proposal.id }}" style='display:none'>
                      <input type="hidden" name="budget_id" value="{{ proposal.budget.id }}" style='display:none'>
                      <select name="status" 
                      {% if last_proposal_approved and proposal.id != last_proposal_approved.id %}
                        disabled  
                        class="bg-secondary bg-opacity-25 border border-secondary border-2 text-secondary rounded-pill px-2" 
                          style="cursor: not-allowed; font-size: 14px;" 
                        {% elif proposal.status == 'approved' and project.accounting_manager %}
                        disabled 
                        class="status status-{{ proposal.status }}" 
                        style="cursor: not-allowed; font-size: 14px;" 
                      {% else %} 
                        onchange="this.form.submit()" 
                        class="status status-{{ proposal.status }}" {% endif %}>
                        {% for value, label in proposal.STATUS_CHOICES %}
                          <option value="{{ value }}" {% if proposal.status == value %}selected{% endif %}>
                            {{ label }}
                          </option>
                        {% endfor %}
                      </select>
                    </form>
                    {% if last_proposal_approved and proposal.id != last_proposal_approved.id %}
                    <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="Already approved proposal, you cannot change its status. <strong class='text-danger bg-light'>If you dont neeed this proposal, you can delete it.</strong>" 
                          aria-label="Info" data-bs-original-title="Last Approved Proposal">
                          <i class="bi bi-info-circle text-warning" style="font-size: 15px;"></i>
                      </a>
                    {% elif proposal.status == 'approved' and project.accounting_manager %}
                    <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="You cannot change the status of this proposal because this is used in production or planning and documentation." 
                          aria-label="Info" data-bs-original-title="Last Approved Proposal">
                          <i class="bi bi-info-circle text-warning" style="font-size: 15px;"></i>
                      </a>
                    {% elif proposal.status == 'new' %}
                        <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                            data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                            data-bs-title="The proposal is new. You cannot create an invoice for it." 
                            aria-label="Info" data-bs-original-title="New Proposal">
                            <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                        </a>
                    {% elif proposal.status == 'sent' %}
                        <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                            data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                            data-bs-title="The proposal has been sent. It cannot be deleted or have an invoice created." 
                            aria-label="Info" data-bs-original-title="Sent Proposal">
                            <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                        </a>
                    {% elif proposal.status == 'pending' %}
                        <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                            data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                            data-bs-title="The proposal is pending. It cannot be deleted or have an invoice created." 
                            aria-label="Info" data-bs-original-title="Pending Proposal">
                            <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                        </a>
                    {% elif proposal.status == 'approved' %}
                        <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                            data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                            data-bs-title="The proposal is approved. It cannot be deleted, but you can create an invoice for it." 
                            aria-label="Info" data-bs-original-title="Approved Proposal">
                            <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                        </a>
                    {% elif proposal.status == 'rejected' %}
                        <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                            data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                            data-bs-title="The proposal has been rejected. It can be deleted, but you cannot create an invoice for it." 
                            aria-label="Info" data-bs-original-title="Rejected Proposal">
                            <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                        </a>
                    {% endif %}
                  </td>
                  <td>{{proposal.total_proposal | currency_usd }}</td>
                  <td>{{ proposal.billed_proposal | currency_usd }}</td>
                  <td style='width:120px' class="p-0">
                    <div class="d-inline-flex gap-2 align-items-center p-1">
                    <a class="btn bg-light border border-2 btn-sm rounded-2" 
                    href="{% url 'pdf_proposal' project_id=project.id proposal_id=proposal.id %}" target='_blank'
                    role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="View">
                    <i class="bi bi-eye-fill" style="font-size: 15px;"></i>
                    </a>
                    <a class="btn bg-light border border-2 btn-sm rounded-2 d-none" 
                    href="{% url 'cost_breakdown' project_id=project.id proposal_id=proposal.id %}" target='_blank'
                    role="button" title="Cost Breakdown" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Cost Breakdown">
                    <i class="bi bi-pie-chart" style="font-size: 15px;"></i>
                    </a>
                    {% if proposal.status == 'new' or proposal.status == 'sent' or proposal.status == 'pending' or proposal.status == 'rejected' %}
                      <a class="btn bg-light border border-2 btn-sm rounded-2" 
                      href="{% url 'edit_budgetSimple' project_id=project.id budget_id=proposal.budget.id proposal_id=proposal.id %}" target='_blank'
                      role="button" title="Edit Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Edit">
                      <i class="bi bi-pencil-square" style="font-size: 15px;"></i>
                      </a>
                    {% endif %}
                    <div class="dropdown d-flex d-none">
                      <button 
                        class="btn bg-light border border-2 btn-sm rounded-2 px-1 py-0 dropdown-toggle  {% if proposal.status == 'new' or proposal.status == 'sent' or proposal.status == 'pending'  or proposal.status == 'rejected' or  proposal.total_proposal <=  proposal.billed_proposal %}disabled{% endif %}" 
                        type="button" 
                        id="dropdownMenuButton" 
                        data-bs-toggle="dropdown" 
                        aria-expanded="false" 
                        title="Make Budget" 
                        data-bs-toggle="tooltip" 
                        data-bs-placement="bottom" 
                        data-bs-custom-class="custom-tooltip" 
                        data-bs-title="Make invoice">
                        <i class="bi bi-cash-stack" style="font-size: 15px;"
                        > </i>
                      </button class='p-0'>
                      <ul class="dropdown-menu p-0" aria-labelledby="dropdownMenuButton">
                        <li><a class="dropdown-item" href="{% url 'mdcpInvoice' project_id=project.id invoice_id=proposal.id %}" target='_blank'>Invoice MDCP</a></li>
                        <li><a class="dropdown-item" href="{% url 'broadInvoice10' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice BROD</a></li>
                        <li><a class="dropdown-item" href="{% url 'aiaInvoice5' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice AIA 5%</a></li>
                        <li><a class="dropdown-item" href="{% url 'aiaInvoice10' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice AIA 10%</a></li>
                      </ul>
                      {% if proposal.status == 'new' or proposal.status == 'sent' or proposal.status == 'pending'  or proposal.status == 'rejected' %}
                      <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="Invoice creation is disabled because the proposal is in Pending, New, Rejected, or Sent status." 
                          aria-label="Info" data-bs-original-title="Rejected Proposal">
                          <i class="bi bi-info-circle text-danger" style="font-size: 15px;"></i>
                      </a>
                      {% elif  proposal.total_proposal <=  proposal.billed_proposal %}
                      <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="You cannot add more invoices because the total of the proposal has already been invoiced." 
                          aria-label="Info" data-bs-original-title="Rejected Proposal">
                          <i class="bi bi-info-circle text-success" style="font-size: 15px;"></i>
                      </a>
                      
                      {% endif %}
                    </div>


                    {% if proposal.status == 'approved' or proposal.status == 'sent' or proposal.status == 'pending' %}
                      <a class="btn border border-2 btn-sm rounded-2 bg-secondary text-light" 
                      role="button" style="cursor: not-allowed;" title="Send proposal to email client" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="You cannot send this proposal to email client because it is in Pending, Approved, or Sent status.">
                      <i class="bi bi bi-trash" style="font-size: 15px;"></i>
                      </a>
                    {% else %}
                    <a class="btn btn-danger btn-sm rounded-2 p-1 border border-2 boder-secondary" 
                      href="{% url 'delete_proposal' project.id proposal.id %}"
                      role="button" title="Delete Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="Delete">
                      <i class="bi bi-trash" style="font-size: 15px;"></i>
                    </a>
                    {% endif %}
                    {% if proposal.status == 'approved' %}
                      {% if not changes_orders %}
                          <a class="btn btn-sm rounded-2 p-1 bg-warning fw-bold" role="button" data-bs-toggle="tooltip" 
                            data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                            data-bs-title="<strong class='bg-warning text-dark'> Change order </strong> requested by the client after approval, modifying scope, cost, or timeline."
                            aria-label="Info" data-bs-original-title="Approved Proposal"
                            href="{% url 'new_change_order' project.id proposal.id %}">
                            C.O.
                        </a>
                      {% else %}
                        <a class="btn btn-sm rounded-2 p-1 bg-secondary text-light fw-bold" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="<strong class='bg-secondary text-light'> Change order </strong> requested by the client after approval, modifying scope, cost, or timeline. You cannot create a new change order because there is already one."
                          aria-label="Info" data-bs-original-title="Approved Proposal"
                          style="cursor: not-allowed; font-size: 11px;">
                          C.O.
                        </a>
                      {% endif %}
                    {% endif %}
                </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="9">No proposals found for this project.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
          </div>
      
      </div>
      <!-- Change Order -->
      {% if changes_orders %}
      <div class="col-md-12 mt-4">
        <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
          <div class="card-header d-flex justify-content-between p-3 border-bottom bg-warning" style="--bs-bg-opacity: .2;">
            <h1 class="card-header fs-4 rounded-4 px-2"  style="--bs-bg-opacity: .1;">Change Order</h1> 
            {% if not are_changes_orders_draft %}
              <a class="btn btn-light border border-2 btn-sm rounded-2" href="{% url 'new_change_order' project.id last_proposal_approved.id %}"> + New Change Order</a>
            {% else %}
              <a class="btn bg-secondary text-light border border-2 btn-sm rounded-2" 
                 disabled role="button" data-bs-toggle="tooltip"
                 data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                 data-bs-title="Cannot create new Change Order while there are existing Change Orders in draft, pending, or sent status"
                 aria-label="Info" data-bs-original-title="Approved Proposal"
                 style="cursor: not-allowed;">
                 + New Change Order
              </a>
            {% endif %}
          </div>
          <div class="card-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Budget ID</th>
                  <th>Date</th>
                  <th>Create by</th>
                  <th>Last value</th>
                  <th>New value</th>
                  <th>Status</th>
                  <th>Total Change</th>
                </tr>
              </thead>
              <tbody>
                {% for budget in changes_orders %}
                <tr style="vertical-align: middle;">
                  <td>{{ budget.id_related_budget_id }}</td>
                  <td>{{ budget.date_created | date:'M/d/y' }}</td>
                  <td>{{ budget.sales_advisor.username }}</td>
                  <td>{{ budget.id_related_total_value | currency_usd}}</td>
                  <td>{{ budget.total_value | currency_usd}}</td>
                 <td>
                   {% if budget.change_order_detail %}
                     {% if budget.change_order_detail.status == 'approved' and not forloop.last %}
                       <!-- Si este Change Order está aprobado y no es el último, mostrar solo el status sin poder cambiar -->
                       <span class="status-empty status-{{ budget.change_order_detail.status }}">
                         {% if budget.change_order_detail.status == 'draft' %}Draft
                         {% elif budget.change_order_detail.status == 'pending' %}Pending
                         {% elif budget.change_order_detail.status == 'approved' %}Approved
                         {% elif budget.change_order_detail.status == 'rejected' %}Rejected
                         {% else %}{{ budget.change_order_detail.status|title }}{% endif %}
                       </span>
                     {% else %}
                       <!-- Si este Change Order no está aprobado o es el último, permitir cambiar status -->
                       <select class="change-order-status status-empty status-{{ budget.change_order_detail.status }}"
                               data-budget-id="{{ budget.id }}" 
                               data-change-order-id="{{ budget.change_order_detail.id }}"
                               style="min-width: 120px; font-size: 0.875rem;">
                         <option value="draft" {% if budget.change_order_detail.status == 'draft' %}selected{% endif %}>Draft</option>
                         <option value="pending" {% if budget.change_order_detail.status == 'pending' %}selected{% endif %}>Pending</option>
                         <option value="approved" {% if budget.change_order_detail.status == 'approved' %}selected{% endif %}>Approved</option>
                         <option value="rejected" {% if budget.change_order_detail.status == 'rejected' %}selected{% endif %}>Rejected</option>
                       </select>
                     {% endif %}
                   {% else %}
                     <span class="status-empty status-draft">Draft</span>
                   {% endif %}
                 </td> 
                  <td>
                    <span class="status title_budget{% if budget.total_change_order < 0 %}Down{% else %}Up{% endif %}">
                      <i class="bi bi-graph-{% if budget.total_change_order < 0 %}down{% else %}up{% endif %}-arrow fs-6"></i>
                        {{ budget.total_change_order | currency_usd}}
                    <span>
                  </td>
                  <td style="width:80px">
                    <div class="d-inline-flex gap-2 align-items-center p-0">
                      <a class="btn bg-light border border-2 btn-sm rounded-2 p-1" 
                      href="{% url 'view_changeOrder' project.id budget.id %}" 
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="View">
                      <i class="bi bi-eye-fill" style="font-size: 15px;"></i>
                      </a>
                      <a class="btn bg-light border border-2 btn-sm rounded-2 p-1 d-none" 
                      href="{% url 'edit_budget' project.id budget.id %}" 
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Edit Budget">
                      <i class="bi bi-pencil-square" style="font-size: 15px;"></i>
                      </a>
                      <a class="btn bg-light border border-2 btn-sm rounded-2 p-1 d-none" 
                      href="{% url 'view_budget' project.id budget.id %}"
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Print">
                      <i class="bi bi-printer-fill" style="font-size: 15px;"></i>
                      </a>
                      {% if budget.change_order_detail.status == 'approved' and not forloop.last %}
                        <!-- Si hay un Change Order aprobado y este no es el aprobado, deshabilitar el botón de eliminar -->
                        <a class="btn btn-secondary btn-sm rounded-2"
                          href="#"                         
                          role="button" 
                          title="Cannot delete Change Order when there is an approved Change Order" 
                          data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" 
                          data-bs-custom-class="custom-tooltip" 
                          data-bs-title="Cannot delete Change Order when there is an approved Change Order"
                          disabled>
                          <i class="bi bi-trash" style="font-size: 15px;"></i>
                        </a>
                      {% else %}
                        <!-- Si no hay Change Order aprobado o este es el aprobado, permitir eliminar -->
                        <a class="btn btn-danger btn-sm rounded-2"
                          href="{% url 'delete_budget' project.id budget.id %}"                         
                          role="button" title="Delete Budget" 
                          data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" 
                          data-bs-custom-class="custom-tooltip" 
                          data-delete-action data-bs-title="Delete">
                          <i class="bi bi-trash" style="font-size: 15px;"></i>
                        </a>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="8">No changes orders  found for this project.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
    </div>   
      {% endif %}
      <!-- Change Order Proposals -->
      {% if change_order_proposals %}
        <div class="col-md-12 mt-4">
          <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
            <div class="card-header d-flex justify-content-between p-3 border-bottom bg-dark">
              <h1 class="card-header fs-4 rounded-4 px-2">Change Order Proposals</h1>
            </div>
            <div class="card-body">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Proposal ID</th>
                    <th>Budget ID</th>
                    <th>Date</th>
                    <th>Due Date</th>
                    <th>Tracking ID</th>
                    <th>Create by</th>
                    <th>Status</th>
                    <th>Amount</th>
                    <th>Billed</th>
                  </tr>
                </thead>
                <tbody>
                  {% for proposal in change_order_proposals %}
                  <tr style="vertical-align: middle;">
                    <td>{{ proposal.id }}</td>
                    <td>{{ proposal.budget.id }}</td>
                    <td>{{ proposal.date_created | date:'M/d/y' }}</td>
                    <td>{{ proposal.due_date | date:'M/d/y' }}</td>
                    <td>{{ proposal.tracking_id }}</td>
                    <td>{{ proposal.sales_advisor.username }}</td>
                    <td class="d-flex"> 
                      <form method="post" class='m-0'>
                        {% csrf_token %}
                        <input type="hidden" name="proposal_id" value="{{ proposal.id }}" style='display:none'>
                        <input type="hidden" name="budget_id" value="{{ proposal.budget.id }}" style='display:none'>
                        <select name="status" class="status status-{{ proposal.status }}" onchange="this.form.submit()">
                          {% for value, label in proposal.STATUS_CHOICES %}
                            <option value="{{ value }}" {% if proposal.status == value %}selected{% endif %}>
                              {{ label }}
                            </option>
                          {% endfor %}
                        </select>
                      </form>
                      {% if proposal.status == 'new' %}
                          <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="The proposal is new. You cannot create an invoice for it." 
                              aria-label="Info" data-bs-original-title="New Proposal">
                              <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                          </a>
                      {% elif proposal.status == 'sent' %}
                          <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="The proposal has been sent. It cannot be deleted or have an invoice created." 
                              aria-label="Info" data-bs-original-title="Sent Proposal">
                              <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                          </a>
                      {% elif proposal.status == 'pending' %}
                          <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="The proposal is pending. It cannot be deleted or have an invoice created." 
                              aria-label="Info" data-bs-original-title="Pending Proposal">
                              <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                          </a>
                      {% elif proposal.status == 'approved' %}
                          <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="The proposal is approved. It cannot be deleted, but you can create an invoice for it." 
                              aria-label="Info" data-bs-original-title="Approved Proposal">
                              <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                          </a>
                      {% elif proposal.status == 'rejected' %}
                          <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="The proposal has been rejected. It can be deleted, but you cannot create an invoice for it." 
                              aria-label="Info" data-bs-original-title="Rejected Proposal">
                              <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                          </a>
                      {% endif %}
                    </td>
                    <td>{{ proposal.total_proposal | currency_usd }}</td>
                    <td>{{ proposal.billed_proposal | currency_usd }}</td>
                    <td style='width:120px' class="p-0">
                      <div class="d-inline-flex gap-2 align-items-center p-1">
                      <a class="btn bg-light border border-2 btn-sm rounded-2" 
                      href="{% url 'pdf_proposal' project_id=project.id proposal_id=proposal.id %}" target='_blank'
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="View">
                      <i class="bi bi-eye-fill" style="font-size: 15px;"></i>
                      </a>
                      <a class="btn bg-light border border-2 btn-sm rounded-2" 
                      href="{% url 'cost_breakdown' project_id=project.id proposal_id=proposal.id %}" target='_blank'
                      role="button" title="Cost Breakdown" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Cost Breakdown">
                      <i class="bi bi-pie-chart" style="font-size: 15px;"></i>
                      </a>
                      <div class="dropdown d-flex">
                        <button 
                          class="btn bg-light border border-2 btn-sm rounded-2 px-1 py-0 dropdown-toggle  {% if proposal.status == 'new' or proposal.status == 'sent' or proposal.status == 'pending'  or proposal.status == 'rejected' or  proposal.total_proposal <=  proposal.billed_proposal %}disabled{% endif %}" 
                          type="button" 
                          id="dropdownMenuButton" 
                          data-bs-toggle="dropdown" 
                          aria-expanded="false" 
                          title="Make Budget" 
                          data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" 
                          data-bs-custom-class="custom-tooltip" 
                          data-bs-title="Make Proposal">
                          <i class="bi bi-cash-stack" style="font-size: 15px;"
                          > </i>
                        </button class='p-0'>
                        <ul class="dropdown-menu p-0" aria-labelledby="dropdownMenuButton">
                          <li><a class="dropdown-item" href="{% url 'mdcpInvoice' project_id=project.id invoice_id=proposal.id %}" target='_blank'>Invoice MDCP</a></li>
                          <li><a class="dropdown-item" href="{% url 'broadInvoice10' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice BROD</a></li>
                          <li><a class="dropdown-item" href="{% url 'aiaInvoice5' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice AIA 5%</a></li>
                          <li><a class="dropdown-item" href="{% url 'aiaInvoice10' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice AIA 10%</a></li>
                        </ul>
                        {% if proposal.status == 'new' or proposal.status == 'sent' or proposal.status == 'pending'  or proposal.status == 'rejected' %}
                        <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                            data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                            data-bs-title="Invoice creation is disabled because the proposal is in Pending, New, Rejected, or Sent status." 
                            aria-label="Info" data-bs-original-title="Rejected Proposal">
                            <i class="bi bi-info-circle text-danger" style="font-size: 15px;"></i>
                        </a>
                        {% elif  proposal.total_proposal <=  proposal.billed_proposal %}
                        <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                            data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                            data-bs-title="You cannot add more invoices because the total of the proposal has already been invoiced." 
                            aria-label="Info" data-bs-original-title="Rejected Proposal">
                            <i class="bi bi-info-circle text-success" style="font-size: 15px;"></i>
                        </a>
                        
                        {% endif %}
                      </div>
                      
                      <a class="btn btn-danger btn-sm rounded-2 p-1 {% if proposal.status == 'approved' or proposal.status == 'sent' or proposal.status == 'pending' %}disabled{% endif %}" 
                        href="{% url 'delete_proposal' project.id proposal.id %}"
                        role="button" title="Delete Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="Delete">
                        <i class="bi bi-trash" style="font-size: 15px;"></i>
                      </a>
                      {% if proposal.status == 'approved' %}

                          <a class="btn btn-sm rounded-2 p-1 bg-warning fw-bold" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip"    
                              data-bs-title="<strong class='bg-warning text-dark> Change order </strong> requested by the client after approval, modifying scope, cost, or timeline."
                              aria-label="Info" data-bs-original-title="Approved Proposal"
                              href="{% url 'new_change_order' project.id proposal.id %}">
                              C.O.
                          </a>
                        {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="9">No proposals found for this project.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Collaborators Section -->
      {% if is_owner or is_admin  %}
      {% if collaborators.count > 0 %}
      <div class="col-md-12 mt-4">
        <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
          <div class="card-header d-flex justify-content-between p-3 border-bottom bg-info bg-opacity-25">
            <h1 class="card-header fs-4 rounded-4 px-2">Collaborators</h1>
            <span class="badge bg-light text-dark">{{ collaborators.count }} Collaborator{{ collaborators.count|pluralize }}</span>
          </div>
          <div class="card-body p-4">
            {% if collaborators %}
              <div class="row">
                {% for collaborator in collaborators %}
                <div class="col-md-6 col-lg-4 mb-3">
                  <div class="card border-info">
                    <div class="card-body">
                      <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                          <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <span class="fw-bold">{{ collaborator.first_name|first }}{{ collaborator.last_name|first }}</span>
                          </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                          <h6 class="mb-1">{{ collaborator.get_full_name }}</h6>
                          <small class="text-muted">{{ collaborator.email }}</small>
                        </div>
                        {% if is_owner %}
                        <div class="flex-shrink-0">
                          <button class="btn btn-danger btn-sm" 
                                  onclick="removeCollaborator({{ collaborator.id }})"
                                  title="Remove Collaborator">
                            <i class="bi bi-person-x"></i>
                          </button>
                        </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-center text-muted py-4">
                <i class="bi bi-people fs-1"></i>
                <p class="mt-2">No collaborators yet</p>
                <small>Collaboration requests will appear here when approved.</small>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Collaboration Requests Section -->
      {% if collaboration_requests %}
      <div class="col-md-12 mt-4">
        <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
          <div class="card-header d-flex justify-content-between p-3 border-bottom bg-opacity-25">
            <h1 class="card-header fs-4 rounded-4 px-2">Pending Collaboration Requests</h1>
            <span class="badge bg-light text-dark">{{ collaboration_requests.count }} Request{{ collaboration_requests.count|pluralize }}</span>
          </div>
          <div class="card-body">
            {% for request in collaboration_requests %}
            <div class="card border-warning mb-3">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                      <span class="fw-bold">{{ request.requester.first_name|first }}{{ request.requester.last_name|first }}</span>
                    </div>
                    <div>
                      <h6 class="mb-1">{{ request.requester.get_full_name }}</h6>
                      <small class="text-muted">{{ request.requester.email }}</small>
                      <br>
                      <small class="text-muted">Requested on: {{ request.date_created|date:"M d, Y H:i" }}</small>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" onclick="respondToRequest({{ request.id }}, 'approve')">
                      <i class="bi bi-check-lg"></i> Approve
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="respondToRequest({{ request.id }}, 'reject')">
                      <i class="bi bi-x-lg"></i> Reject
                    </button>
                  </div>
                </div>
                {% if request.message %}
                <div class="mt-3">
                  <strong>Message:</strong>
                  <p class="mb-0 text-muted">{{ request.message }}</p>
                </div>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
      {% endif %}

      </div>
  </div>
  {% if user.groups.first.name == 'ADMIN' %}
  <div class="col-md-12 border border-success border-opacity-25 border-4 rounded-4 p-3 position-relative mt-5">
    {% if not project.accounting_manager %}
      {% include "components/block_panel.html" %}
    {% endif %}
    <h4 class="text-center bg-white rounded-4 px-3 py-1 mx-3 position-absolute top-0 start-0 translate-y-middle fw-bold border border-success border-opacity-25 border-4" 
    style="transform: translateY(-50%) "> Planning and Accounting Panel 
    {% if not project.accounting_manager %} 
      {% include "components/tooltip_element.html" with title="No available"  description="First, you need to assign an accounting manager to the project." icon="bi-info-circle" size=15 type="warning"  %}
    {% endif %}
    </h4>
      <!-- Project Invoices -->
      <div class="col-md-12 mt-4">
        <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
          <div class="card-header d-flex justify-content-between p-3 border-bottom bg-gray">
            <h1 class="card-header fs-4 rounded-4 d-flex align-items-center gap-2 flex-row w-100 justify-content-between">Invoice
              {% if project.accounting_manager %}
              <div class="dropdown d-flex align-items-center">
                {% if last_proposal_approved.billed_proposal != last_proposal_approved.total_proposal %}
                <button class="btn bg-primary text-white border border-2 btn-sm rounded-2 px-2 py-1 dropdown-toggle fs-6" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" title="Make Budget" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Make invoice">
                  <i class="bi bi-cash-stack text-white fs-6"> </i>  Add Invoice
                </button>
                  <ul class="dropdown-menu p-0" aria-labelledby="dropdownMenuButton">
                    <li><a class="dropdown-item" href="/projects/{{project.id}}/mdcpInvoice/{{last_proposal_approved.id}}" >Invoice MDCP</a></li>
                    <li><a class="dropdown-item" href="/projects/{{project.id}}/broadInvoice10/{{last_proposal_approved.id}}" >Invoice BROD</a></li>
                    <li><a class="dropdown-item" href="/projects/{{project.id}}/aiaInvoice5/{{last_proposal_approved.id}}" >Invoice AIA 5%</a></li>
                    <li><a class="dropdown-item" href="/projects/{{project.id}}/aiaInvoice10/{{last_proposal_approved.id}}" >Invoice AIA 10%</a></li>
                  </ul>
                {% else %}
                <button class="btn bg-secondary text-white border border-2 btn-sm rounded-2 px-2 py-1 dropdown-toggle fs-6" type="button" style="cursor: not-allowed;"  disabled>
                  <i class="bi bi-cash-stack text-white fs-6"> </i>  Add Invoice
                </button>
                <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                    data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                    data-bs-title="You cannot add more invoices because the total of the proposal has already been invoiced." 
                    aria-label="Info" data-bs-original-title="Rejected Proposal">
                    <i class="bi bi-info-circle text-secondary fs-" style="font-size: 15px;"></i>
                </a>
                {% endif %}
              </div>
              {% endif %}
             </h1>
          </div>
          <div class="card-body">
            <table class="table table-striped bgwarning">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Budget ID</th>
                  <th>Type</th>
                  <th>Date</th>
                  <th>Due Date</th> 
                  <th>Create by</th>
                  <th>Status</th>
                  <th>Amount</th>
                  <th>Paid</th>
                </tr>
              </thead>
              <tbody>
                {% for invoice in invoices %}
                <tr>
                  <td>{{ invoice.id }}</td>
                  <td>{{ invoice.budget.id }}</td>
                  <td>{{ invoice.type_invoice }}</td>
                  <td>{{ invoice.date_created | date:'M/d/y' }}</td>
                  <td>{{ invoice.due_date | date:'M/d/y' }}</td>
                  <td>{{ invoice.sales_advisor.username }}</td>
                  <td> 
                    <form method="post" class='m-0'>
                      {% csrf_token %}
                      <input type="hidden" name="invoice_id" value="{{ invoice.id }}" style='display:none'>
                    
                      <select name="status" class="status status-empty status_{{   invoice.status }}" onchange="this.form.submit()">
                        {% for value, label in invoice.STATUS_CHOICES %}
                          <option value="{{ value }}" {% if invoice.status == value %}selected{% endif %}>
                            {{ label }}
                          </option>
                        {% endfor %}
                      </select>
                    </form>
                  </td>
                  <td>{{ invoice.total_invoice | currency_usd }} ({{ invoice.percentage_of_proposal }}%)</td>
                  <td>
                    {{ invoice.total_paid | currency_usd }} ({{ invoice.percentage_paid }}%) 
                    {% if is_superuser_or_admin_or_accounting_manager %}
                      {% if invoice.total_paid == 0 %}
                        <button class="btn btn-success btn-sm" onclick="openPaymentModal('{{ invoice.id }}', '{{invoice.total_paid}}', '{{invoice.total_invoice}}')" title="Attach Payment" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Attach payment">
                          <i class="bi bi-wallet"></i>
                        </button>
                      {% elif invoice.total_paid <  invoice.total_invoice %}
                        <button class="btn btn-primary btn-sm" onclick="openPaymentModal('{{ invoice.id }}', '{{invoice.total_paid}}', '{{invoice.total_invoice}}')" title="Edit Payment" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Add payment">
                          <i class="bi bi-plus"></i>
                        </button>
                      {% endif %}
                    {% endif %}
                    {% if invoice.payments.all %}
                      <button class="btn btn-link p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#payments-{{ invoice.id }}" aria-expanded="false" aria-controls="payments-{{ invoice.id }}">
                        <i class="bi bi-chevron-down"></i> Payments
                      </button>
                    {% endif %}
                  </td>
                  <td style='width:80px'>
                    <div class="d-inline-flex gap-2 ">
                    <a class="btn bg-light border border-2 btn-sm rounded-2 p-1" 
                    href="{% url 'view_invoice' project_id=project.id invoice_id=invoice.id %}" 
                    role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="View">
                    <i class="bi bi-eye-fill" style="font-size: 15px;"></i>
                  </a>
                  {% if is_superuser_or_admin_or_accounting_manager %}
                    <a class="btn btn-sm rounded-2 p-1 bg-secondary text-white" style="cursor: not-allowed;" 
                      role="button" title="Delete Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="you cannot delete an invoice that has been paid.">
                      <i class="bi bi-trash" style="font-size: 15px;"></i>
                    </a>
                  {% else %}
                    <a class="btn btn-sm rounded-2 p-1 bg-danger text-white" 
                      href="{% url 'delete_invoice' project.id invoice.id %}"
                      role="button" title="Delete Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="Delete">
                      <i class="bi bi-trash" style="font-size: 15px;"></i>
                    </a>
                  {% endif %}
                </td>
                </tr>
                {% if invoice.payments.all %}
                <tr class="collapse" id="payments-{{ invoice.id }}">
                  <td colspan="11">
                    <div class="p-2 border rounded bg-light">
                      <strong>Payments:</strong>
                      <ul class="list-group list-group-flush">
                        {% for payment in invoice.payments.all %}
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ payment.date|date:"M/d/y H:i" }} - {{ payment.amount|currency_usd }}
                            <span>{{ payment.payment_method }}</span>
                            {% if payment.description %}<span class="ms-2 text-muted">{{ payment.description }}</span>{% endif %}
                            <a href="{% url 'view_payment_receipt' payment.id %}" class="btn btn-outline-primary btn-sm ms-2" target="_blank" title="View Receipt">
                              <i class="bi bi-receipt"></i> View Receipt
                            </a>
                          </li>
                        {% empty %}
                          <li class="list-group-item">No payments registered.</li>
                        {% endfor %}
                      </ul>
                    </div>
                  </td>
                </tr>
                {% endif %}
                {% empty %}
                <tr>
                  <td colspan="9">No invoices found for this project.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% include "components/checklist_documents.html" %}
  </div>    
    {% if project.status == 'in_production' %}
      <a class="btn btn-success my-3 d-flex justify-content-end align-items-center fw-bold fs-3 px-4" style="width: fit-content; margin-left: auto;" href="/production/{{project.id }}"> Go to panel of production <i class="bi bi-arrow-right ms-2"></i></a>
    {% endif %}
  {% endif %}
    {% include "components/documents_projects.html" %}
    {% include "components/emails_sent_to_client.html" %}
    {% include "modal_delete.html" %}
    {% include "components/modals_detail_projects.html" with project=project %}
<div id="loadingOverlay"  class="containerLoading d-none" >
  <img src="{% static 'img/loading.gif' %}" alt="Cargando" class="img-fluid rounded-1" style="width: 100px; height: auto;">
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
<script src="{% static 'js/components/documents_projects.js' %}"></script>
<script type="text/javascript">
  

document.getElementById('button-delete-project').addEventListener('click', function() {
    const userConfirmed = window.confirm('Are you sure you want to delete this project?');

    if (userConfirmed) {

      const projectId = this.getAttribute('data-id');
      const folderRootValue = document.getElementById("document-list").getAttribute("data-folder-root");
      let url = `/projects/${projectId}/delete_project/`;  // URL base
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.classList.remove('d-none');
      if (folderRootValue) {
        url += folderRootValue;
      }
      fetch(url, {
        method: 'GET', 
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (response.ok) {
          alert('Proyecto eliminado correctamente');
          window.location.href = '/projects/';
        } else {
          alert('Error al eliminar el proyecto');
          loadingOverlay.classList.add('d-none');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Hubo un problema con la eliminación del proyecto');  
        loadingOverlay.classList.add('d-none');
      });}
    });


function updateFolderName(folderId, newFolderName) {
  const formData = new FormData();
  formData.append('folder_id', folderId);
  formData.append('new_folder_name', newFolderName);
  const folderElement = document.getElementById(`folder-name-${folderId}`);
  const spinner = document.createElement('div');
  spinner.className = 'spinner-border spinner-border-sm text-primary'; // Puedes elegir otro color
  spinner.setAttribute('role', 'status');
  const spinnerText = document.createElement('span');
  spinnerText.className = 'visually-hidden';
  spinnerText.textContent = 'Loading...'; 
  spinner.appendChild(spinnerText);
  folderElement.innerHTML = '';
  folderElement.appendChild(spinner);
  const loadingOverlay = document.getElementById('loadingOverlay-file');
  loadingOverlay.classList.remove('d-none');
  fetch("{% url 'rename_folder_in_drive' %}", {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.message === 'Folder renamed successfully') {
      showAlert("Folder renamed successfully.", 'success');
      loadFolder()
    } else {
      showAlert("Error renaming folder", 'warning');
      loadFolder()
    }
  })
  .catch(error => {
    console.error('Error:', error);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const deleteButtons = document.querySelectorAll('[data-delete-action]');
  
  deleteButtons.forEach(button => {
      button.addEventListener('click', function(event) {
          event.preventDefault();
          const deleteUrl = button.getAttribute('href');
          // Mostrar el modal de confirmación
          const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
          modal.show();
          const confirmDeleteButton = document.getElementById('confirmDeleteBtn');
          confirmDeleteButton.onclick = function() {
              window.location.href = deleteUrl;
          };
      });
  });
});

document.addEventListener('DOMContentLoaded', function() {
  window.openPaymentModal = function(invoiceId, paidTotal, invoiceTotal) {
      const modal = new bootstrap.Modal(document.getElementById('attachPaymentModal'));
      const loadingOverlay = document.getElementById('loadingOverlay');
      const csrfToken = document.getElementById('csrf-token').dataset.csrf;
      
      // Set today's date as default
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];
      document.getElementById('paymentDate').value = todayString;
      
              modal.show();
        const amount = document.getElementById('paymentAmount');
        const remainingAmount = parseFloat(invoiceTotal) - parseFloat(paidTotal);
        
        // Set default amount to remaining amount (full payment)
        amount.value = remainingAmount.toFixed(2);
        amount.setAttribute('max', remainingAmount);
        
        // Add warning and limit functionality
        amount.addEventListener('input', function() {
            const inputAmount = parseFloat(amount.value) || 0;
            const maxAmount = parseFloat(amount.getAttribute('max'));
            
            if (inputAmount > maxAmount) {
                showAlert(`Warning: Payment amount ($${inputAmount.toFixed(2)}) exceeds the remaining balance ($${maxAmount.toFixed(2)})`, 'warning');
                amount.value = maxAmount.toFixed(2);
            }
            
            // Show remaining balance info
            const remainingAfterPayment = maxAmount - inputAmount;
            const paymentInfo = document.getElementById('paymentInfo');
            if (paymentInfo) {
                paymentInfo.innerHTML = `
                    <small class="text-muted">
                        Remaining after this payment: $${remainingAfterPayment.toFixed(2)}
                    </small>
                `;
            }
        });
      const confirmPaymentButton = document.getElementById('confirmPaymentBtn');
      confirmPaymentButton.onclick = function() {
          // Disable button to prevent multiple submissions
          confirmPaymentButton.disabled = true;
          confirmPaymentButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
          
          const amount = document.getElementById('paymentAmount').value;
          const date = document.getElementById('paymentDate').value;
          const description = document.getElementById('paymentDescription').value;
          const paymentMethod = document.getElementById('paymentMethod').value;
          const transactionId = document.getElementById('id_transaction').value;
          const evidenceFile = document.getElementById('evidenceFile');
          
          // Validate required fields
          if (!amount || amount <= 0) {
              showAlert('Please enter a valid payment amount', 'error');
              resetPaymentButton();
              return;
          }
          
          if (!date) {
              showAlert('Please select a payment date', 'error');
              resetPaymentButton();
              return;
          }
          
          // Validate payment amount doesn't exceed remaining balance
          const inputAmount = parseFloat(amount);
          const maxAmount = parseFloat(document.getElementById('paymentAmount').getAttribute('max'));
          
          if (inputAmount > maxAmount) {
              showAlert(`Payment amount ($${inputAmount.toFixed(2)}) cannot exceed the remaining balance ($${maxAmount.toFixed(2)})`, 'error');
              resetPaymentButton();
              return;
          }
          
          // Prepare payment data
          const paymentData = {
              amount: amount,
              date: date,
              description: description,
              payment_method: paymentMethod,
              transaction_id: transactionId,
          };
          
          // If file is selected, upload it first
          if (evidenceFile.files.length > 0) {
              showAlert('Uploading evidence...', 'info');
              uploadEvidenceFile(evidenceFile).then(result => {
                  paymentData.evidence_url = result;
                  submitPaymentData(paymentData, invoiceId, csrfToken, loadingOverlay);
              }).catch(error => {
                  console.error('Error uploading file:', error);
                  showAlert('Error uploading evidence', 'danger');
                  resetPaymentButton();
              });
          } else {
              submitPaymentData(paymentData, invoiceId, csrfToken, loadingOverlay);
          }
      };
  };
});

// Function to upload evidence file
function uploadEvidenceFile(fileInput) {
    const formData = new FormData();
    const file = fileInput.files[0];
    const folderId = document.getElementById('projectFolderId').value;
    
    formData.append('file_name', file.name);
    formData.append('mimeType', file.type);
    formData.append('folder_id', folderId);
    formData.append('is_evidence', true);
    
    const csrfToken = document.getElementById('csrf-token').dataset.csrf;
    
    return fetch("/projects/upload-file/", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken,
        }
    })
    .then(response => response.json())
    .then(data => {
        return uploadFileToDrive(file, data.uploadUrl, folderId).then(result => {
            console.log('File uploaded successfully:', result);
            return result.id;
        });
    })
    .catch(error => {
        console.error('Error uploading file:', error);
        throw error;
    });
}

// Function to upload file to Google Drive
async function uploadFileToDrive(file, uploadUrl, folderId) {
    const filesize = file.size;
    const contentType = file.type || 'application/octet-stream';
    
    const response = await fetch(uploadUrl, {
        method: 'PUT',
        headers: {
            'Content-Type': contentType,
            'Content-Length': filesize,
        },
        body: file
    });
    
    if (response.ok) {
        const data = await response.json();
        showAlert("Evidence uploaded successfully.", 'success');
        return data;
    } else {
        showAlert("Error uploading evidence: " + response.statusText, 'error');
        throw new Error('Upload failed');
    }
}

// Function to reset payment button
function resetPaymentButton() {
    const confirmPaymentButton = document.getElementById('confirmPaymentBtn');
    confirmPaymentButton.disabled = false;
    confirmPaymentButton.innerHTML = 'Attach Payment';
}

// Function to submit payment data
function submitPaymentData(paymentData, invoiceId, csrfToken, loadingOverlay) {
    loadingOverlay.classList.remove('d-none');
    
    fetch(`/projects/{{project.id}}/changePaidInvoice/${invoiceId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify(paymentData),
    })
    .then(response => {
        if (response.ok) {
            showAlert('Payment attached successfully', 'success');
            window.location.href = `/projects/{{project.id}}/`;
        } else {
            showAlert('Error attaching payment', 'error');
            resetPaymentButton();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error attaching payment', 'error');
        resetPaymentButton();
    })
    .finally(() => {
        loadingOverlay.classList.add('d-none');
    });
}


function showSelectProject(id_budget) {
  const selectProject = document.getElementById('selectProject');
  selectProject.classList.toggle('d-none');
  const duplicate_budget_id = document.getElementById('duplicate_budget_id');
  duplicate_budget_id.value = id_budget;
  ajaxGetRequest(`/get_array_projects/`, function (data) {

    const projectSelect = document.getElementById('projectSelect');
    if (typeof data === 'object' && data !== null) {
      let projectOptions = '';

      // Iterar sobre los estados y proyectos
      console.log(data)
      for (const [status, projects] of Object.entries(data)) {
        // Crear un grupo de opciones para cada estado
        const groupOptions = projects.map(project => {
          const sanitizedProjectName = project.project_name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          return `<option value="${project.id}">${sanitizedProjectName}</option>`;
        }).join('');

        // Agregar el grupo al select
        projectOptions += `<optgroup label="${status}">${groupOptions}</optgroup>`;
      }

      // Poblar el elemento select, incluyendo un placeholder
      projectSelect.innerHTML = `<option value="" disabled selected>Select a project</option>${projectOptions}`;
    } else {
      // Manejar el caso cuando no hay proyectos disponibles
      projectSelect.innerHTML = `<option value="" disabled>No projects available</option>`;
    }

    const spinner_project = document.getElementById('spinner_project');
    spinner_project.classList.add('d-none');
  });
}


function showSelectCustomerProject() {
  const selectCustomerProject = document.getElementById('selectCustomerProject');
  selectCustomerProject.classList.toggle('d-none');
}

function sendBudgetDuplicate(budgetId) {
  const selectProject = document.getElementById('projectSelect');
  const projectId = selectProject.value;
  if (projectId === null || projectId === '') {
    showAlert('Please select a project before duplicating the budget.', 'danger');
    return;
  }
  
  const container = document.getElementById('selectProject');
  const cancelBudgetDuplicate = document.getElementById('cancelBudgetDuplicateButton');
  const duplicateProjectButton = document.getElementById('duplicateBudgetButton');
  
  // Prevent double submission
  if (duplicateProjectButton.disabled) {
    return;
  }
  
  // Disable button and show spinner
  duplicateProjectButton.disabled = true;
  duplicateProjectButton.classList.add('bg-secondary');
  duplicateProjectButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Duplicating...';
  cancelBudgetDuplicate.disabled = true;
  
  ajaxPostRequest(`/create_copy_budget/${budgetId}/${projectId}/`, {
  }, '{{ csrf_token }}', function(data) {
    if (data.status === 'success') {
      // Reset button state
      duplicateProjectButton.disabled = false;
      duplicateProjectButton.classList.remove('bg-secondary');
      duplicateProjectButton.innerHTML = 'Duplicate';
      cancelBudgetDuplicate.disabled = false;
      
      // Clear form and hide container
      selectProject.value = '';
      container.classList.add('d-none');
      
      showAlert('Budget duplicated successfully.', 'success');
      window.open(data.redirect, '_blank');
    } else {
      showAlert('Error duplicating budget.', 'danger');
      
      // Reset button state on error
      duplicateProjectButton.disabled = false;
      cancelBudgetDuplicate.disabled = false;
      duplicateProjectButton.classList.remove('bg-secondary');
      duplicateProjectButton.innerHTML = 'Duplicate';
    }
  }, function(error) {
    container.classList.add('d-none');
    showAlert('Error duplicating budget.', 'danger');
    
    // Reset button state on network error
    duplicateProjectButton.disabled = false;
    duplicateProjectButton.classList.remove('bg-secondary');
    duplicateProjectButton.innerHTML = 'Duplicate';
    cancelBudgetDuplicate.disabled = false;
  });
}

function sendProjectDuplicate() {
  const selectCustomerProject = document.getElementById('selectCustomerProject');
  selectCustomerProject.classList.toggle('d-none');
  const customerId = document.getElementById('id_customer').value;
  const duplicateProjectButton = document.getElementById('duplicateProjectButton');
  duplicateProjectButton.disabled = true;
  duplicateProjectButton.classList.add('bg-secondary');
  if (customerId) {
    duplicateProjectButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Duplicating... ';
    ajaxPostRequest(`/duplicate_project/{{project.id}}/${customerId}/`, {
    }, '{{ csrf_token }}', function(data) {
      duplicateProjectButton.disabled = false;
      duplicateProjectButton.classList.remove('bg-secondary');
      duplicateProjectButton.innerHTML = 'Duplicate';
      window.open(data.redirect, '_blank');

    });
  } else {
    alert('Please select a customer before duplicating the project.');
  }
}

function cancelBudgetDuplicate() {
  const container = document.getElementById('selectProject');
  container.classList.add('d-none');
}

document.addEventListener('DOMContentLoaded', function() {

  
  // Event listener for confirming accounting manager assignment
  const confirmAccountingManagerBtn = document.getElementById('confirmAccountingManagerBtn');
  if (confirmAccountingManagerBtn) {
    confirmAccountingManagerBtn.addEventListener('click', function() {
      const managerId = document.getElementById('selectedManagerId').value;
      const loadingOverlay = document.getElementById('loadingOverlay');
      
      if (managerId) {
        loadingOverlay.classList.remove('d-none');
        
        // Make AJAX request to assign accounting manager
        fetch(`/projects/{{project.id}}/assign_accounting_manager/${managerId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
          }
        })
        .then(response => {
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('Network response was not ok');
          }
        })
        .then(data => {
          if (data.status === 'success') {
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmAccountingManagerModal'));
            modal.hide();
            window.location.reload();
          } else {
            alert('Error assigning accounting manager: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error assigning accounting manager. Please try again.');
        })
        .finally(() => {
          loadingOverlay.classList.add('d-none');
        });
      }
    });
  }
  
  // Event listener for confirming project manager assignment
  const confirmProjectManagerBtn = document.getElementById('confirmProjectManagerBtn');
  if (confirmProjectManagerBtn) {
    confirmProjectManagerBtn.addEventListener('click', function() {
      const managerId = document.getElementById('selectedProjectManagerId').value;
      const loadingOverlay = document.getElementById('loadingOverlay');
      
      if (managerId) {
        loadingOverlay.classList.remove('d-none');
        
        // Make AJAX request to assign project manager
        fetch(`/projects/{{project.id}}/assign_project_manager/${managerId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
          }
        })
        .then(response => {
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('Network response was not ok');
          }
        })
        .then(data => {
          if (data.status === 'success') {
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmProjectManagerModal'));
            modal.hide();
            window.location.reload();
          } else {
            alert('Error assigning project manager: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error assigning project manager. Please try again.');
        })
        .finally(() => {
          loadingOverlay.classList.add('d-none');
        });
      }
    });
  }
});

// Event listener for selectManager change
document.addEventListener('DOMContentLoaded', function() {
  const selectManager = document.getElementById('selectManager');
  if (selectManager) {
    selectManager.addEventListener('change', function() {
      const selectedValue = this.value;
      const selectedOption = this.options[this.selectedIndex];
      
      if (selectedValue && selectedValue !== '') {
        // Show confirmation modal
        const modal = new bootstrap.Modal(document.getElementById('confirmAccountingManagerModal'));
        document.getElementById('selectedManagerName').textContent = selectedOption.text;
        document.getElementById('selectedManagerId').value = selectedValue;
        modal.show();
        
        // Reset select when modal is hidden (cancelled)
        document.getElementById('confirmAccountingManagerModal').addEventListener('hidden.bs.modal', function() {
          selectManager.value = '';
        });
      }
    });
  }
  
  // Event listener for selectProjectManager change
  const selectProjectManager = document.getElementById('selectProjectManager');
  if (selectProjectManager) {
    selectProjectManager.addEventListener('change', function() {
      const selectedValue = this.value;
      const selectedOption = this.options[this.selectedIndex];
      
      if (selectedValue && selectedValue !== '') {
        // Show confirmation modal
        const modal = new bootstrap.Modal(document.getElementById('confirmProjectManagerModal'));
        document.getElementById('selectedProjectManagerName').textContent = selectedOption.text;
        document.getElementById('selectedProjectManagerId').value = selectedValue;
        modal.show();
        
        // Reset select when modal is hidden (cancelled)
        document.getElementById('confirmProjectManagerModal').addEventListener('hidden.bs.modal', function() {
          selectProjectManager.value = '';
        });
      }
    });
  }
});

// Global variable to store all items
let allActivityItems = [];

async function get_activity_project_and_comments() {
  try {
    const response = await fetch(`/projects/{{project.id}}/get_activity_and_comments/`);
    const data = await response.json();
    
    if (data.status === 'success') {
      // Store all items globally
      allActivityItems = data.items;
      
      // Apply current filter
      applyCurrentFilter();
    } else {
      console.error('Error loading activity and comments:', data.error);
    }
  } catch (error) {
    console.error('Error fetching activity and comments:', error);
  }
}

function filterActivity(filterType) {
  updateCheckboxStates(filterType);
  applyCurrentFilter();
}

function updateCheckboxStates(clickedFilter) {
  const checkboxes = {
    'all': document.getElementById('filter-all'),
    'activity': document.getElementById('filter-activity'),
    'comments': document.getElementById('filter-comments')
  };
  
  if (clickedFilter === 'all') {
    // If "all" is clicked, uncheck others
    checkboxes.activity.checked = false;
    checkboxes.comments.checked = false;
  } else {
    // If specific filter is clicked, uncheck "all"
    checkboxes.all.checked = false;
  }
}

function applyCurrentFilter() {
  const activityContainer = document.getElementById('activityContainer');
  if (!activityContainer) return;
  
  const showAll = document.getElementById('filter-all').checked;
  const showActivity = document.getElementById('filter-activity').checked;
  const showComments = document.getElementById('filter-comments').checked;
  
  // If no filters are selected, show all
  if (!showAll && !showActivity && !showComments) {
    document.getElementById('filter-all').checked = true;
    activityContainer.innerHTML = generateActivityHTML(allActivityItems);
    return;
  }
  
  // Filter items based on checkboxes
  let filteredItems = [];
  
  if (showAll) {
    filteredItems = allActivityItems;
  } else {
    if (showActivity) {
      filteredItems = filteredItems.concat(allActivityItems.filter(item => item.type === 'activity'));
    }
    if (showComments) {
      filteredItems = filteredItems.concat(allActivityItems.filter(item => item.type === 'comment'));
    }
  }
  
  // Sort filtered items by date
  filteredItems.sort((a, b) => new Date(b.date_created) - new Date(a.date_created));
  
  // Update display
  activityContainer.innerHTML = generateActivityHTML(filteredItems);
}

function generateActivityHTML(items) {
  if (!items || items.length === 0) {
    return `
      <div class="text-center text-muted py-4">
        <i class="bi bi-inbox fs-1"></i>
        <p class="mt-2">No activity or comments yet</p>
        <small>Start by adding a comment or the system will track project changes automatically.</small>
      </div>
    `;
  }

  return items.map(item => {
    const date = new Date(item.date_created).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    if (item.type === 'comment') {
      let repliesHTML = '';
      if (item.replies && item.replies.length > 0) {
        repliesHTML = `
          <div class="replies-container ms-4 mt-2">
            ${item.replies.map(reply => {
              const replyDate = new Date(reply.date_created).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
              
              return `
                <div class="reply-item mb-2 p-2 border-start border-2 border-primary border-opacity-25 bg-light rounded-end">
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <span class="customer-avatar text-light rounded-circle bg-secondary"
                    style="font-size: 0.8rem; width: 25px; height: 25px;">
                    ${escapeHtml(reply.user_initials)}
                    </span>
                    <small class="text-muted">${escapeHtml(reply.user_name)}</small>
                    <small class="text-muted" style="font-size: 0.6rem;">${replyDate}</small>
                  </div>
                  <p class="mb-1 text-dark" style="font-size: 0.9rem;">${formatCommentWithMentions(reply.comment)}</p>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      return `
        <div class="activity-item mb-3 mx-auto" style="width: 100%;">
          <div class="d-flex justify-content-between w-100">
            <div class="d-flex align-items-center gap-2 w-100">
               <small class="text-muted d-flex flex-column gap-1 w-100 position-relative">
                  <div class="d-flex flex-row gap-2 bg-light rounded-3 p-2  border border-2 border-primary border-opacity-25" style="width: 50%;">
                      <span class="customer-avatar text-light rounded-circle m-0 bg-primary"
                      style="font-size: 1.2rem; width: 35px; height: 35px;">
                      ${escapeHtml(item.user_initials)}
                      </span>
                      <span class="d-flex flex-column text-primary">
                        ${escapeHtml(item.user_name)}
                        <small class="text-muted" style="font-size: 0.6rem;">${date}</small>
                      </span>
                  </div>
                  <p class="ms-5 text-dark border rounded-3 bg-primary bg-opacity-10 shadow-sm p-2 border-top-0" style="width: 80%;">${formatCommentWithMentions(item.comment)}</p>
                  ${repliesHTML}
                  <div class="ms-5 mt-2 position-absolute bottom-0 end-0">
                    <button class="py-1 bg-light my-0 borde rounded-circle border-1 border-primary" onclick="openReplyModal(${item.id}, '${escapeHtml(item.user_name)}')">
                      <i class="bi bi-reply text-primary"></i>
                    </button>
                  </div>
               </small>
            </div>
          </div>
        </div>
      `;
    } else {
      // Activity item
      const iconClass = getActivityIcon(item.action);
      const textClass = getActivityTextClass(item.action);
      
      let changesHTML = '';
      if (item.changes && Object.keys(item.changes).length > 0) {
        changesHTML = `
          <div class="mt-2 p-2 bg-light rounded-2">
            <small class="text-muted">
              <strong>Changes:</strong>
              ${Object.entries(item.changes).map(([field, values]) => `
                <div class="ms-2">
                  <strong>${field}:</strong> 
                  ${values[0] !== null ? escapeHtml(values[0]) : 'None'} → 
                  ${values[1] !== null ? escapeHtml(values[1]) : 'None'}
                </div>
              `).join('')}
            </small>
          </div>
        `;
      }

      return `
        <div class="activity-item mb-3 px-2 py-1 border rounded-3 bg-light mx-auto" style="width: 90%;">
          <div class="d-flex align-items-center justify-content-center">
            <div class="d-flex align-items-center gap-2">
              <i class="bi ${iconClass} fs-5"></i>
              <span class="d-flex flex-column align-items-center" >
                <p class="mb-1 text-dark text-center" style="font-size: 0.8rem; line-height: 1;">${escapeHtml(item.action_display)}: ${escapeHtml(item.description)}</p>
                <span class="d-flex flex-row gap-2 align-items-center">
                   <small class="text-muted d-flex flex-row gap-1">
                    <span class="customer-avatar text-light rounded-circle m-0 bg-primary"
                    style="font-size: 0.6rem; width: 15px; height: 15px;">
                    ${escapeHtml(item.user_initials)}
                    </span>
                    ${escapeHtml(item.user_name)}
                  </small>
                  <small class="text-muted " style="font-size: 0.6rem;">${date}</small>
                </span>
              </span>
            </div>
          </div>
        </div>
      `;
    }
  }).join('');
}

function getActivityIcon(action) {
  const iconMap = {
    'CREATE': 'bi-plus-circle text-success',
    'UPDATE': 'bi-pencil-square text-warning',
    'DELETE': 'bi-trash text-danger',
    'STATUS_CHANGE': 'bi-arrow-repeat text-info',
    'BUDGET_CHANGE': 'bi-calculator text-primary',
    'PROPOSAL_CHANGE': 'bi-file-earmark-text text-success',
    'INVOICE_CHANGE': 'bi-receipt text-warning',
    'COMMENT': 'bi-chat-dots text-primary'
  };
  return iconMap[action] || 'bi-activity text-secondary';
}

function getActivityTextClass(action) {
  const classMap = {
    'CREATE': 'text-success',
    'UPDATE': 'text-warning',
    'DELETE': 'text-danger',
    'STATUS_CHANGE': 'text-info',
    'BUDGET_CHANGE': 'text-primary',
    'PROPOSAL_CHANGE': 'text-success',
    'INVOICE_CHANGE': 'text-warning',
    'COMMENT': 'text-primary'
  };
  return classMap[action] || 'text-secondary';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

document.addEventListener('DOMContentLoaded', function() {
  get_activity_project_and_comments();
  setupMentionAutocomplete();
  
  // Event listener for confirming comment addition
  const confirmCommentBtn = document.getElementById('confirmCommentBtn');
  if (confirmCommentBtn) {
    confirmCommentBtn.addEventListener('click', async function() {
      const commentText = document.getElementById('commentText').value.trim();
      const parentCommentId = document.getElementById('parentCommentId').value;
      const loadingOverlay = document.getElementById('loadingOverlay');
      
      if (commentText) {
        loadingOverlay.classList.remove('d-none');
        
        try {
          const requestBody = {
            comment: commentText,
          };
          
          if (parentCommentId) {
            requestBody.parent_comment_id = parentCommentId;
          }
          
          const response = await fetch(`/projects/{{project.id}}/add_comment/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(requestBody),
          });
          
          const data = await response.json();
          
          if (data.status === 'success') {
            // Close modal and reload activity
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCommentModal'));
            modal.hide();
            document.getElementById('commentText').value = '';
            document.getElementById('parentCommentId').value = '';
            document.getElementById('commentText').placeholder = 'Write your comment here... Use @username to mention someone';
            await get_activity_project_and_comments();
          } else {
            alert('Error adding comment: ' + (data.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error adding comment. Please try again.');
        } finally {
          loadingOverlay.classList.add('d-none');
        }
      } else {
        alert('Please enter a comment before submitting.');
      }
    });
  }
});

function formatCommentWithMentions(text) {
  // Formatear menciones como enlaces
  const mentionPattern = /@(\w+)/g;
  return text.replace(mentionPattern, '<span class="mention text-primary fw-bold" data-username="$1">@$1</span>');
}

function openReplyModal(parentCommentId, parentUserName) {
  const modal = new bootstrap.Modal(document.getElementById('addCommentModal'));
  document.getElementById('commentText').placeholder = `Reply to ${parentUserName}...`;
  document.getElementById('parentCommentId').value = parentCommentId;
  modal.show();
}

// Autocompletado para menciones
let mentionTimeout;
function setupMentionAutocomplete() {
  const commentTextarea = document.getElementById('commentText');
  if (!commentTextarea) return;

  commentTextarea.addEventListener('input', function() {
    clearTimeout(mentionTimeout);
    const cursorPos = this.selectionStart;
    const text = this.value;
    
    // Buscar si estamos escribiendo una mención
    const beforeCursor = text.substring(0, cursorPos);
    const mentionMatch = beforeCursor.match(/@(\w*)$/);
    
    if (mentionMatch) {
      const searchTerm = mentionMatch[1];
      mentionTimeout = setTimeout(() => {
        searchUsersForMention(searchTerm);
      }, 300);
    } else {
      hideMentionSuggestions();
    }
  });
}

async function searchUsersForMention(searchTerm) {
  try {
    const response = await fetch(`/get_users_for_mentions/?q=${encodeURIComponent(searchTerm)}`);
    const data = await response.json();
    
    if (data.status === 'success') {
      showMentionSuggestions(data.users);
    }
  } catch (error) {
    console.error('Error searching users:', error);
  }
}

function showMentionSuggestions(users) {
  let suggestionsContainer = document.getElementById('mentionSuggestions');
  if (!suggestionsContainer) {
    suggestionsContainer = document.createElement('div');
    suggestionsContainer.id = 'mentionSuggestions';
    suggestionsContainer.className = 'mention-suggestions position-absolute bg-white border rounded shadow-sm';
    suggestionsContainer.style.zIndex = '1050';
    document.getElementById('addCommentModal').appendChild(suggestionsContainer);
  }
  
  if (users.length === 0) {
    suggestionsContainer.innerHTML = '<div class="p-2 text-muted">No users found</div>';
  } else {
    suggestionsContainer.innerHTML = users.map(user => `
      <div class="mention-suggestion p-2 border-bottom" onclick="insertMention('${user.username}')">
        <div class="d-flex align-items-center gap-2">
          <span class="customer-avatar text-light rounded-circle bg-primary"
          style="font-size: 0.8rem; width: 25px; height: 25px;">
          ${escapeHtml(user.initials)}
          </span>
          <div>
            <div class="fw-bold">${escapeHtml(user.full_name)}</div>
            <small class="text-muted">@${escapeHtml(user.username)}</small>
          </div>
        </div>
      </div>
    `).join('');
  }
  
  // Posicionar el contenedor
  const textarea = document.getElementById('commentText');
  const rect = textarea.getBoundingClientRect();
  suggestionsContainer.style.top = `${rect.bottom + 5}px`;
  suggestionsContainer.style.left = `${rect.left}px`;
  suggestionsContainer.style.width = `${rect.width}px`;
  suggestionsContainer.style.display = 'block';
}

function hideMentionSuggestions() {
  const suggestionsContainer = document.getElementById('mentionSuggestions');
  if (suggestionsContainer) {
    suggestionsContainer.style.display = 'none';
  }
}

function insertMention(username) {
  const textarea = document.getElementById('commentText');
  const cursorPos = textarea.selectionStart;
  const text = textarea.value;
  
  // Reemplazar la mención parcial con el username completo
  const beforeCursor = text.substring(0, cursorPos);
  const afterCursor = text.substring(cursorPos);
  const newBeforeCursor = beforeCursor.replace(/@\w*$/, `@${username} `);
  
  textarea.value = newBeforeCursor + afterCursor;
  textarea.focus();
  textarea.setSelectionRange(newBeforeCursor.length, newBeforeCursor.length);
  
  hideMentionSuggestions();
}

function openAddCommentModal() {
  console.log('Opening Add Comment modal...');
  const modalElement = document.getElementById('addCommentModal');
  console.log('Modal element:', modalElement);
  
  if (modalElement) {
    const modal = new bootstrap.Modal(modalElement);
    console.log('Bootstrap modal instance:', modal);
    modal.show();
    console.log('Modal show() called');
  } else {
    console.error('Add Comment modal element not found!');
  }
}

// Funciones para editar proyecto
function openEditProjectModal() {
  console.log('Opening Edit Project modal...');
  // Cargar datos actuales del proyecto en el modal
  loadProjectData();
  
  // Mostrar el modal
  const modalElement = document.getElementById('editProjectModal');
  console.log('Modal element:', modalElement);
  
  if (modalElement) {
    const modal = new bootstrap.Modal(modalElement);
    console.log('Bootstrap modal instance:', modal);
    modal.show();
    console.log('Modal show() called');
    
    // Inicializar Select2 después de que el modal esté visible
    setTimeout(function() {
      $('#editProjectCustomer').select2({
        placeholder: 'Select a customer',
        allowClear: true,
        dropdownParent: $('#editProjectModal')
      });
      
      // Establecer el valor seleccionado
      $('#editProjectCustomer').val('{{ project.customer.id }}').trigger('change');
    }, 100);
  } else {
    console.error('Edit Project modal element not found!');
  }
}

function loadProjectData() {
  // Cargar datos del proyecto actual en el formulario
  document.getElementById('editProjectName').value = '{{ project.project_name|escapejs }}';
  document.getElementById('editProjectDescription').value = '{{ project.description|default:""|escapejs }}';
  document.getElementById('editProjectCity').value = '{{ project.city|escapejs }}';
  document.getElementById('editProjectState').value = '{{ project.state|escapejs }}';
  document.getElementById('editProjectZipCode').value = '{{ project.zip_code|default:""|escapejs }}';
  document.getElementById('editProjectCountry').value = '{{ project.country|escapejs }}';
  
  // Formatear fechas para el input type="date"
  var startDate = '{{ project.start_date|date:"Y-m-d" }}';
  var endDate = '{{ project.end_date|date:"Y-m-d" }}';
  
  if (startDate && startDate !== 'None') {
    document.getElementById('editProjectStartDate').value = startDate;
  }
  if (endDate && endDate !== 'None') {
    document.getElementById('editProjectEndDate').value = endDate;
  }
}

function saveProjectChanges() {
  // Validar campos requeridos
  const projectName = document.getElementById('editProjectName').value.trim();
  const customerId = document.getElementById('editProjectCustomer').value;
  
  if (!projectName) {
    showAlert('Project name is required', 'warning');
    return;
  }
  
  if (!customerId) {
    showAlert('Customer is required', 'warning');
    return;
  }
  
  // Deshabilitar botón y mostrar loading
  const saveBtn = document.getElementById('saveProjectBtn');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...';
  saveBtn.disabled = true;
  
  // Preparar datos
  const projectData = {
    project_name: projectName,
    customer: customerId,
    description: document.getElementById('editProjectDescription').value.trim(),
    start_date: document.getElementById('editProjectStartDate').value || null,
    end_date: document.getElementById('editProjectEndDate').value || null,
    city: document.getElementById('editProjectCity').value.trim(),
    state: document.getElementById('editProjectState').value.trim(),
    zip_code: document.getElementById('editProjectZipCode').value.trim(),
    country: document.getElementById('editProjectCountry').value.trim()
  };
  
  // Enviar datos usando ajaxPostRequest
  ajaxPostRequest('/projects/{{ project.id }}/edit_project/', projectData, '{{ csrf_token }}', 
    function(data) {
      // Restaurar botón
      saveBtn.innerHTML = originalText;
      saveBtn.disabled = false;
      
      if (data.status === 'success') {
        // Cerrar modal y recargar página
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProjectModal'));
        modal.hide();
        showAlert('Project updated successfully', 'success');
        window.location.reload();
      } else {
        showAlert(data.message || 'Error updating project', 'danger');
      }
    },
    function(error) {
      // Restaurar botón en caso de error
      saveBtn.innerHTML = originalText;
      saveBtn.disabled = false;
      showAlert('Error updating project. Please try again.', 'danger');
    }
  );
}

// Event listener para el botón de guardar
document.addEventListener('DOMContentLoaded', function() {
  const saveProjectBtn = document.getElementById('saveProjectBtn');
  if (saveProjectBtn) {
    saveProjectBtn.addEventListener('click', saveProjectChanges);
  }
  
  // Limpiar Select2 cuando se cierre el modal
  $('#editProjectModal').on('hidden.bs.modal', function () {
    if ($('#editProjectCustomer').hasClass('select2-hidden-accessible')) {
      $('#editProjectCustomer').select2('destroy');
    }
  });
});

// Function to open Add Document modal
function openAddDocumentModal() {
  console.log('Opening Add Document modal...');
  const modalElement = document.getElementById('addDocumentModal');
  console.log('Modal element:', modalElement);
  
  if (modalElement) {
    const modal = new bootstrap.Modal(modalElement);
    console.log('Bootstrap modal instance:', modal);
    modal.show();
    console.log('Modal show() called');
  } else {
    console.error('Add Document modal element not found!');
  }
}

// Function to open Accounting Manager confirmation modal
function openAccountingManagerModal(managerId, managerName) {
  console.log('Opening Accounting Manager modal...', managerId, managerName);
  document.getElementById('selectedManagerId').value = managerId;
  document.getElementById('selectedManagerName').textContent = managerName;
  const modalElement = document.getElementById('confirmAccountingManagerModal');
  console.log('Modal element:', modalElement);
  
  if (modalElement) {
    const modal = new bootstrap.Modal(modalElement);
    console.log('Bootstrap modal instance:', modal);
    modal.show();
    console.log('Modal show() called');
  } else {
    console.error('Accounting Manager modal element not found!');
  }
}

// Function to open Project Manager confirmation modal
function openProjectManagerModal(managerId, managerName) {
  console.log('Opening Project Manager modal...', managerId, managerName);
  document.getElementById('selectedProjectManagerId').value = managerId;
  document.getElementById('selectedProjectManagerName').textContent = managerName;
  const modalElement = document.getElementById('confirmProjectManagerModal');
  console.log('Modal element:', modalElement);
  
  if (modalElement) {
    const modal = new bootstrap.Modal(modalElement);
    console.log('Bootstrap modal instance:', modal);
    modal.show();
    console.log('Modal show() called');
  } else {
    console.error('Project Manager modal element not found!');
  }
}

// Funciones para manejar colaboración
function respondToRequest(requestId, action) {
  const responseMessage = prompt(`Enter a response message for ${action}ing this request (optional):`);
  
  const formData = new FormData();
  formData.append('action', action);
  formData.append('response_message', responseMessage || '');
  
  fetch(`/collaboration_requests/${requestId}/respond/`, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      showAlert(data.message, 'success');
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } else {
      showAlert(data.message, 'danger');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showAlert('Error responding to request. Please try again.', 'danger');
  });
}

function removeCollaborator(userId) {
  if (confirm('Are you sure you want to remove this collaborator?')) {
    fetch(`/projects/{{ project.id }}/remove_collaborator/${userId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        showAlert(data.message, 'success');
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        showAlert(data.message, 'danger');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showAlert('Error removing collaborator. Please try again.', 'danger');
    });
  }
}

// Function to handle Change Order status updates
document.addEventListener('DOMContentLoaded', function() {
  const statusSelectors = document.querySelectorAll('.change-order-status');
  
  statusSelectors.forEach(selector => {
    selector.addEventListener('change', function() {
      const budgetId = this.getAttribute('data-budget-id');
      const changeOrderId = this.getAttribute('data-change-order-id');
      const newStatus = this.value;
      
      // Show loading state
      const originalValue = this.value;
      this.disabled = true;
      
      // Make AJAX request
      fetch(`/projects/{{ project.id }}/change_order/${budgetId}/update_status/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          status: newStatus
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          showAlert('Change Order status updated successfully!', 'success');
          window.location.reload();
        } else {
          showAlert('Error updating Change Order status: ' + data.message, 'danger');
          this.value = originalValue;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showAlert('Error updating Change Order status. Please try again.', 'danger');
        // Revert to original value
        this.value = originalValue;
      })
      .finally(() => {
        // Re-enable the selector
        this.disabled = false;
      });
    });
  });
});
</script>
{% endblock %}
