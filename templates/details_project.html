{% extends "base.html" %}
{% load static %}
{% block title %}{{ project.project_name }}{% endblock %}
{% block extra_head %}

    <style>
      .productionButton {
        font-weight: bold;
        letter-spacing: 0.1em;
        border: none;
        border-radius: 1.1em;
        background-color: #20a33a;
        cursor: pointer;
        color: #ffffff;
        padding: 8px 32px;
        border: 4px solid #c7c7c7;
        box-sizing: border-box;
      }
      .productionButton:hover {
        background-color:rgb(14, 109, 33);
      }
      #selectManager{
        border: none;
        border-radius: 1.1em;
        background-color: #ffffff;
        cursor: pointer;
        color: #000000;
        padding: 8px 32px;
        left: -30px;
        position: relative;
        border: 4px solid #c7c7c7;
        box-sizing: border-box;
      }
    </style>
{% endblock %}
{% block content %}
{% load custom_filters %}
<div class="container d-flex flex-column justify-content-center my-4">
  <div id="alert-container"></div>
  <div class="row">
    <!-- Project Card -->
    <div class="col-md-12 ">
      <div class="container border m-0 px-0 rounded-4 overflow-hidden mb-4 shadow-sm ">
        <div
          class="card-header d-flex justify-content-between  p-3 border-bottom bg-gray"
        >
          <h1 class="card-header fs-4 rounded-4 d-flex flex-row gap-2" id="project-info" data-project-name="{{ project.project_name }}">{{project.project_name}}
            <div class="d-flex flex-row gap-2">
              <a class="btn bg-primary border border-2 btn-sm rounded-2 p-1 text-light" onclick="showSelectCustomerProject()" id="duplicateProjectButton"
                role="button" title="Duplicate Project" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Duplicate Project">
                <i class="bi bi-copy me-1" style="font-size: 15px;"></i >Duplicate
              </a>
              <div id="selectCustomerProject" class="d-none w-50 form-selec p-0 d-flex flex-row gap-2">
                <select name="customer" id="id_customer" class="form-select form-select-sm m-0 overflow-auto" >
                  <option value="" selected>Select a customer</option>
                    {% for customer in customers %}
                        <option value="{{ customer.id }}">
                          {% if customer.customer_type == "individual" %}
                            {{customer.first_name }} {{customer.last_name }} - {{customer.email}} 
                            {% else %}
                            {{customer.company_name }} - {{customer.email}} 
                            {% endif %}
                        </option>
                    {% endfor %}
                </select>
                <button class="btn bg-success border border-2 btn-sm rounded-2 p-1 text-light d-flex flex-row align-items-center" onclick="sendProjectDuplicate()">
                  <i class="bi bi-check-all" style="font-size: 15px;"></i> Send
                </button>
              </div>
            </div>
          </h1>
          <div>
            <a href="{% url 'project_history' project.id %}" class="btn btn-outline-secondary me-2">
              <i class="bi bi-clock-history"></i>
            </a>
            <a href="">
              <button class="btn btn-primary d-none">
                <i class="bi bi-pencil-square"></i> 
              </button>
            </a>
            <button id="button-delete-project" class="btn btn-danger ms-2" {% if not user.is_superuser and not user.is_staff %}disabled{% endif %} data-id="{{ project.id }}">
              <i class="bi bi-trash"></i> 
            </button>
          </div>
        </div>
        <div class="card-body mx-4 my-2">
          <div class=" d-flex row gap-4 mx-auto">
            <div class="col-md-8 card my-2 p-0">
              <div class="card-header m-0  ">Description</div>
              <div class="p-4 d-flex flex-column gap-2"> 
                <p class="truncate">
                  {{ project.description }}</p>
                <p>
                  <strong class="text-capitalize font-weight-bold text-primary">Customer: </strong
                    {% if project.customer.customer_type == "individual" %}
                    <a href="{% url 'detail_customer' project.customer.id %}" target="_blank">
                    <span class="status title_{{ project.customer.customer_type }} fs-6">
                    {{ project.customer.first_name }} {{ project.customer.last_name }} <i class="bi bi-person-arms-up"></i>
                    </span>
                    </a> {% else %}
                    <a href="{% url 'detail_customer' project.customer.id %}" target="_blank">
                    <span class="status title_{{ project.customer.customer_type }} fs-6">{{ project.customer.company_name }} 
                      <i class="bi bi-buildings-fill"></i> 
                    </span> 
                  </a>
                    {{ project.customer.first_name }} {{ project.customer.last_name }}
                    {% endif %}
                    <p class="text-capitalize p-0 m-0 d-flex flex-row gap-2"><i class="bi bi-geo-alt-fill text-primary"></i> {{ project.customer.address }} {{ project.customer.city }} {{ project.customer.state }} {{ project.customer.country }} - {{ project.customer.zip_code }} <i class="bi bi-telephone-fill text-primary"></i> {{ project.customer.phone }} <i class="bi bi-envelope-fill text-primary "></i> {{ project.customer.email }}</p>
                  </p>
              </div>

            </div>
            <div class="card  col-md-3 my-2 p-2 flex-fill"> 
              <div>
              <p><strong>Sales Associate:</strong> {{ project.sales_advisor }}</p>
              <p class="text-capitalize"><strong>Project Address:</strong> {{ project.address }} {{ project.city }} {{ project.state }} {{ project.country }} - {{ project.zip_code }}</p>
              </div>
              <div>
            </div>
          </div>
        </div>
        <!-- progresss project -->
        <div class="timeline-container">
          <div class="timeline">
              {% for step in steps %}
                  <div class="step">
                      <div class="step-circle step-{{ step.is_active }} step-current-{{ step.is_current }}"></div>
                      <div class="step-title step-text-{{ step.is_active }} step-text-current-{{ step.is_current }}">{{ step.title }}</div>
                  </div>
              {% endfor %}
              
          </div>
          {% if project.status == 'approved' and project.project_manager == None %}
              <a class="productionButton" id="sendToProductionBtn">
                <i class="bi bi-wrench-adjustable-circle-fill"></i> Send to production
              </a>
              <select id="selectManager">
                {% for group, users in productionUsers.items %}
                  <optgroup label="{% if group == 'Admins' %}Administradores{% elif group == 'Managers' %}Managers{% endif %}">
                    {% for person in users %}
                      <option value="{{ person.id }}">{{ person.name }}  {{ person.email }}</option>
                    {% endfor %}
                  </optgroup>
                {% endfor %}
              </select>
                            
          {% elif project.project_manager %}
            <a class="productionButton">
              <i class="bi bi-wrench-adjustable-circle-fill"></i> Manager
            </a>
            <span id='selectManager'>
              {{project.project_manager.first_name}} {{project.project_manager.last_name}}  {{project.project_manager.email}}
            </span>
          {% endif %}
      </div>
      </div>
    </div>
    
    <!-- Project Budget -->
    <div class="col-md-12 mt-4">
      <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
        <div class="card-header d-flex justify-content-between p-3 border-bottom bg-gray">
          <h1 class="card-header fs-4 rounded-4">Budgets</h1>
          <a href="{% url 'new_budget' project.id %}" class="btn bg-primary text-light">
            <i class="bi bi-plus-circle text-light fs-6"></i> Add Budget
          </a>
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Budge ID</th>
                <th>Date</th>
                <th>Create by.</th>
                <th>Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
            {% for budget in budgets %}
                {% if budget.id in budgets_dict %}
                  <tr style="vertical-align: middle;"">
                    <td>
                      <i class="bi bi-caret-right text-light rounded-2 mx-2 p-1 drownIcon collapsed" 
                      data-bs-toggle="collapse" 
                      data-bs-target="#collapse-{{ budget.latest_version.id }}" 
                      aria-expanded="false" 
                      aria-controls="collapse-{{ budget.latest_version.id }}"
                      id="drownIcon icon-{{ budget.latest_version.id }}"></i>
                      <a href="{% url 'view_budget' project.id budget.latest_version.id %}">{{ project.customer.id }}.{{ project.id }}.{{ budget.latest_version.id }}
                        {% include 'components/duplicate_button.html' %}
                      </a>
                    
                    </td>
                    <td>{{ budget.latest_version.date_created|date:'M/d/Y' }}</td>
                    <td>{{ budget.latest_version.sales_advisor }}</td>
                    <td>{{ budget.latest_version.total_value|currency_usd }}</td>  
                    <td><span class="status-empty status-{{budget.latest_version.status}}">
                          {{ budget.latest_version.status }}
                        </span>
                        {% if budget.latest_version.status == 'rejected' %}
                            <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                data-bs-title="The proposal has been rejected. You must edit or create a new budget to submit another proposal." 
                                aria-label="Info" data-bs-original-title="Rejected Proposal">
                                <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                            </a>
                        {% elif budget.latest_version.status == 'complete' %}
                            <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                data-bs-title="The budget is complete and cannot be edited. This means that no more proposals can be created, as the current proposal has already been approved or is awaiting approval." 
                                aria-label="Info" data-bs-original-title="Completed Budget">
                                <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                            </a>
                        {% elif budget.latest_version.status == 'approved' %}
                            <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                data-bs-title="The proposal is approved. No further edits or proposals can be made for this budget." 
                                aria-label="Info" data-bs-original-title="Proposal Locked">
                                <i class="bi bi-lock-fill" style="font-size: 15px;"></i>
                            </a>
                        {% elif budget.latest_version.status == 'saved' %}
                            <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                data-bs-title="The budget is new, meaning no proposal has been created or sent to the client yet." 
                                aria-label="Info" data-bs-original-title="New Budget">
                                <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                            </a>
                        {% endif %}
                    <td style="width:80px">
                      <div class="d-inline-flex gap-2 align-items-center p-0">
                        <a class="btn bg-light border border-2 btn-sm rounded-2 p-1 {% if budget.latest_version.status == 'complete' or budget.latest_version.status == 'approved' %}disabled{% endif %}" 
                        href="{% url 'edit_budget' project.id budget.latest_version.id %}" 
                        role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Edit">
                        <i class="bi bi-pencil-square" style="font-size: 15px;"></i>
                        </a>
                        <a class="btn bg-light border border-2 btn-sm rounded-2 p-1" 
                        href="{% url 'view_budget' project.id budget.latest_version.id %}" 
                        role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Print">
                        <i class="bi bi-printer-fill" style="font-size: 15px;"></i>
                        </a>
                        <a class="btn bg-success text-light border border-2 btn-sm rounded-2 p-1 {% if budget.latest_version.status == 'complete' or budget.latest_version.status == 'approved' or budget.latest_version.status == 'rejected' %}disabled{% endif %}" 
                        href="{% url 'view_budgetSimple' project.id budget.latest_version.id %}"
                        role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Make proposal">
                        <i class="bi bi-receipt" style="font-size: 15px;"></i>
                        </a>
                        <!-- Bot贸n para Eliminar -->
                        <a class="btn btn-danger btn-sm rounded-2 p-1 
                          {% if budget.latest_version.status == 'complete' or budget.latest_version.status == 'approved' %}disabled{% endif %}" 
                          href="{% url 'delete_budget' project.id budget.latest_version.id %}"                         
                          role="button" title="Delete Budget" 
                          data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" 
                          data-bs-custom-class="custom-tooltip" 
                          data-delete-action data-bs-title="Delete">
                            <i class="bi bi-trash" style="font-size: 15px;"></i>
                        </a>
                      </div>
                    </td>
                  </tr>
                  <tr id="collapse-{{ budget.latest_version.id }}" class="collapse">
                    <td colspan="6" class="m-0 p-0">
                      <table class="table table-bordered">
                        <thead>
                          <tr>
                            <th class='p-0 text-secondary'></th>
                            <th class='p-0 text-secondary'>Budge ID</th>
                            <th class='p-0 text-secondary'>Date</th>
                            <th class='p-0 text-secondary'>Create by.</th>
                            <th class='p-0 text-secondary'>Amount</th>
                            <th class='p-0 text-secondary'>Version</th>
                            <th class='p-0 text-secondary'></th>
                          </tr>
                        </thead>
                        {% for related_id, budgets in budgets_dict.items %}
                          {% if budget.id == related_id %}
                            {% for budgetVersion in budgets.budget %}
                              <tr>
                                <td  class='p-1'></td>
                                <td  class='p-1'><a href="{% url 'view_budget' project.id budgetVersion.id %}">{{ project.customer.id }}.{{ project.id }}.{{ budgetVersion.id}}</a>
                                  {% include 'components/duplicate_button.html' %}
                                </td>
                                <td  class='p-1'>{{ budgetVersion.date_created }}</td>
                                <td  class='p-1'>{{ budgetVersion.sales_advisor }}</td>
                                <td  class='p-1'>{{ budgetVersion.total_value|currency_usd }}</td> 
                                <td  class='p-1'>
                                  <span class="status-empty">
                                    {% if forloop.counter == 1 %}
                                        Last Version
                                    {% else %}
                                        Version {{ forloop.counter }}
                                    {% endif %}
                                  </span>
                                </td>
                                <td style="width:40px"  class='px-auto py-1'>
                                  <div class="d-inline-flex gap-2 ">
                                    <!-- Bot贸n para Eliminar -->
                                    <a class="btn btn-danger btn-sm rounded-2 p-1" 
                                        href="{% url 'delete_budget' project.id budgetVersion.id %}" 
                                        role="button" title="Delete Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="Delete">
                                        <i class="bi bi-trash" style="font-size: 15px;"></i>
                                    </a>
                                  </div>
                                </td>
                              </tr>
                            {% endfor %}
                            <tr>
                              <td  class='p-1'></td>
                              <td  class='p-1'><a href="{% url 'view_budget' project.id budget.id %}">{{ project.customer.id }}.{{ project.id }}.{{ budget.id }}
                                {% include 'components/duplicate_button.html' %}
                              </a></td>
                              <td  class='p-1'>{{ budget.date_created }}</td>
                              <td  class='p-1'>{{ budget.sales_advisor }}</td>
                              <td  class='p-1'>{{ budget.total_value|currency_usd }}</td> 
                              <td  class='p-1'>
                                <span class="status-empty">
                                  Principal
                                </span>
                                <a class="btn btn-sm rounded-2 p-1" 
                                role="button" title="Delete Budget"
                                data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Deleting this budget will delete all related budgets, as this is the primary budget.">
                                <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                            </a>
                              </td>
                              <td style="width:40px"  class='px-auto py-1'>
                                <div class="d-inline-flex gap-2 ">
                                  <!-- Bot贸n para Eliminar -->
                                  <a class="btn btn-danger btn-sm rounded-2 p-1" 
                                      href="{% url 'delete_budget' project.id budget.id %}" 
                                      role="button" title="Delete Budget"
                                      data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="Delete">
                                      <i class="bi bi-trash" style="font-size: 15px;"></i>
                                  </a>
                                </div>
                              </td>
                            </tr>
                          {% endif %}
                        {% endfor %}
                      </table>
                    </td>
                  </tr>
                {% else %}
                <tr style="vertical-align: middle;"">
                  <td class='align-items-center'><a href="{% url 'view_budget' project.id budget.id %}">{{ project.customer.id }}.{{ project.id }}.{{ budget.id }}
                    {% include 'components/duplicate_button.html' %}
                  </a></td>
                  <td>{{ budget.date_created }}</td>
                  <td>{{ budget.sales_advisor }}</td>
                  <td>{{ budget.total_value|currency_usd }}</td> 
                  <td>
                    <span class="status-empty status-{{budget.status}}">
                      {{ budget.status }}
                    </span>
                    {% if budget.status == 'rejected' %}
                            <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                data-bs-title="The proposal has been rejected. You must edit or create a new budget to submit another proposal." 
                                aria-label="Info" data-bs-original-title="Rejected Proposal">
                                <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                            </a>
                        {% elif budget.status == 'complete' %}
                            <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                data-bs-title="The budget is complete and cannot be edited. This means that no more proposals can be created, as the current proposal has already been approved or is awaiting approval." 
                                aria-label="Info" data-bs-original-title="Completed Budget">
                                <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                            </a>
                        {% elif budget.status == 'approved' %}
                            <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                data-bs-title="The proposal is approved. No further edits or proposals can be made for this budget." 
                                aria-label="Info" data-bs-original-title="Proposal Locked">
                                <i class="bi bi-lock-fill" style="font-size: 15px;"></i>
                            </a>
                        {% elif budget.status == 'saved' %}
                            <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                                data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                                data-bs-title="The budget is new, meaning no proposal has been created or sent to the client yet." 
                                aria-label="Info" data-bs-original-title="New Budget">
                                <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                            </a>
                      {% endif %}
                  </td>
                  <td style="width:80px">
                    <div class="d-inline-flex gap-2 align-items-center p-0">
                      <a class="btn bg-light border border-2 btn-sm rounded-2 p-1 {% if budget.status == 'complete' or budget.status == 'approved' %}disabled{% endif %}" 
                      href="{% url 'edit_budget' project.id budget.id %}" 
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Edit">
                      <i class="bi bi-pencil-square" style="font-size: 15px;"></i>
                      </a>
                      <a class="btn bg-light border border-2 btn-sm rounded-2 p-1" 
                      href="{% url 'view_budget' project.id budget.id %}"
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Print">
                      <i class="bi bi-printer-fill" style="font-size: 15px;"></i>
                      </a>
                      <a class="btn  bg-success border text-light border-2 btn-sm rounded-2 p-1 {% if budget.status == 'complete' or budget.status == 'approved' or budget.status == 'rejected' %}disabled{% endif %}" 
                      href="{% url 'view_budgetSimple' project.id budget.id %}"
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Make invoice">
                      <i class="bi bi-receipt" style="font-size: 15px;"></i>
                      </a>
                      <!-- Bot贸n para Eliminar -->
                      <a class="btn btn-danger btn-sm rounded-2 p-1 
                        {% if budget.status == 'complete' or budget.status == 'approved' %}disabled{% endif %}" 
                        href="{% url 'delete_budget' project.id budget.id %}"                         
                        role="button" title="Delete Budget" 
                        data-bs-toggle="tooltip" 
                        data-bs-placement="bottom" 
                        data-bs-custom-class="custom-tooltip" 
                        data-delete-action data-bs-title="Delete">
                          <i class="bi bi-trash" style="font-size: 15px;"></i>
                      </a>
            
                    </div>
                  </td>
                </tr>
                {% endif %}
            {% empty %}
              <tr>
                <td colspan="5">No proposals found for this project.</td>
              </tr>
            {% endfor %}
            
            
            </tbody>
          </table>
        </div>
      </div>
    <!-- Project proposal -->
    <div class="col-md-12 mt-4">
      <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
        <div class="card-header d-flex justify-content-between p-3 border-bottom bg-gray">
          <h1 class="card-header fs-4 rounded-4">Proposals</h1>
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Proposal ID</th>
                <th>Budget ID</th>
                <th>Date</th>
                <th>Due Date</th>
                <th>Tracking ID</th>
                <th>Create by</th>
                <th>Status</th>
                <th>Amount</th>
                <th>Billed</th>
              </tr>
            </thead>
            <tbody>
              {% for proposal in proposals %}
              <tr style="vertical-align: middle;">
                <td>{{ proposal.id }}</td>
                <td>{{ proposal.budget.id }}</td>
                <td>{{ proposal.date_created | date:'M/d/y' }}</td>
                <td>{{ proposal.due_date | date:'M/d/y' }}</td>
                <td>{{ proposal.tracking_id }}</td>
                <td>{{ proposal.sales_advisor.username }}</td>
                <td class="d-flex"> 
                  <form method="post" class='m-0'>
                    {% csrf_token %}
                    <input type="hidden" name="proposal_id" value="{{ proposal.id }}" style='display:none'>
                    <input type="hidden" name="budget_id" value="{{ proposal.budget.id }}" style='display:none'>
                    <select name="status" class="status status-{{ proposal.status }}" onchange="this.form.submit()">
                      {% for value, label in proposal.STATUS_CHOICES %}
                        <option value="{{ value }}" {% if proposal.status == value %}selected{% endif %}>
                          {{ label }}
                        </option>
                      {% endfor %}
                    </select>
                  </form>
                  {% if proposal.status == 'new' %}
                      <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="The proposal is new. You cannot create an invoice for it." 
                          aria-label="Info" data-bs-original-title="New Proposal">
                          <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                      </a>
                  {% elif proposal.status == 'sent' %}
                      <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="The proposal has been sent. It cannot be deleted or have an invoice created." 
                          aria-label="Info" data-bs-original-title="Sent Proposal">
                          <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                      </a>
                  {% elif proposal.status == 'pending' %}
                      <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="The proposal is pending. It cannot be deleted or have an invoice created." 
                          aria-label="Info" data-bs-original-title="Pending Proposal">
                          <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                      </a>
                  {% elif proposal.status == 'approved' %}
                      <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="The proposal is approved. It cannot be deleted, but you can create an invoice for it." 
                          aria-label="Info" data-bs-original-title="Approved Proposal">
                          <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                      </a>
                  {% elif proposal.status == 'rejected' %}
                      <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="The proposal has been rejected. It can be deleted, but you cannot create an invoice for it." 
                          aria-label="Info" data-bs-original-title="Rejected Proposal">
                          <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                      </a>
                  {% endif %}
                </td>
                <td>{{ proposal.total_proposal | currency_usd }}</td>
                <td>{{ proposal.billed_proposal | currency_usd }}</td>
                <td style='width:120px' class="p-0">
                  <div class="d-inline-flex gap-2 align-items-center p-1">
                  <a class="btn bg-light border border-2 btn-sm rounded-2" 
                  href="{% url 'pdf_proposal' project_id=project.id proposal_id=proposal.id %}" target='_blank'
                  role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="View">
                  <i class="bi bi-eye-fill" style="font-size: 15px;"></i>
                  </a>
                  <a class="btn bg-light border border-2 btn-sm rounded-2" 
                  href="{% url 'edit_budgetSimple' project_id=project.id budget_id=proposal.budget.id proposal_id=proposal.id %}" target='_blank'
                  role="button" title="Edit Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Edit">
                  <i class="bi bi-pencil-square" style="font-size: 15px;"></i>
                  </a>
                  <div class="dropdown d-flex">
                    <button 
                      class="btn bg-light border border-2 btn-sm rounded-2 px-1 py-0 dropdown-toggle  {% if proposal.status == 'new' or proposal.status == 'sent' or proposal.status == 'pending'  or proposal.status == 'rejected' or  proposal.total_proposal <=  proposal.billed_proposal %}disabled{% endif %}" 
                      type="button" 
                      id="dropdownMenuButton" 
                      data-bs-toggle="dropdown" 
                      aria-expanded="false" 
                      title="Make Budget" 
                      data-bs-toggle="tooltip" 
                      data-bs-placement="bottom" 
                      data-bs-custom-class="custom-tooltip" 
                      data-bs-title="Make invoice">
                      <i class="bi bi-cash-stack" style="font-size: 15px;"
                      > </i>
                    </button class='p-0'>
                    <ul class="dropdown-menu p-0" aria-labelledby="dropdownMenuButton">
                      <li><a class="dropdown-item" href="{% url 'mdcpInvoice' project_id=project.id invoice_id=proposal.id %}" target='_blank'>Invoice MDCP</a></li>
                      <li><a class="dropdown-item" href="{% url 'broadInvoice10' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice BROD</a></li>
                      <li><a class="dropdown-item" href="{% url 'aiaInvoice5' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice AIA 5%</a></li>
                      <li><a class="dropdown-item" href="{% url 'aiaInvoice10' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice AIA 10%</a></li>
                    </ul>
                    {% if proposal.status == 'new' or proposal.status == 'sent' or proposal.status == 'pending'  or proposal.status == 'rejected' %}
                    <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                        data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                        data-bs-title="Invoice creation is disabled because the proposal is in Pending, New, Rejected, or Sent status." 
                        aria-label="Info" data-bs-original-title="Rejected Proposal">
                        <i class="bi bi-info-circle text-danger" style="font-size: 15px;"></i>
                    </a>
                    {% elif  proposal.total_proposal <=  proposal.billed_proposal %}
                    <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                        data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                        data-bs-title="You cannot add more invoices because the total of the proposal has already been invoiced." 
                        aria-label="Info" data-bs-original-title="Rejected Proposal">
                        <i class="bi bi-info-circle text-success" style="font-size: 15px;"></i>
                    </a>
                    
                    {% endif %}
                  </div>
                  
                  <a class="btn btn-danger btn-sm rounded-2 p-1 {% if proposal.status == 'approved' or proposal.status == 'sent' or proposal.status == 'pending' %}disabled{% endif %}" 
                    href="{% url 'delete_proposal' project.id proposal.id %}"
                    role="button" title="Delete Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="Delete">
                    <i class="bi bi-trash" style="font-size: 15px;"></i>
                  </a>
                  {% if proposal.status == 'approved' %}

                      <a class="btn btn-sm rounded-2 p-1 bg-warning" role="button" data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                          data-bs-title="Change order requested by the client after approval, modifying scope, cost, or timeline."
                          aria-label="Info" data-bs-original-title="Approved Proposal"
                          href="{% url 'new_change_order' project.id proposal.id %}">
                          ChangeOrder
                      </a>
                    {% endif %}
              </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="9">No proposals found for this project.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
        </div>
    
    </div>
      <!-- Change Order -->
      {% if changes_orders %}
      <div class="col-md-12 mt-4">
        <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
          <div class="card-header d-flex justify-content-between p-3 border-bottom bg-warning" style="--bs-bg-opacity: .2;">
            <h1 class="card-header fs-4 rounded-4 px-2"  style="--bs-bg-opacity: .1;">Change Order</h1>
          </div>
          <div class="card-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Budget ID</th>
                  <th>Date</th>
                  <th>Create by</th>
                  <th>Last value</th>
                  <th>New value</th>
                  <th>Total Change</th>
                </tr>
              </thead>
              <tbody>
                {% for budget in changes_orders %}
                <tr style="vertical-align: middle;">
                  <td>{{ budget.id_related_budget_id }}</td>
                  <td>{{ budget.date_created | date:'M/d/y' }}</td>
                  <td>{{ budget.sales_advisor.username }}</td>
                  <td>{{ budget.id_related_total_value | currency_usd}}</td>
                  <td>{{ budget.total_value | currency_usd}}</td>
                  <td>
                    <span class="status title_budget{% if budget.total_change_order < 0 %}Down{% else %}Up{% endif %}">
                      <i class="bi bi-graph-{% if budget.total_change_order < 0 %}down{% else %}up{% endif %}-arrow fs-6"></i>
                        {{ budget.total_change_order | currency_usd}}
                    <span>
                  </td>
                  <td style="width:80px">
                    <div class="d-inline-flex gap-2 align-items-center p-0">
                      <a class="btn bg-light border border-2 btn-sm rounded-2 p-1" 
                      href="{% url 'view_changeOrder' project.id budget.id %}" 
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="View">
                      <i class="bi bi-eye-fill" style="font-size: 15px;"></i>
                      </a>
                      <a class="btn bg-light border border-2 btn-sm rounded-2 p-1" 
                      href="{% url 'edit_budget' project.id budget.id %}" 
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Edit Budget">
                      <i class="bi bi-pencil-square" style="font-size: 15px;"></i>
                      </a>
                      <a class="btn bg-light border border-2 btn-sm rounded-2 p-1" 
                      href="{% url 'view_budget' project.id budget.id %}"
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Print">
                      <i class="bi bi-printer-fill" style="font-size: 15px;"></i>
                      </a>
                      <a class="btn btn-danger btn-sm rounded-2"
                        href="{% url 'delete_budget' project.id budget.id %}"                         
                        role="button" title="Delete Budget" 
                        data-bs-toggle="tooltip" 
                        data-bs-placement="bottom" 
                        data-bs-custom-class="custom-tooltip" 
                        data-delete-action data-bs-title="Delete">
                          <i class="bi bi-trash" style="font-size: 15px;"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="8">No changes orders  found for this project.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
          </div>
      </div>    
      {% endif %}
      
      <!-- Change Order Proposals -->
      {% if change_order_proposals %}
        <div class="col-md-12 mt-4">
          <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
            <div class="card-header d-flex justify-content-between p-3 border-bottom bg-dark">
              <h1 class="card-header fs-4 rounded-4 px-2">Change Order Proposals</h1>
            </div>
            <div class="card-body">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Proposal ID</th>
                    <th>Budget ID</th>
                    <th>Date</th>
                    <th>Due Date</th>
                    <th>Tracking ID</th>
                    <th>Create by</th>
                    <th>Status</th>
                    <th>Amount</th>
                    <th>Billed</th>
                  </tr>
                </thead>
                <tbody>
                  {% for proposal in change_order_proposals %}
                  <tr style="vertical-align: middle;">
                    <td>{{ proposal.id }}</td>
                    <td>{{ proposal.budget.id }}</td>
                    <td>{{ proposal.date_created | date:'M/d/y' }}</td>
                    <td>{{ proposal.due_date | date:'M/d/y' }}</td>
                    <td>{{ proposal.tracking_id }}</td>
                    <td>{{ proposal.sales_advisor.username }}</td>
                    <td class="d-flex"> 
                      <form method="post" class='m-0'>
                        {% csrf_token %}
                        <input type="hidden" name="proposal_id" value="{{ proposal.id }}" style='display:none'>
                        <input type="hidden" name="budget_id" value="{{ proposal.budget.id }}" style='display:none'>
                        <select name="status" class="status status-{{ proposal.status }}" onchange="this.form.submit()">
                          {% for value, label in proposal.STATUS_CHOICES %}
                            <option value="{{ value }}" {% if proposal.status == value %}selected{% endif %}>
                              {{ label }}
                            </option>
                          {% endfor %}
                        </select>
                      </form>
                      {% if proposal.status == 'new' %}
                          <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="The proposal is new. You cannot create an invoice for it." 
                              aria-label="Info" data-bs-original-title="New Proposal">
                              <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                          </a>
                      {% elif proposal.status == 'sent' %}
                          <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="The proposal has been sent. It cannot be deleted or have an invoice created." 
                              aria-label="Info" data-bs-original-title="Sent Proposal">
                              <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                          </a>
                      {% elif proposal.status == 'pending' %}
                          <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="The proposal is pending. It cannot be deleted or have an invoice created." 
                              aria-label="Info" data-bs-original-title="Pending Proposal">
                              <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                          </a>
                      {% elif proposal.status == 'approved' %}
                          <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="The proposal is approved. It cannot be deleted, but you can create an invoice for it." 
                              aria-label="Info" data-bs-original-title="Approved Proposal">
                              <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                          </a>
                      {% elif proposal.status == 'rejected' %}
                          <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="The proposal has been rejected. It can be deleted, but you cannot create an invoice for it." 
                              aria-label="Info" data-bs-original-title="Rejected Proposal">
                              <i class="bi bi-info-circle" style="font-size: 15px;"></i>
                          </a>
                      {% endif %}
                    </td>
                    <td>{{ proposal.total_proposal | currency_usd }}</td>
                    <td>{{ proposal.billed_proposal | currency_usd }}</td>
                    <td style='width:120px' class="p-0">
                      <div class="d-inline-flex gap-2 align-items-center p-1">
                      <a class="btn bg-light border border-2 btn-sm rounded-2" 
                      href="{% url 'pdf_proposal' project_id=project.id proposal_id=proposal.id %}" target='_blank'
                      role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="View">
                      <i class="bi bi-eye-fill" style="font-size: 15px;"></i>
                      </a>
                      <div class="dropdown d-flex">
                        <button 
                          class="btn bg-light border border-2 btn-sm rounded-2 px-1 py-0 dropdown-toggle  {% if proposal.status == 'new' or proposal.status == 'sent' or proposal.status == 'pending'  or proposal.status == 'rejected' or  proposal.total_proposal <=  proposal.billed_proposal %}disabled{% endif %}" 
                          type="button" 
                          id="dropdownMenuButton" 
                          data-bs-toggle="dropdown" 
                          aria-expanded="false" 
                          title="Make Budget" 
                          data-bs-toggle="tooltip" 
                          data-bs-placement="bottom" 
                          data-bs-custom-class="custom-tooltip" 
                          data-bs-title="Make Proposal">
                          <i class="bi bi-cash-stack" style="font-size: 15px;"
                          > </i>
                        </button class='p-0'>
                        <ul class="dropdown-menu p-0" aria-labelledby="dropdownMenuButton">
                          <li><a class="dropdown-item" href="{% url 'mdcpInvoice' project_id=project.id invoice_id=proposal.id %}" target='_blank'>Invoice MDCP</a></li>
                          <li><a class="dropdown-item" href="{% url 'broadInvoice10' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice BROD</a></li>
                          <li><a class="dropdown-item" href="{% url 'aiaInvoice5' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice AIA 5%</a></li>
                          <li><a class="dropdown-item" href="{% url 'aiaInvoice10' project_id=project.id invoice_id=proposal.id %}"  target='_blank'>Invoice AIA 10%</a></li>
                        </ul>
                        {% if proposal.status == 'new' or proposal.status == 'sent' or proposal.status == 'pending'  or proposal.status == 'rejected' %}
                        <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                            data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                            data-bs-title="Invoice creation is disabled because the proposal is in Pending, New, Rejected, or Sent status." 
                            aria-label="Info" data-bs-original-title="Rejected Proposal">
                            <i class="bi bi-info-circle text-danger" style="font-size: 15px;"></i>
                        </a>
                        {% elif  proposal.total_proposal <=  proposal.billed_proposal %}
                        <a class="btn btn-sm rounded-2 p-1" role="button" data-bs-toggle="tooltip" 
                            data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                            data-bs-title="You cannot add more invoices because the total of the proposal has already been invoiced." 
                            aria-label="Info" data-bs-original-title="Rejected Proposal">
                            <i class="bi bi-info-circle text-success" style="font-size: 15px;"></i>
                        </a>
                        
                        {% endif %}
                      </div>
                      
                      <a class="btn btn-danger btn-sm rounded-2 p-1 {% if proposal.status == 'approved' or proposal.status == 'sent' or proposal.status == 'pending' %}disabled{% endif %}" 
                        href="{% url 'delete_proposal' project.id proposal.id %}"
                        role="button" title="Delete Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="Delete">
                        <i class="bi bi-trash" style="font-size: 15px;"></i>
                      </a>
                      {% if proposal.status == 'approved' %}

                          <a class="btn btn-sm rounded-2 p-1 bg-warning" role="button" data-bs-toggle="tooltip" 
                              data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" 
                              data-bs-title="Change order requested by the client after approval, modifying scope, cost, or timeline."
                              aria-label="Info" data-bs-original-title="Approved Proposal"
                              href="{% url 'new_change_order' project.id proposal.id %}">
                              ChangeOrder
                          </a>
                        {% endif %}
                  </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="9">No proposals found for this project.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Project Invoices -->
      <div class="col-md-12 mt-4">
        <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm">
          <div class="card-header d-flex justify-content-between p-3 border-bottom bg-gray">
            <h1 class="card-header fs-4 rounded-4">Invoice</h1>
          </div>
          <div class="card-body">
            <table class="table table-striped bgwarning">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Budget ID</th>
                  <th>Type</th>
                  <th>Date</th>
                  <th>Due Date</th> 
                  <th>Create by</th>
                  <th>Status</th>
                  <th>Amount</th>
                  <th>Paid</th>
                </tr>
              </thead>
              <tbody>
                {% for invoice in invoices %}
                <tr>
                  <td>{{ invoice.id }}</td>
                  <td>{{ invoice.budget.id }}</td>
                  <td>{{ invoice.type_invoice }}</td>
                  <td>{{ invoice.date_created | date:'M/d/y' }}</td>
                  <td>{{ invoice.due_date | date:'M/d/y' }}</td>
                  <td>{{ invoice.sales_advisor.username }}</td>
                  <td> 
                    <form method="post" class='m-0'>
                      {% csrf_token %}
                      <input type="hidden" name="invoice_id" value="{{ invoice.id }}" style='display:none'>
                    
                      <select name="status" class="status status-empty status_{{   invoice.status }}" onchange="this.form.submit()">
                        {% for value, label in invoice.STATUS_CHOICES %}
                          <option value="{{ value }}" {% if invoice.status == value %}selected{% endif %}>
                            {{ label }}
                          </option>
                        {% endfor %}
                      </select>
                    </form>
                  </td>
                  <td>{{ invoice.total_invoice | currency_usd }} ({{ invoice.percentage_of_proposal }}%)</td>
                  <td>
                    {{ invoice.total_paid | currency_usd }} ({{ invoice.percentage_paid }}%) 
                    {% if invoice.total_paid == 0 %}
                      <!-- Icono para agregar pago si total_paid es cero -->
                      <button class="btn btn-success btn-sm" onclick="openPaymentModal('{{ invoice.id }}', '{{invoice.total_paid}}', '{{invoice.total_invoice}}')" title="Attach Payment" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Attach payment">
                        <i class="bi bi-wallet"></i>
                      </button>
                    {% elif invoice.total_paid <  invoice.total_invoice %}
                      <button class="btn btn-primary btn-sm" onclick="openPaymentModal('{{ invoice.id }}', '{{invoice.total_paid}}', '{{invoice.total_invoice}}')" title="Edit Payment" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="Edit payment">
                        <i class="bi bi-pencil"></i>
                      </button>
                    {% endif %}
                  </td>
                  <td style='width:80px'>
                    <div class="d-inline-flex gap-2 ">
                    <a class="btn bg-light border border-2 btn-sm rounded-2 p-1" 
                    href="{% url 'pdf_invoice' project_id=project.id invoice_id=invoice.id %}" 
                    role="button" title="View Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-bs-title="View">
                    <i class="bi bi-eye-fill" style="font-size: 15px;"></i>
                  </a>
                    <a class="btn btn-danger btn-sm rounded-2 p-1" 
                      href="{% url 'delete_invoice' project.id invoice.id %}"
                      role="button" title="Delete Budget" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip" data-delete-action data-bs-title="Delete">
                      <i class="bi bi-trash" style="font-size: 15px;"></i>
                    </a>
                </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="9">No invoices found for this project.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
          </div>
    </div>
    <!-- Project Documentation -->
    <div class="col-md-12 mt-4 max-h-100">
      <div class="container border m-0 px-0 rounded-4 overflow-hidden shadow-sm position-relative">
        <div id="loadingOverlay-file"  class="position-absolute w-100 top-0 h-100 end-0" style="background-color: rgba(74, 64, 129, 0.26); z-index: 1000;" >
            <img src="{% static 'img/loading.gif' %}" alt="Cargando" class="img-fluid rounded-1 my-1" style="width: 60px; height: auto; margin-left: 95%;">
        </div>
        <div class="card-header d-flex align-items-center p-3 border-bottom bg-gray">
          <h1 class="card-header fs-4 rounded-4">Documents</h1>
          <span id="google-drive-link" class="text-white ms-2 bg-secondary rounded-2 p-1 px-2" style="cursor: pointer;">
            <a href="https://drive.google.com/drive/folders/{{ project.folder_id }}" class="text-decoration-none text-white" target="_blank">
              <i class="bi bi-google"></i> Google Drive
            </a>
          </span>
        </div>
        <div id="document-list" class="relative bg-light p-4" data-project-id="{{ project.id }}">
        </div>
        <form id="create-folder-form" class="d-flex my-2 justify-content-center" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="text" id="folder-name" class="me-2 rounded-2" placeholder="Folder Name" required>
          <button type="button" id="add-folder-btn" class="btn bg-primary text-light">
            <i class="bi bi-plus-circle text-light fs-6"></i> Add Folder
          </button>
        </form>
      </div>
    </div>
    <div id="modal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <button id="closeModal" class="btn-close"></button>
        <h2>Add Document</h2>
        <form id='file-drop'>
          <div class="file-drop-area">
            <span class="btn btn-primary">Choose files</span>
            <span class="file-message">or drag and drop files here</span>
            <input class="file-input" type="file" multiple>
          </div>
          <input type="hidden" id="folder-id" />
          <button type="submit" class="btn btn-success mt-3">Upload</button>
        </form>
      </div>
    </div> 
    </div>
    {% include "modal_delete.html" %}
<!-- Modal para Adjuntar Pago -->
<div class="modal fade" id="attachPaymentModal" tabindex="-1" aria-labelledby="attachPaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog p-1 d-flex justify-content-center">
    <div class="modal-content p-1">
      <div class="modal-header">
        <h5 class="modal-title" id="attachPaymentModalLabel">Attach Payment to Invoice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Formulario para adjuntar el pago -->
        <form id="paymentForm" enctype="multipart/form-data">
          <div class="row">
            <input type="hidden" id="csrf-token" data-csrf="{{ csrf_token }}">

            <div class="col-md-6 mb-3">
              <label for="paymentAmount" class="form-label">Amount*</label>
              <input type="number" class="form-control" id="paymentAmount" placeholder="Enter payment amount" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="paymentDate" class="form-label">Payment Date*</label>
              <input type="date" class="form-control" id="paymentDate" required>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirmPaymentBtn">Attach Payment</button>
      </div>
    </div>
  </div>
</div>
<div id="loadingOverlay"  class="containerLoading d-none" >
  <img src="{% static 'img/loading.gif' %}" alt="Cargando" class="img-fluid rounded-1" style="width: 100px; height: auto;">
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">

let folderIDS = {}

function loadFolder() {
  
  const projectName = document.getElementById("project-info").getAttribute("data-project-name");
  const formData = new FormData();
  const deleteButton = document.getElementById('button-delete-project');
  formData.append('project_name', projectName);
  const loadingOverlay = document.getElementById('loadingOverlay-file');
  fetch("{% url 'get_folders_in_drive' %}", {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Error en la solicitud');
    }
    return response.json();
    loadingOverlay.classList.add('d-none');
  })
  .then(data => {
    if (data.structure && data.structure.length > 0) {
      console.log(data);
      const folderHtml = renderFolderStructure(data.structure[0].children);
      document.getElementById("document-list").innerHTML = folderHtml;
      document.getElementById("document-list").setAttribute("data-folder-root", data.structure[0].id);
      deleteButton.disabled = false; 
    } else {
      document.getElementById("document-list").innerHTML = "<p class='text-muted'>No se encontraron documentos.</p>";
      deleteButton.disabled = false; 
    }
    loadingOverlay.classList.add('d-none');
  })
  .catch(error => {
    console.error("Error al cargar las carpetas:", error);
    document.getElementById("document-list").innerHTML = "<p class='text-danger'>Error al cargar los documentos.</p>";
    loadingOverlay.classList.add('d-none');
  });
}
function renderFolderStructure(folders, parentId = '') {
  folderIDS = {}
  let html = "<div class='d-flex flex-wrap position-relative'>";
  folders.forEach((folder, index) => {
    const folderId = parentId + '-' + index;
    const extension = folder.name.split('.').pop().toLowerCase();
    const restrictedNames = ['Evidence', 'Proposal', 'Documents', 'ChangeOrder', 'Invoices'];
    folderIDS[folder.name] = [folder.id]
    if (folder.type === 'folder') {
      // Estructura para carpetas con colapso
      html += `
      <div class="mx-2 my-0 bg-light" style="min-width: 50px; max-width: 350px">
        <div class="card-body my-0 p-0 folder-container">
          <h5 class="d-flex flex-column justify-content-start">
            <img class="folderSvg mb-0" alt="Folder Icon" src="{% static "img/folder-with-files-svgrepo-com.svg" %}"/>
            <button class="btn btn-link p-0 text-start" data-bs-toggle="collapse" data-bs-target="#collapse-${folderId}" aria-expanded="false" aria-controls="collapse-${folderId}">
              <span id="folder-name-${folder.id}" class='d-flex flex-row flex-nowrap'>
                ${folder.name}
              </span>
            </button>
            <div class="d-flex flex-row justify-content-start folder-action">

              <button class="btn btn-link p-0" onclick="openModal('${folder.id}')">
                <i class="bi bi-file-earmark-plus bg-success rounded-3 text-white p-1" style="font-size:12px"></i>
              </button>`

      if (!restrictedNames.includes(folder.name)) {
        html += `
          <button class="btn btn-link p-0" onclick="editFolderName('${folder.id}')">
            <i class="bi bi-pencil bg-secondary rounded-3 text-white p-1" style="font-size:12px"></i>
          </button>
          <button class="btn btn-link p-0" onclick="deleteObjet('${folder.id}')">
            <i class="bi bi-trash3-fill bg-danger rounded-3 text-white p-1" style="font-size:12px"></i>
          </button>`;
      }
    
              html += `
          </h5>
          <div id="collapse-${folderId}" class="collapse">
            <div class="card-text">
              ${folder.children?.length > 0 ? renderFilesTable(folder.children) : ""}
            </div>
          </div>
        </div>
      </div>`;
    }
  });
  html += "</div>";
  return html;
}

function renderFilesTable(files) {
  let html = `<table class="table table-transparent">
    <tbody>`;
      files.forEach(file => {
        if (file.type === 'file') {
            const extension = file.name.split('.').pop().toLowerCase();
            html += `
                <tr style='margin-bottom: 10px'>
                    <td class='py-0 py-1 '><i class="text-dark bg-secondary text-white m-0 p-1 fs-6 rounded-2 bi bi-filetype-${extension}"></i></td>
                    <td class="text-truncate py-0 bg-transparent" style="max-width: 250px;">
                        <a href="${file.url}" target="_blank" id='folder-name-${file.id}' class="text-decoration-none btn px-1 btn-info p-0 text-dark" data-bs-toggle="tooltip" title="${file.name}">
                            ${file.name}
                        </a>
                    </td>
                    <td class='py-0 bg-transparent'>
                        <button class="btn btn-link p-0" onclick="editFolderName('${file.id}')">
                            <i class="bi bi-pencil text-secondary" style="font-size:12px"></i>
                        </button>
                        <button class="btn btn-link p-0" onclick="deleteObjet('${file.id}')">
                            <i class="bi bi-trash3-fill text-danger" style="font-size:12px"></i>
                        </button>
                    </td>
                </tr>`;
        }
    });
    

  html += `</tbody></table>`;
  return html;
}
function openModal(folderId) {
  const modal = document.getElementById('modal');
  const folderIdInput = document.getElementById('folder-id');
  folderIdInput.value = folderId;
  modal.style.display = 'flex';
}


const closeModalButton = document.getElementById('closeModal');
closeModalButton.addEventListener('click', () => {
  const modal = document.getElementById('modal');
  modal.style.display = 'none';
});

window.addEventListener('click', (e) => {
  const modal = document.getElementById('modal');
  if (e.target === modal) {
    modal.style.display = 'none';
  }
});



document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("modal");
  const form = document.getElementById("file-drop");
  const loadingOverlay = document.getElementById('loadingOverlay');
  const fileInput = document.querySelector(".file-input");

  fileInput.addEventListener('onchange', () => {
    var filesCount = $(this)[0].files.length;
    var textbox = $(this).prev();
    if (filesCount === 1) {
      var fileName = $(this).val().split('\\').pop();
      textbox.text(fileName);
    } else {
      textbox.text(filesCount + ' files selected');
    }
  });
  
  form.addEventListener("submit", function (e) {
    loadingOverlay.classList.remove('d-none');
    e.preventDefault();
    const formData = new FormData();
    const fileInput = document.querySelector(".file-input");
    const folderIdInput = document.getElementById("folder-id");
    const projectId = $("#document-list").data("project-id");

    console.log(fileInput.files)
    
    
    if (fileInput.files.length > 0) {
        for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('file[]', fileInput.files[i]);
        }
    } else {
        showAlert("No se han seleccionado archivos.", 'warning');
        loadingOverlay.classList.add('d-none');
        return; 
    }
    console.log(formData)
    formData.append('folder_id', folderIdInput.value);

    fetch("{% url 'upload_file_to_drive' %}", {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
      }
    })
    .then(response => response.json())
    .then(data => {
      loadFolder();
      showAlert("Archivos subidos exitosamente.", 'success');
      const modal = document.getElementById('modal');
      modal.style.display = 'none';
      loadingOverlay.classList.add('d-none');
    })
    .catch(error => {
      showAlert("Error uploading file: " + error, 'warning');
      loadingOverlay.classList.add('d-none');
    });
  });
});

function deleteObjet(fileId) {
  if (!confirm("Are you sure you want to delete this file?")) {
    return;
  }
  const loadingOverlay = document.getElementById('loadingOverlay-file');
  loadingOverlay.classList.remove('d-none');
  showAlert('Borrando objeto...', 'info');
  fetch("{% url 'delete_file' %}", {
    method: 'POST',
    body: JSON.stringify({ file_id: fileId }),
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    }
  })
  .then(response => {

    if (response.ok) {
      return response.json();
    } else {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
  })
  .then(data => {
    loadFolder()
    showAlert(data.message, 'success');
  })
  .catch(error => {
    console.error('Error deleting file:', error);
    loadingOverlay.classList.add('d-none');
    showAlert(data.message, 'warning');
  });
}

document.addEventListener("DOMContentLoaded", function () {
  const folderNameInput = document.getElementById("folder-name");
  const addFolderBtn = document.getElementById("add-folder-btn");

  function toggleButtonState() {
    addFolderBtn.disabled = folderNameInput.value.trim() === "";
  }
  folderNameInput.addEventListener("input", toggleButtonState);
  toggleButtonState();
});

document.getElementById("add-folder-btn").addEventListener("click", function () {
  const folderRootValue = document.getElementById("document-list").getAttribute("data-folder-root");
  const folderName = document.getElementById("folder-name").value.trim(); // Obtener el nombre de la carpeta
  const alertContainer = document.getElementById('alert-container');
  alertContainer.innerHTML = '';

  if (!folderRootValue) {
    showAlert('No se encontr贸 un folder root v谩lido.', 'danger');
    return;
  }

  if (!folderName) {
    showAlert('Por favor, ingresa un nombre para la carpeta.', 'warning');
    return;
  }
  const creatingAlert = showAlert('Creando carpeta, por favor no cerrar...', 'info');
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const loadingOverlay = document.getElementById('loadingOverlay-file');
  loadingOverlay.classList.remove('d-none');
  fetch(`/projects/create-folder/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken,
    },
    body: JSON.stringify({
      folder_root: folderRootValue,
      folder_name: folderName
    }),
  })
  .then((response) => {
    if (response.ok) {
      return response.json();
    } else {
      throw new Error("Error al crear la carpeta");
    }
  })
  .then((data) => {
    console.log("Carpeta creada exitosamente:", data);
    creatingAlert.remove();
    loadFolder();
    showAlert('Se ha creado la carpeta', 'success');  
  })
  .catch((error) => {
    creatingAlert.remove();
    console.error("Error:", error);
    showAlert('No se pudo crear la carpeta.', 'danger');
    loadingOverlay.classList.add('d-none');
  });
});

$(document).ready(function () {
  const projectId = $("#document-list").data("project-id");
  if (projectId) {
    loadFolder(projectId);

  } else {
    $("#document-list").html("<p class='text-warning'>El proyecto no tiene un ID v谩lido. Contacte al administrador.</p>");
    const loadingOverlay = document.getElementById('loadingOverlay-file');
    loadingOverlay.classList.add('d-none');
  }
});

function editFolderName(folderId) {
  const folderElement = document.getElementById(`folder-name-${folderId}`);
  const originalName = folderElement.textContent.trim();

  // Crear un campo de texto para editar el nombre de la carpeta
  const inputField = document.createElement('input');
  inputField.type = 'text';
  inputField.value = originalName;
  inputField.className = 'border border-secondary w-auto py-0 m-0';
  inputField.style.maxWidth = '100px';
  inputField.style.maxHeight = '20px';
  if (folderElement.hasAttribute('href')) {
    folderElement.removeAttribute('href');
}

  // Crear un bot贸n de "check" para confirmar el cambio
  const checkButton = document.createElement('button');
  checkButton.textContent = ''; 
  checkButton.setAttribute('id', 'buttonCheckName');

  // Limpiar el contenido del folderElement y agregar el input y el checkButton
  folderElement.innerHTML = '';
  folderElement.appendChild(inputField);
  folderElement.appendChild(checkButton);

  // Seleccionar el texto dentro del campo de texto para facilitar la edici贸n
  inputField.select();

  // Al hacer clic en el check, actualizamos el nombre de la carpeta
  checkButton.addEventListener('click', function() {
    const newName = inputField.value;
    updateFolderName(folderId, newName);
  });

  // Si el campo de texto pierde el foco, tambi茅n actualizamos el nombre
  inputField.addEventListener('blur', function() {
    const newName = inputField.value;
    updateFolderName(folderId, newName);
  });


}
document.getElementById('button-delete-project').addEventListener('click', function() {
    const userConfirmed = window.confirm('Are you sure you want to delete this project?');

    if (userConfirmed) {

      const projectId = this.getAttribute('data-id');
      const folderRootValue = document.getElementById("document-list").getAttribute("data-folder-root");
      let url = `/projects/${projectId}/delete_project/`;  // URL base
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.classList.remove('d-none');
      if (folderRootValue) {
        url += folderRootValue;
      }
      fetch(url, {
        method: 'GET', 
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (response.ok) {
          alert('Proyecto eliminado correctamente');
          window.location.href = '/projects/';
        } else {
          alert('Error al eliminar el proyecto');
          loadingOverlay.classList.add('d-none');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Hubo un problema con la eliminaci贸n del proyecto');  
        loadingOverlay.classList.add('d-none');
      });}
    });

function updateFolderName(folderId, newFolderName) {
  const formData = new FormData();
  formData.append('folder_id', folderId);
  formData.append('new_folder_name', newFolderName);
  const folderElement = document.getElementById(`folder-name-${folderId}`);
  const spinner = document.createElement('div');
  spinner.className = 'spinner-border spinner-border-sm text-primary'; // Puedes elegir otro color
  spinner.setAttribute('role', 'status');
  const spinnerText = document.createElement('span');
  spinnerText.className = 'visually-hidden';
  spinnerText.textContent = 'Loading...'; 
  spinner.appendChild(spinnerText);
  folderElement.innerHTML = '';
  folderElement.appendChild(spinner);
  const loadingOverlay = document.getElementById('loadingOverlay-file');
  loadingOverlay.classList.remove('d-none');
  fetch("{% url 'rename_folder_in_drive' %}", {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.message === 'Folder renamed successfully') {
      showAlert("Folder renamed successfully.", 'success');
      loadFolder()
    } else {
      showAlert("Error renaming folder", 'warning');
      loadFolder()
    }
  })
  .catch(error => {
    console.error('Error:', error);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const deleteButtons = document.querySelectorAll('[data-delete-action]');
  
  deleteButtons.forEach(button => {
      button.addEventListener('click', function(event) {
          event.preventDefault();
          const deleteUrl = button.getAttribute('href');
          // Mostrar el modal de confirmaci贸n
          const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
          modal.show();
          const confirmDeleteButton = document.getElementById('confirmDeleteBtn');
          confirmDeleteButton.onclick = function() {
              console.log('click')
              window.location.href = deleteUrl;
          };
      });
  });
});

document.addEventListener('DOMContentLoaded', function() {
  window.openPaymentModal = function(invoiceId, paidTotal, invoiceTotal) {
      const modal = new bootstrap.Modal(document.getElementById('attachPaymentModal'));
      const loadingOverlay = document.getElementById('loadingOverlay');
      const csrfToken = document.getElementById('csrf-token').dataset.csrf;
      
      modal.show();
      const amount = document.getElementById('paymentAmount');
      amount.value = paidTotal
      amount.setAttribute('max', invoiceTotal);
      amount.addEventListener('input', function() {
        const maxAmount = parseFloat(amount.getAttribute('max'));
        if (parseFloat(amount.value) > maxAmount) {
          amount.value = maxAmount; 
        }
      });
      const confirmPaymentButton = document.getElementById('confirmPaymentBtn');
      confirmPaymentButton.onclick = function() {
          const amount = document.getElementById('paymentAmount').value;
          const date = document.getElementById('paymentDate').value;
          
          loadingOverlay.classList.remove('d-none');
          
          fetch(`/projects/{{project.id}}/changePaidInvoice/${invoiceId}`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrfToken,  // Aseg煤rate de definir csrfToken en tu plantilla
              },
              body: JSON.stringify({
                  amount: amount,
                  date: date,
              }),
          })
          .then(jsonData => {
              console.log('Respuesta del servidor:', jsonData);
              window.location.href = `/projects/{{project.id}}/`;  // Redirigir al proyecto
              loadingOverlay.classList.add('d-none');
          })
          .catch(error => {
              console.error('Error al enviar los datos:', error);
              loadingOverlay.classList.add('d-none');
          });
      };
  };
});

document.getElementById("sendToProductionBtn").addEventListener("click", function() {
  var selectElement = document.getElementById("selectManager");
  console.log(selectElement)
  if (selectElement.style.display === "none" || selectElement.offsetHeight === 0) {
    alert("Please select a manager before sending to production.");
    return;
  }
  
  var selectedPersonId = selectElement.value;

  if (selectedPersonId) {
    window.location.href = "{% url 'select_manager' project.id %}?manager_id=" + encodeURIComponent(selectedPersonId);
  } else {
    alert("Please select a manager before sending to production.");
  }
});

function showSelectProject() {
  const selectProject = document.getElementById('selectProject');
  selectProject.classList.toggle('d-none');
  ajaxGetRequest(`/get_projects/`, function (data) {
    console.log(data);

    const projectSelect = document.getElementById('projectSelect');
    if (typeof data === 'object' && data !== null) {
      let projectOptions = '';

      // Iterar sobre los estados y proyectos
      for (const [status, projects] of Object.entries(data)) {
        // Crear un grupo de opciones para cada estado
        const groupOptions = projects.map(project => {
          const sanitizedProjectName = project.project_name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          return `<option value="${project.id}">${sanitizedProjectName}</option>`;
        }).join('');

        // Agregar el grupo al select
        projectOptions += `<optgroup label="${status}">${groupOptions}</optgroup>`;
      }

      // Poblar el elemento select, incluyendo un placeholder
      projectSelect.innerHTML = `<option value="" disabled selected>Select a project</option>${projectOptions}`;
    } else {
      // Manejar el caso cuando no hay proyectos disponibles
      projectSelect.innerHTML = `<option value="" disabled>No projects available</option>`;
    }

    const spinner_project = document.getElementById('spinner_project');
    spinner_project.classList.add('d-none');
  });
}


function showSelectCustomerProject() {
  const selectCustomerProject = document.getElementById('selectCustomerProject');
  selectCustomerProject.classList.toggle('d-none');
}

function sendBudgetDuplicate(budgetId ) {
  const selectProject = document.getElementById('projectSelect');
  const projectId = selectProject.value;
  if (projectId === null || projectId === '') {
    showAlert('Please select a project before duplicating the budget.', 'danger');
    return;
  }
  const container = document.getElementById('selectProject');
  const duplicateProjectButton = document.getElementById('duplicateBudgetButton');
  const cancelBudgetDuplicate = document.getElementById('cancelBudgetDuplicateButton');
  duplicateProjectButton.disabled = true;
  duplicateProjectButton.classList.add('bg-secondary');
  duplicateProjectButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Duplicating... ';
  cancelBudgetDuplicate.disabled = true;
  ajaxPostRequest(`/create_copy_budget/${budgetId}/${projectId}/`, {
  }, '{{ csrf_token }}', function(data) {
    if (data.status === 'success') {
      duplicateProjectButton.disabled = false;
      duplicateProjectButton.classList.remove('bg-secondary');
      duplicateProjectButton.innerHTML = 'Duplicate';
      cancelBudgetDuplicate.disabled = false;
      selectProject.value = '';
      container.classList.add('d-none');
      showAlert('Budget duplicated successfully.', 'success');
      window.open(data.redirect, '_blank');
    } else {
      showAlert('Error duplicating budget.', 'danger');
      duplicateProjectButton.disabled = false;
      cancelBudgetDuplicate.disabled = false;
      duplicateProjectButton.classList.remove('bg-secondary');
      duplicateProjectButton.innerHTML = 'Duplicate';
    }
  }, function(error) {
    console.log(error)
    container.classList.add('d-none');
    showAlert('Error duplicating budget.', 'danger');
    duplicateProjectButton.disabled = false;
    duplicateProjectButton.classList.remove('bg-secondary');
    duplicateProjectButton.innerHTML = 'Duplicate';
  });
}

function sendProjectDuplicate() {
  console.log('sendProjectDuplicate')
  const selectCustomerProject = document.getElementById('selectCustomerProject');
  selectCustomerProject.classList.toggle('d-none');
  const customerId = document.getElementById('id_customer').value;
  const duplicateProjectButton = document.getElementById('duplicateProjectButton');
  duplicateProjectButton.disabled = true;
  duplicateProjectButton.classList.add('bg-secondary');
  if (customerId) {
    duplicateProjectButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Duplicating... ';
    ajaxPostRequest(`/duplicate_project/{{project.id}}/${customerId}/`, {
    }, '{{ csrf_token }}', function(data) {
      console.log(data)
      duplicateProjectButton.disabled = false;
      duplicateProjectButton.classList.remove('bg-secondary');
      duplicateProjectButton.innerHTML = 'Duplicate';
      window.open(data.redirect, '_blank');

    });
  } else {
    alert('Please select a customer before duplicating the project.');
  }
}

function cancelBudgetDuplicate() {
  const container = document.getElementById('selectProject');
  container.classList.add('d-none');
}

</script>
{% endblock %}
