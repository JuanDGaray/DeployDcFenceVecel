{% extends 'base.html' %}

{% block title %}Email Tracking Statistics{% endblock %}

{% block content %}
<div class="d-flex flex-column min-vh-100 m-0 justify-content-start p-3 col-md-10 m-auto" >
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title fw-bold">Email Tracking Statistics</h4>
                </div>
                <div class="card-body">
                    <!-- Estadísticas generales -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary bg-opacity-10 border-primary border-4 border-opacity-10 text-primary">
                                <div class="card-body">
                                    <h5 class="card-title border-bottom border-primary border-4 border-opacity-10 fw-bold">Total Emails</h5>
                                    <h3 id="total-emails" class="text-end fw-bold">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success bg-opacity-10 border-success border-4 border-opacity-10 text-success">
                                <div class="card-body">
                                    <h5 class="card-title border-bottom border-success border-4 border-opacity-10 fw-bold">Opened Emails</h5>
                                    <h3 id="opened-emails" class="text-end fw-bold">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info bg-opacity-10 border-info border-4 border-opacity-10 text-info">
                                <div class="card-body">
                                    <h5 class="card-title border-bottom border-info border-4 border-opacity-10 fw-bold">Open Rate</h5>
                                    <h3 id="open-rate" class="text-end fw-bold">0%</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning bg-opacity-10 border-warning border-4 border-opacity-10 text-dark">
                                <div class="card-body">
                                    <h5 class="card-title border-bottom border-warning border-4 border-opacity-10 fw-bold">Days Back</h5>
                                    <h3 id="days-back" class="text-end fw-bold">30</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estadísticas por tipo -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>Statistics by Email Type</h5>
                            <div class="table-responsive">
                                <table class="table table-striped" id="stats-table">
                                    <thead>
                                        <tr>
                                            <th>Email Type</th>
                                            <th>Total Sent</th>
                                            <th>Opened</th>
                                            <th>Open Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Emails recientes -->
                    <div class="row">
                        <div class="col-12">
                            <h5>Recent Emails</h5>
                            <div class="table-responsive">
                                <table class="table table-striped" id="recent-emails-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Recipient</th>
                                            <th>Subject</th>
                                            <th>Project</th>
                                            <th>Status</th>
                                            <th>Opened Count</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadEmailTrackingStats();
});

function loadEmailTrackingStats() {
    fetch('/email_tracking_stats/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            updateStats(data.stats);
            updateRecentEmails(data.recent_emails);
        } else {
            console.error('Error loading stats:', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function updateStats(stats) {
    document.getElementById('total-emails').textContent = stats.total_emails;
    document.getElementById('opened-emails').textContent = stats.opened_emails;
    document.getElementById('open-rate').textContent = stats.open_rate + '%';
    document.getElementById('days-back').textContent = stats.days_back;

    // Actualizar tabla de estadísticas por tipo
    const statsTable = document.getElementById('stats-table').getElementsByTagName('tbody')[0];
    statsTable.innerHTML = '';

    Object.entries(stats.stats_by_type).forEach(([type, typeStats]) => {
        const row = statsTable.insertRow();
        row.innerHTML = `
            <td>${type.charAt(0).toUpperCase() + type.slice(1)}</td>
            <td>${typeStats.total}</td>
            <td>${typeStats.opened}</td>
            <td>${typeStats.rate}%</td>
        `;
    });
}

function updateRecentEmails(emails) {
    const table = document.getElementById('recent-emails-table').getElementsByTagName('tbody')[0];
    table.innerHTML = '';

    emails.forEach(email => {
        const row = table.insertRow();
        const statusBadge = email.is_opened ? 
            '<span class="badge bg-success bg-opacity-10 text-success">Opened</span>' : 
            '<span class="badge bg-secondary bg-opacity-10 text-secondary">Not Opened</span>';
        
        row.innerHTML = `
            <td>${email.sent_at}</td>
            <td>${email.email_type}</td>
            <td>${email.recipient_email}</td>
            <td>${email.subject}</td>
            <td>${email.project_name || 'N/A'}</td>
            <td>${statusBadge}</td>
            <td>${email.opened_count}</td>
        `;
    });
}
</script>
{% endblock %} 